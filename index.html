<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Burnett Customs - Metal Building Estimator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    /* ==================== BRAND COLORS ====================
       Primary:   Dark Azure #003057, Vivid Azure #05c3de
       Secondary: Bright Cyan #04ceea
       Background: White page, Dark cards
    ========================================================= */
    :root {
      --primary-dark: #003057;
      --primary-vivid: #05c3de;
      --primary-bright: #04ceea;
      --accent-green: #22c55e;
      --secondary-darkest: #01315b;
      --bg-page: #ffffff;
      --bg-card: #003057;
      --text-on-card: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-page);
    }

    .signature-pad {
      border: 2px dashed #9ca3af;
      border-radius: 8px;
      background: var(--bg-white);
      touch-action: none;
      cursor: crosshair;
    }
    .signature-pad.signed { border-color: var(--primary-vivid); border-style: solid; }

    .initials-pad {
      border: 2px dashed #9ca3af;
      border-radius: 8px;
      background: var(--bg-white);
      touch-action: none;
      cursor: crosshair;
      display: block;
      width: 100%;
      max-width: 200px;
      height: 70px;
    }
    .initials-pad.signed { border-color: var(--primary-vivid); border-style: solid; }

    .initials-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: #f0f9ff;
      border-radius: 8px;
      margin-top: 8px;
    }

    @media (max-width: 640px) {
      .initials-pad {
        max-width: 100%;
        height: 80px;
      }
      .initials-container {
        padding: 20px 16px;
      }
    }

    .progress-step {
      width: 28px; height: 28px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 11px;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .progress-step.completed { background: var(--primary-vivid); color: var(--bg-white); }
    .progress-step.current { background: var(--primary-dark); color: var(--bg-white); transform: scale(1.1); }
    .progress-step.pending { background: #e5e7eb; color: #9ca3af; }

    .contract-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .legal-text {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .section-ack {
      background: #e0f7fa;
      border: 2px solid var(--primary-vivid);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .section-ack.complete {
      background: #e0f7fa;
      border-color: var(--primary-dark);
    }

    .btn-primary {
      background: var(--primary-dark);
      color: var(--bg-white);
      transition: background 0.2s;
    }
    .btn-primary:hover { background: var(--secondary-darkest); }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }

    .btn-secondary {
      background: var(--primary-vivid);
      color: var(--primary-dark);
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: #04b5cc; }

    .btn-active {
      background: var(--primary-bright);
      color: var(--primary-dark);
      font-weight: 700;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(4, 206, 234, 0.4);
    }
    .btn-active:hover { background: #03b8d4; transform: translateY(-1px); }

    .header-bar {
      background: var(--primary-bright);
      color: var(--primary-dark);
    }

    .type-card {
      background: var(--bg-card);
      color: var(--text-on-card);
      border: 3px solid var(--primary-vivid);
      transition: all 0.2s;
      cursor: pointer;
    }
    .type-card:hover {
      background: var(--primary-bright);
      color: #003057 !important;
      border-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(4, 206, 234, 0.4);
    }
    .type-card:hover * { color: #003057 !important; }
    .type-card.selected {
      border: 4px solid #00ffff;
      background: var(--secondary-darkest);
      color: var(--text-on-card);
      box-shadow: 0 0 15px rgba(4, 206, 234, 0.8), 0 0 30px rgba(4, 206, 234, 0.5), 0 0 45px rgba(4, 206, 234, 0.3), inset 0 0 20px rgba(4, 206, 234, 0.1);
      transform: scale(1.02);
    }
    .type-card.selected * { color: #ffffff !important; }
    .type-card.selected h3, .type-card.selected .text-\\[\\#05c3de\\] { color: #05c3de !important; }

    .size-card {
      background: var(--bg-card);
      color: var(--text-on-card);
      border: 2px solid var(--primary-vivid);
      transition: all 0.2s;
      cursor: pointer;
    }
    .size-card:hover {
      background: var(--primary-bright);
      color: #003057 !important;
      border-color: var(--primary-dark);
      box-shadow: 0 4px 15px rgba(4, 206, 234, 0.4);
    }
    .size-card:hover * { color: #003057 !important; }
    .size-card.selected {
      border: 4px solid #00ffff;
      background: var(--secondary-darkest);
      color: var(--text-on-card);
      box-shadow: 0 0 12px rgba(4, 206, 234, 0.8), 0 0 25px rgba(4, 206, 234, 0.5), 0 0 40px rgba(4, 206, 234, 0.3), inset 0 0 15px rgba(4, 206, 234, 0.1);
      transform: scale(1.03);
    }
    .size-card.selected * { color: #ffffff !important; }
    .size-card.selected .text-\\[\\#05c3de\\] { color: #05c3de !important; }

    .eave-btn {
      background: var(--bg-card);
      color: var(--text-on-card);
      border: 2px solid var(--primary-vivid);
      transition: all 0.2s;
    }
    .eave-btn:hover {
      background: var(--primary-bright);
      color: #003057 !important;
      border-color: var(--primary-dark);
    }
    .eave-btn:hover * { color: #003057 !important; }
    .eave-btn.selected {
      border: 3px solid #00ffff;
      background: var(--primary-bright);
      color: #003057 !important;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(4, 206, 234, 0.8), 0 0 20px rgba(4, 206, 234, 0.5);
    }
    .eave-btn.selected * { color: #003057 !important; }

    @media print {
      body { font-size: 9pt; line-height: 1.3; }
      .no-print { display: none !important; }
      .signature-pad, .initials-pad { border: 1px solid var(--bg-black) !important; }
    }

    /* Print contract styles */
    .print-contract-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #1f2937;
    }
    .print-header {
      text-align: center;
      border-bottom: 3px solid #003057;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .print-header h1 {
      font-size: 28px;
      color: #003057;
      margin: 0 0 10px 0;
    }
    .print-header p {
      font-size: 14px;
      color: #6b7280;
      margin: 5px 0;
    }
    .print-section {
      page-break-inside: avoid;
      margin-bottom: 25px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
    }
    .print-section h3 {
      font-size: 16px;
      color: #003057;
      border-bottom: 2px solid #05c3de;
      padding-bottom: 8px;
      margin: 0 0 15px 0;
    }
    .print-section p, .print-section li {
      font-size: 11px;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .print-initials-box {
      display: inline-block;
      border: 1px solid #000;
      width: 80px;
      height: 30px;
      margin-left: 10px;
      vertical-align: middle;
    }
    .print-signature-section {
      page-break-before: always;
      margin-top: 40px;
    }
    .print-signature-box {
      border: 1px solid #000;
      height: 60px;
      margin: 10px 0;
    }
    .print-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    .print-summary-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
    }
    .print-summary-table td:first-child {
      font-weight: 600;
      width: 40%;
    }
    .print-ack-line {
      font-size: 10px;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #9ca3af;
    }
  </style>
</head>
<body class="bg-white min-h-screen">
  <div id="app"></div>

  <script>
    // ==================== EMAILJS CONFIG ====================
    const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
    const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
    const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

    if (EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
      emailjs.init(EMAILJS_PUBLIC_KEY);
    }

    // ==================== APP STATE ====================
    const state = {
      // Estimator flow
      step: 0, // 0=type, 1=size, 2=eave, 3=doors, 4=addons, 5=summary, 6+=contract

      // Multiple buildings support
      buildings: [],  // Array of building configs
      currentBuildingIndex: 0,  // Which building we're editing

      // Current building being configured (will be pushed to buildings array)
      buildingType: null, // 'poleBarn', 'carport', 'boltUp'
      buildingSize: null,
      eaveHeight: null,

      // Door configuration
      doors: {
        rollUp12: { qty: 0, placement: 'gabled' },
        walkthrough: { qty: 0 }
      },

      // Add-ons
      addons: {},

      // Bolt-Up custom quote (when type is boltUp)
      boltUpSpecs: {
        customSize: '',
        customEave: '',
        doorPrefs: '',
        addOnPrefs: '',
        specialReqs: ''
      },

      // Contract signing flow (starts at step 6)
      contractStep: 0,

      // Customer info
      customer: {
        name: '',
        phone: '',
        email: '',
        address1: '',
        address2: '',
        city: '',
        state: 'TX',
        zip: '',
        propertySameAsMailing: false,
        propertyAddress1: '',
        propertyAddress2: '',
        propertyCity: '',
        propertyState: 'TX',
        propertyZip: ''
      },

      // 7 Contract sections acknowledgments
      sections: {
        projectOverview: { checked: false, initialed: false },
        paymentTerms: { checked: false, initialed: false },
        timeline: { checked: false, initialed: false },
        responsibilities: { checked: false, initialed: false },
        warranties: { checked: false, initialed: false },
        legalProvisions: { checked: false, initialed: false }
      },

      // Signatures
      ownerTypedName: '',
      ownerSigned: false,
      ownerSigData: null,  // Store signature image data
      contractorTypedName: 'Bobby Burnett',
      contractorSigned: false,
      contractorSigData: null,  // Store signature image data
      initialsData: {},  // Store initials image data by section ID

      // Payment
      paymentMethod: null,
      paymentReference: '',

      // Sending
      sending: false,
      sent: false,
      sendError: null
    };

    // Store initials pads
    const initialsPads = {};

    // ==================== LOGO SVG ====================
    const LOGO_SVG = `
      <svg viewBox="0 0 100 100" class="w-12 h-12">
        <!-- Outer hexagon (dark blue) -->
        <polygon points="50,2 93,27 93,73 50,98 7,73 7,27" fill="#003057" stroke="#003057" stroke-width="2"/>
        <!-- Inner hexagon (cyan) -->
        <polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#05c3de"/>
        <!-- Letter B -->
        <text x="30" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">B</text>
        <!-- Letter C -->
        <text x="52" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">C</text>
      </svg>
    `;

    const LOGO_SVG_SMALL = `
      <svg viewBox="0 0 100 100" class="w-8 h-8">
        <polygon points="50,2 93,27 93,73 50,98 7,73 7,27" fill="#003057" stroke="#003057" stroke-width="2"/>
        <polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#05c3de"/>
        <text x="30" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">B</text>
        <text x="52" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">C</text>
      </svg>
    `;

    // ==================== DATA ====================

    // Building Types
    const BUILDING_TYPES = {
      poleBarn: {
        name: 'Pole Barn',
        desc: 'Weld-Up Construction',
        color: '#003057',
        icon: 'üèóÔ∏è',
        hasFixedPricing: true
      },
      carport: {
        name: 'Carport',
        desc: 'Covered Structure',
        color: '#22c55e',
        icon: 'üöó',
        hasFixedPricing: true
      },
      boltUp: {
        name: 'Bolt-Up Construction',
        desc: 'Engineered Steel Building',
        color: '#05c3de',
        icon: 'üè¢',
        hasFixedPricing: false,
        note: 'Custom Quote Required'
      }
    };

    // 10 Building Sizes with "Starting at" prices
    const BUILDING_SIZES = [
      { id: '30x40', label: "30' √ó 40'", sqft: 1200, startingPrice: 26500 },
      { id: '30x50', label: "30' √ó 50'", sqft: 1500, startingPrice: 31000 },
      { id: '40x40', label: "40' √ó 40'", sqft: 1600, startingPrice: 33000 },
      { id: '40x50', label: "40' √ó 50'", sqft: 2000, startingPrice: 39000 },
      { id: '40x60', label: "40' √ó 60'", sqft: 2400, startingPrice: 45000 },
      { id: '50x50', label: "50' √ó 50'", sqft: 2500, startingPrice: 47000 },
      { id: '50x60', label: "50' √ó 60'", sqft: 3000, startingPrice: 54000 },
      { id: '50x80', label: "50' √ó 80'", sqft: 4000, startingPrice: 68000 },
      { id: '60x60', label: "60' √ó 60'", sqft: 3600, startingPrice: 62000 },
      { id: '60x100', label: "60' √ó 100'", sqft: 6000, startingPrice: 95000 }
    ];

    // 5 Eave Heights
    const EAVE_HEIGHTS = [
      { id: '10', label: "10 ft", modifier: 0 },
      { id: '12', label: "12 ft", modifier: 1500 },
      { id: '14', label: "14 ft", modifier: 3500 },
      { id: '16', label: "16 ft", modifier: 6000 },
      { id: '20', label: "20 ft", modifier: 12000 }
    ];

    // Add-ons per specification
    const ADDONS = [
      { cat: 'Doors', items: [
        { id: 'door_roll_12', name: "12'√ó12' Roll-Up Door", price: 2890, note: 'Qty set in door config' },
        { id: 'door_walk', name: "Walkthrough Door", price: 1045, note: 'Qty set in door config' }
      ]},
      { cat: 'Windows', items: [
        { id: 'win_3x3', name: "3'√ó3' Fixed Window", price: 525, hasQty: true, maxQty: 10 },
        { id: 'win_4x4', name: "4'√ó4' Slider Window", price: 695, hasQty: true, maxQty: 10 }
      ]},
      { cat: 'Insulation', items: [
        { id: 'wall_insulation', name: "Wall Insulation", price: 2500 },
        { id: 'roof_insulation', name: "Roof Insulation", price: 2000 }
      ]},
      { cat: 'Options', items: [
        { id: 'gutters', name: "Gutters & Downspouts", price: 1890 },
        { id: 'wainscot', name: "Wainscot Siding (3' tall)", price: 1200, hasQty: true, maxQty: 4, note: 'Per wall' },
        { id: 'concrete_slab', name: "Concrete Slab (4\" w/ rebar)", price: 0, perSqFt: 8, note: 'Price based on building size' }
      ]}
    ];

    // 7 Contract sections (consolidated from 19)
    const CONTRACT_SECTIONS = [
      { id: 'info', title: 'Customer Information', icon: 'üë§', requiresAck: false },
      { id: 'projectOverview', title: '1. Project Overview', icon: 'üìñ', requiresAck: true },
      { id: 'paymentTerms', title: '2. Payment Terms', icon: 'üí∞', requiresAck: true },
      { id: 'timeline', title: '3. Timeline & Changes', icon: 'üìÖ', requiresAck: true },
      { id: 'responsibilities', title: '4. Responsibilities', icon: 'üîß', requiresAck: true },
      { id: 'warranties', title: '5. Warranties & Insurance', icon: 'üõ°Ô∏è', requiresAck: true },
      { id: 'legalProvisions', title: '6. Legal Provisions', icon: '‚öñÔ∏è', requiresAck: true },
      { id: 'signatures', title: '7. Final Acknowledgment', icon: '‚úçÔ∏è', requiresAck: false }
    ];

    // ==================== SIGNATURE/INITIALS PAD ====================
    class SignaturePad {
      constructor(canvas, onChange, isInitials = false) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.drawing = false;
        this.onChange = onChange;
        this.isInitials = isInitials;
        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = isInitials ? 1.5 : 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';

        canvas.addEventListener('mousedown', (e) => this.start(e));
        canvas.addEventListener('mousemove', (e) => this.draw(e));
        canvas.addEventListener('mouseup', () => this.stop());
        canvas.addEventListener('mouseleave', () => this.stop());
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.start(e); }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(e); }, { passive: false });
        canvas.addEventListener('touchend', () => this.stop());
      }

      getPos(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x: x * (this.canvas.width / rect.width), y: y * (this.canvas.height / rect.height) };
      }

      start(e) {
        this.drawing = true;
        const pos = this.getPos(e);
        this.ctx.beginPath();
        this.ctx.moveTo(pos.x, pos.y);
      }

      draw(e) {
        if (!this.drawing) return;
        const pos = this.getPos(e);
        this.ctx.lineTo(pos.x, pos.y);
        this.ctx.stroke();
        this.ctx.beginPath();
        this.ctx.moveTo(pos.x, pos.y);
      }

      stop() {
        if (this.drawing) {
          this.drawing = false;
          if (this.onChange) this.onChange(true);
        }
      }

      clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        if (this.onChange) this.onChange(false);
      }

      isEmpty() {
        const data = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height).data;
        for (let i = 3; i < data.length; i += 4) {
          if (data[i] !== 0) return false;
        }
        return true;
      }

      getDataURL() {
        return this.canvas.toDataURL('image/png');
      }
    }

    // ==================== HELPER FUNCTIONS ====================
    function formatCurrency(num) {
      return '$' + num.toLocaleString();
    }

    function getSelectedSize() {
      return BUILDING_SIZES.find(s => s.id === state.buildingSize);
    }

    function getSelectedEave() {
      return EAVE_HEIGHTS.find(e => e.id === state.eaveHeight);
    }

    // Calculate total for current building config
    function calculateCurrentBuildingTotal() {
      const size = getSelectedSize();
      const eave = getSelectedEave();
      if (!size || !eave) return 0;

      let total = size.startingPrice + eave.modifier;

      // Add doors
      total += state.doors.rollUp12.qty * 2890;
      total += state.doors.walkthrough.qty * 1045;

      // Add selected add-ons (quantity stored directly in state.addons[id])
      ADDONS.forEach(cat => {
        cat.items.forEach(item => {
          const qty = state.addons[item.id] || 0;
          if (qty > 0 && !item.id.startsWith('door_')) {
            if (item.perSqFt) {
              total += item.perSqFt * size.sqft;
            } else {
              total += item.price * qty;
            }
          }
        });
      });

      return total;
    }

    // Calculate total for a specific building in the array (multiplied by qty)
    function calculateBuildingTotal(building) {
      const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
      const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
      if (!size || !eave) return 0;

      let unitPrice = size.startingPrice + eave.modifier;
      unitPrice += building.doors.rollUp12.qty * 2890;
      unitPrice += building.doors.walkthrough.qty * 1045;

      ADDONS.forEach(cat => {
        cat.items.forEach(item => {
          const qty = building.addons[item.id] || 0;
          if (qty > 0 && !item.id.startsWith('door_')) {
            if (item.perSqFt) {
              unitPrice += item.perSqFt * size.sqft;
            } else {
              unitPrice += item.price * qty;
            }
          }
        });
      });

      // Multiply by building quantity
      const buildingQty = building.qty || 1;
      return unitPrice * buildingQty;
    }

    // Get unit price for a single building (without quantity multiplier)
    function getBuildingUnitPrice(building) {
      const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
      const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
      if (!size || !eave) return 0;

      let unitPrice = size.startingPrice + eave.modifier;
      unitPrice += building.doors.rollUp12.qty * 2890;
      unitPrice += building.doors.walkthrough.qty * 1045;

      ADDONS.forEach(cat => {
        cat.items.forEach(item => {
          const qty = building.addons[item.id] || 0;
          if (qty > 0 && !item.id.startsWith('door_')) {
            if (item.perSqFt) {
              unitPrice += item.perSqFt * size.sqft;
            } else {
              unitPrice += item.price * qty;
            }
          }
        });
      });

      return unitPrice;
    }

    // Calculate grand total of all buildings
    function calculateTotal() {
      let total = 0;
      // Add all saved buildings
      state.buildings.forEach(building => {
        total += calculateBuildingTotal(building);
      });
      // Add current building if configured (and not already saved)
      if (state.buildingType && state.buildingSize && state.eaveHeight) {
        // Check if current config is already in buildings array
        const isEditing = state.buildings.length > 0 && state.currentBuildingIndex < state.buildings.length;
        if (!isEditing) {
          total += calculateCurrentBuildingTotal();
        }
      }
      return total;
    }

    // Save current building configuration to buildings array
    function saveCurrentBuilding() {
      const existingQty = (state.currentBuildingIndex < state.buildings.length)
        ? (state.buildings[state.currentBuildingIndex].qty || 1)
        : 1;

      const buildingConfig = {
        buildingType: state.buildingType,
        buildingSize: state.buildingSize,
        eaveHeight: state.eaveHeight,
        doors: JSON.parse(JSON.stringify(state.doors)),
        addons: JSON.parse(JSON.stringify(state.addons)),
        qty: existingQty
      };

      if (state.currentBuildingIndex < state.buildings.length) {
        // Update existing building
        state.buildings[state.currentBuildingIndex] = buildingConfig;
      } else {
        // Add new building
        state.buildings.push(buildingConfig);
      }
    }

    // Adjust building quantity
    function adjustBuildingQty(index, delta) {
      const building = state.buildings[index];
      const newQty = Math.max(1, Math.min(99, (building.qty || 1) + delta));
      building.qty = newQty;
      render();
    }

    // Add another building
    function addAnotherBuilding() {
      // Save current building first
      saveCurrentBuilding();
      // Reset for new building
      state.currentBuildingIndex = state.buildings.length;
      state.buildingType = null;
      state.buildingSize = null;
      state.eaveHeight = null;
      state.doors = { rollUp12: { qty: 0, placement: 'gabled' }, walkthrough: { qty: 0 } };
      state.addons = {};
      state.step = 0;
      render();
    }

    // Edit an existing building
    function editBuilding(index) {
      const building = state.buildings[index];
      state.currentBuildingIndex = index;
      state.buildingType = building.buildingType;
      state.buildingSize = building.buildingSize;
      state.eaveHeight = building.eaveHeight;
      state.doors = JSON.parse(JSON.stringify(building.doors));
      state.addons = JSON.parse(JSON.stringify(building.addons));
      state.step = 0;
      render();
    }

    // Remove a building
    function removeBuilding(index) {
      if (confirm('Remove this building from the order?')) {
        state.buildings.splice(index, 1);
        if (state.buildings.length === 0) {
          // Reset to empty state
          state.currentBuildingIndex = 0;
        } else {
          state.currentBuildingIndex = Math.min(state.currentBuildingIndex, state.buildings.length - 1);
        }
        render();
      }
    }

    // ==================== RENDER FUNCTIONS ====================
    function render() {
      const app = document.getElementById('app');

      // Determine what to render based on step
      if (state.step === 0) {
        app.innerHTML = renderBuildingType();
      } else if (state.buildingType === 'boltUp') {
        app.innerHTML = renderBoltUpForm();
      } else if (state.step === 1) {
        app.innerHTML = renderBuildingSize();
      } else if (state.step === 2) {
        app.innerHTML = renderEaveHeight();
      } else if (state.step === 3) {
        app.innerHTML = renderDoorConfig();
      } else if (state.step === 4) {
        app.innerHTML = renderAddons();
      } else if (state.step === 5) {
        app.innerHTML = renderSummary();
      } else {
        app.innerHTML = renderContract();
      }
    }

    // Step 0: Building Type Selection
    function renderBuildingType() {
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG}
              <div>
                <h1 class="text-xl font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">Metal Building Estimator</p>
              </div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Select Building Type</h2>
            <p class="text-gray-600">Choose the type of metal building for your project</p>
          </div>

          <div class="grid gap-4 md:grid-cols-3">
            ${Object.entries(BUILDING_TYPES).map(([key, type]) => `
              <div onclick="selectBuildingType('${key}')"
                   class="type-card rounded-xl p-6 text-center ${state.buildingType === key ? 'selected' : ''}">
                <div class="text-4xl mb-3">${type.icon}</div>
                <h3 class="text-xl font-bold" style="color: ${type.color === '#003057' ? '#04ceea' : type.color}">${type.name}</h3>
                <p class="text-gray-300 text-sm mt-1">${type.desc}</p>
                ${type.hasFixedPricing ?
                  `<p class="text-[#04ceea] font-semibold mt-3">Starting at $26,500</p>` :
                  `<p class="text-orange-400 font-semibold mt-3">‚ö†Ô∏è ${type.note}</p>`
                }
              </div>
            `).join('')}
          </div>

          <div class="mt-8 flex justify-end">
            <button onclick="nextStep()" ${!state.buildingType ? 'disabled' : ''}
                    class="py-3 px-8 rounded-xl font-semibold ${state.buildingType ? 'btn-active' : 'bg-gray-200 text-gray-400'}">
              Next ‚Üí
            </button>
          </div>
        </main>
      `;
    }

    // Bolt-Up Custom Quote Form
    function renderBoltUpForm() {
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG}
              <div>
                <h1 class="text-xl font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">Bolt-Up Construction - Custom Quote</p>
              </div>
            </div>
          </div>
        </header>

        <main class="max-w-2xl mx-auto p-4">
          <div class="bg-orange-50 border-2 border-orange-400 rounded-xl p-4 mb-6">
            <p class="text-orange-800 font-semibold">‚ö†Ô∏è Bolt-Up Construction requires a custom quote</p>
            <p class="text-orange-700 text-sm mt-1">Pricing varies based on wind zone, snow zone, and engineering requirements. Please provide your specifications below.</p>
          </div>

          <div class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Request Custom Quote</h2>

            <div class="space-y-4">
              <div>
                <label class="block font-semibold text-gray-700 mb-1">Your Name *</label>
                <input type="text" value="${state.customer.name}" oninput="updateBoltUpField('name', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="Full name">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Phone *</label>
                <input type="tel" value="${state.customer.phone}" oninput="updateBoltUpField('phone', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="(555) 555-5555">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Email *</label>
                <input type="email" value="${state.customer.email}" oninput="updateBoltUpField('email', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="you@email.com">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Desired Building Size</label>
                <input type="text" value="${state.boltUpSpecs.customSize}" oninput="updateBoltUpSpec('customSize', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="e.g., 60' x 80' or custom dimensions">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Desired Eave Height</label>
                <input type="text" value="${state.boltUpSpecs.customEave}" oninput="updateBoltUpSpec('customEave', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="e.g., 16 ft, 20 ft, etc.">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Door Preferences</label>
                <textarea value="${state.boltUpSpecs.doorPrefs}" oninput="updateBoltUpSpec('doorPrefs', this.value)"
                          class="border-2 rounded-lg p-3 w-full" rows="2"
                          placeholder="e.g., Two 14x14 roll-up doors on front, one walk door on side">${state.boltUpSpecs.doorPrefs}</textarea>
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Add-On Preferences</label>
                <textarea value="${state.boltUpSpecs.addOnPrefs}" oninput="updateBoltUpSpec('addOnPrefs', this.value)"
                          class="border-2 rounded-lg p-3 w-full" rows="2"
                          placeholder="e.g., Insulation, gutters, windows, concrete slab">${state.boltUpSpecs.addOnPrefs}</textarea>
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Special Requirements / Notes</label>
                <textarea value="${state.boltUpSpecs.specialReqs}" oninput="updateBoltUpSpec('specialReqs', this.value)"
                          class="border-2 rounded-lg p-3 w-full" rows="3"
                          placeholder="Any other specifications, site conditions, or requirements...">${state.boltUpSpecs.specialReqs}</textarea>
              </div>
            </div>

            <div class="mt-6 flex gap-4">
              <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
                ‚Üê Back
              </button>
              <button onclick="submitBoltUpQuote()"
                      class="flex-1 py-3 px-6 rounded-xl font-semibold btn-primary">
                üìß Request Quote
              </button>
            </div>
          </div>
        </main>
      `;
    }

    // Step 1: Building Size Selection
    function renderBuildingSize() {
      const type = BUILDING_TYPES[state.buildingType];
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Select Building Size</h2>
            <p class="text-gray-600">Standard 3-on-12 roof pitch on all buildings</p>
          </div>

          <div class="grid gap-3 grid-cols-2 md:grid-cols-5">
            ${BUILDING_SIZES.map(size => `
              <div onclick="selectSize('${size.id}')"
                   class="size-card rounded-lg p-4 text-center ${state.buildingSize === size.id ? 'selected' : ''}">
                <div class="font-bold text-lg text-white">${size.label}</div>
                <div class="text-gray-300 text-sm">${size.sqft.toLocaleString()} sq ft</div>
                <div class="text-[#04ceea] font-semibold text-sm mt-2">Starting at</div>
                <div class="text-[#04ceea] font-bold">${formatCurrency(size.startingPrice)}</div>
              </div>
            `).join('')}
          </div>

          <div class="mt-6 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ‚Üê Back
            </button>
            <button onclick="nextStep()" ${!state.buildingSize ? 'disabled' : ''}
                    class="py-3 px-8 rounded-xl font-semibold ${state.buildingSize ? 'btn-active' : 'bg-gray-200 text-gray-400'}">
              Next ‚Üí
            </button>
          </div>
        </main>
      `;
    }

    // Step 2: Eave Height Selection
    function renderEaveHeight() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name} - ${size.label}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Select Eave Height</h2>
            <p class="text-gray-600">Choose the wall height for your building</p>
          </div>

          <div class="flex flex-wrap justify-center gap-4">
            ${EAVE_HEIGHTS.map(eave => `
              <button onclick="selectEave('${eave.id}')"
                      class="eave-btn rounded-xl p-6 text-center min-w-[120px] ${state.eaveHeight === eave.id ? 'selected' : ''}">
                <div class="text-3xl font-bold ${state.eaveHeight === eave.id ? 'text-[#003057]' : 'text-white'}">${eave.label}</div>
                <div class="text-sm mt-2 ${state.eaveHeight === eave.id ? 'text-[#003057]' : 'text-[#04ceea]'}">
                  ${eave.modifier === 0 ? 'Base price' : '+' + formatCurrency(eave.modifier)}
                </div>
              </button>
            `).join('')}
          </div>

          <div class="mt-8 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ‚Üê Back
            </button>
            <button onclick="nextStep()" ${!state.eaveHeight ? 'disabled' : ''}
                    class="py-3 px-8 rounded-xl font-semibold ${state.eaveHeight ? 'btn-active' : 'bg-gray-200 text-gray-400'}">
              Next ‚Üí
            </button>
          </div>
        </main>
      `;
    }

    // Step 3: Door Configuration
    function renderDoorConfig() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name} - ${size.label} √ó ${eave.label}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Door Configuration</h2>
            <p class="text-gray-600">Configure doors for your building</p>
          </div>

          <div class="bg-white rounded-xl p-6 shadow-lg space-y-6">
            <!-- Roll-Up Doors -->
            <div class="border-b pb-6">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h3 class="font-bold text-lg">12' √ó 12' Roll-Up Doors</h3>
                  <p class="text-gray-500 text-sm">$2,890 each</p>
                </div>
                <div class="flex items-center gap-3">
                  <button onclick="adjustDoor('rollUp12', -1)" class="w-10 h-10 rounded-full bg-gray-200 font-bold text-xl">‚àí</button>
                  <span class="text-2xl font-bold w-8 text-center">${state.doors.rollUp12.qty}</span>
                  <button onclick="adjustDoor('rollUp12', 1)" class="w-10 h-10 rounded-full bg-[#05c3de] text-white font-bold text-xl">+</button>
                </div>
              </div>
              ${state.doors.rollUp12.qty > 0 ? `
                <div class="bg-gray-50 rounded-lg p-4">
                  <p class="font-semibold text-sm mb-2">Placement:</p>
                  <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="rollUpPlacement" value="gabled"
                             ${state.doors.rollUp12.placement === 'gabled' ? 'checked' : ''}
                             onchange="updateDoorPlacement('rollUp12', 'gabled')">
                      <span>Gabled End</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="radio" name="rollUpPlacement" value="eave"
                             ${state.doors.rollUp12.placement === 'eave' ? 'checked' : ''}
                             onchange="updateDoorPlacement('rollUp12', 'eave')">
                      <span>Eave Side</span>
                    </label>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">‚ö†Ô∏è Minimum 2 ft from wall edge required</p>
                </div>
              ` : ''}
            </div>

            <!-- Walkthrough Doors -->
            <div>
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg">Walkthrough Doors</h3>
                  <p class="text-gray-500 text-sm">$1,045 each</p>
                </div>
                <div class="flex items-center gap-3">
                  <button onclick="adjustDoor('walkthrough', -1)" class="w-10 h-10 rounded-full bg-gray-200 font-bold text-xl">‚àí</button>
                  <span class="text-2xl font-bold w-8 text-center">${state.doors.walkthrough.qty}</span>
                  <button onclick="adjustDoor('walkthrough', 1)" class="w-10 h-10 rounded-full bg-[#05c3de] text-white font-bold text-xl">+</button>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ‚Üê Back
            </button>
            <button onclick="nextStep()" class="py-3 px-8 rounded-xl font-semibold btn-active">
              Next ‚Üí
            </button>
          </div>
        </main>
      `;
    }

    // Step 4: Add-ons
    function renderAddons() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name} - ${size.label} √ó ${eave.label}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Add-Ons & Options</h2>
            <p class="text-gray-600">Customize your building with additional features</p>
          </div>

          <div class="space-y-6">
            ${ADDONS.filter(cat => cat.cat !== 'Doors').map(category => `
              <div class="bg-white rounded-xl p-4 shadow">
                <h3 class="font-bold text-lg mb-3 text-[#003057]">${category.cat}</h3>
                <div class="space-y-3">
                  ${category.items.filter(item => !item.id.startsWith('door_')).map(item => {
                    const qty = state.addons[item.id] || 0;
                    const selected = qty > 0;
                    let priceDisplay = formatCurrency(item.price);
                    if (item.perSqFt) {
                      priceDisplay = formatCurrency(item.perSqFt * size.sqft) + ` ($${item.perSqFt}/sq ft)`;
                    }

                    // Items with quantity controls
                    if (item.hasQty) {
                      return `
                        <div class="flex items-center justify-between p-3 rounded-lg border-2 ${selected ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 bg-white'}">
                          <div class="flex-1">
                            <span class="font-semibold">${item.name}</span>
                            ${item.note ? `<span class="text-gray-500 text-sm ml-2">(${item.note})</span>` : ''}
                            <div class="text-[#003057] font-bold text-sm">${priceDisplay} each</div>
                          </div>
                          <div class="flex items-center gap-3">
                            <button onclick="adjustAddon('${item.id}', -1, ${item.maxQty || 10})"
                                    class="w-9 h-9 rounded-full bg-gray-200 font-bold text-lg ${qty === 0 ? 'opacity-50' : ''}">‚àí</button>
                            <span class="text-xl font-bold w-6 text-center">${qty}</span>
                            <button onclick="adjustAddon('${item.id}', 1, ${item.maxQty || 10})"
                                    class="w-9 h-9 rounded-full bg-[#05c3de] text-white font-bold text-lg">+</button>
                          </div>
                        </div>
                      `;
                    }

                    // Toggle items (yes/no)
                    return `
                      <div class="flex items-center justify-between p-3 rounded-lg border-2 ${selected ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 bg-white'}">
                        <div class="flex-1">
                          <span class="font-semibold">${item.name}</span>
                          ${item.note ? `<span class="text-gray-500 text-sm ml-2">(${item.note})</span>` : ''}
                        </div>
                        <div class="flex items-center gap-4">
                          <span class="font-bold text-[#003057]">${priceDisplay}</span>
                          <button onclick="toggleAddon('${item.id}')"
                                  class="w-10 h-10 rounded-full text-lg font-bold"
                                  style="background: ${selected ? '#05c3de' : '#f3f4f6'}; color: ${selected ? 'white' : '#9ca3af'}">
                            ${selected ? '‚úì' : '+'}
                          </button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `).join('')}
          </div>

          <div class="mt-6 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ‚Üê Back
            </button>
            <button onclick="nextStep()" class="py-3 px-8 rounded-xl font-semibold btn-active">
              View Summary ‚Üí
            </button>
          </div>
        </main>
      `;
    }

    // Step 5: Summary
    function renderSummary() {
      // Save current building to array if not already there
      if (state.buildingType && state.buildingSize && state.eaveHeight) {
        saveCurrentBuilding();
      }

      const grandTotal = state.buildings.reduce((sum, b) => sum + calculateBuildingTotal(b), 0);
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Generate line items for each building
      function getBuildingLineItems(building, index) {
        const type = BUILDING_TYPES[building.buildingType];
        const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
        const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
        let items = [];

        items.push({ name: `${type.name} - ${size.label} √ó ${eave.label}`, price: size.startingPrice + eave.modifier });

        if (building.doors.rollUp12.qty > 0) {
          items.push({ name: `  12'√ó12' Roll-Up Door √ó ${building.doors.rollUp12.qty}`, price: building.doors.rollUp12.qty * 2890 });
        }
        if (building.doors.walkthrough.qty > 0) {
          items.push({ name: `  Walkthrough Door √ó ${building.doors.walkthrough.qty}`, price: building.doors.walkthrough.qty * 1045 });
        }

        ADDONS.forEach(cat => {
          cat.items.forEach(item => {
            const qty = building.addons[item.id] || 0;
            if (qty > 0 && !item.id.startsWith('door_')) {
              let price = item.perSqFt ? item.perSqFt * size.sqft : item.price * qty;
              const displayName = qty > 1 ? `  ${item.name} √ó ${qty}` : `  ${item.name}`;
              items.push({ name: displayName, price });
            }
          });
        });

        return items;
      }

      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Burnett Customs</h1>
                <p class="text-[#003057] text-sm opacity-80">Order Summary</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(grandTotal)}</div>
              <div class="text-[#003057] text-xs opacity-80">${totalBuildingQty} Building${totalBuildingQty !== 1 ? 's' : ''} Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-2xl mx-auto p-4">
          <!-- Building Cards -->
          ${state.buildings.map((building, index) => {
            const type = BUILDING_TYPES[building.buildingType];
            const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
            const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
            const unitPrice = getBuildingUnitPrice(building);
            const buildingQty = building.qty || 1;
            const buildingTotal = calculateBuildingTotal(building);
            const lineItems = getBuildingLineItems(building, index);

            return `
              <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-4">
                <div class="bg-[#003057] text-white p-4">
                  <div class="flex justify-between items-start">
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <span class="bg-[#05c3de] text-[#003057] text-xs font-bold px-2 py-1 rounded">Building ${index + 1}</span>
                      </div>
                      <h2 class="text-lg font-bold">${type.name} - ${size.label} √ó ${eave.label}</h2>
                      <p class="text-sm opacity-80 mt-1">Unit Price: ${formatCurrency(unitPrice)}</p>
                    </div>
                    <div class="text-right">
                      <div class="text-xl font-bold">${formatCurrency(buildingTotal)}</div>
                      ${buildingQty > 1 ? `<div class="text-xs opacity-80">(${buildingQty} √ó ${formatCurrency(unitPrice)})</div>` : ''}
                    </div>
                  </div>

                  <!-- Quantity Selector -->
                  <div class="mt-3 flex items-center justify-between bg-[#01315b] rounded-lg p-3">
                    <span class="text-sm font-medium">How many of this building?</span>
                    <div class="flex items-center gap-3">
                      <button onclick="adjustBuildingQty(${index}, -1)"
                              class="w-10 h-10 rounded-full bg-[#05c3de] text-[#003057] font-bold text-xl flex items-center justify-center hover:bg-[#04ceea] transition-colors ${buildingQty <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                        ‚àí
                      </button>
                      <span class="text-2xl font-bold w-12 text-center">${buildingQty}</span>
                      <button onclick="adjustBuildingQty(${index}, 1)"
                              class="w-10 h-10 rounded-full bg-[#05c3de] text-[#003057] font-bold text-xl flex items-center justify-center hover:bg-[#04ceea] transition-colors">
                        +
                      </button>
                    </div>
                  </div>
                </div>

                <div class="p-4">
                  <table class="w-full text-sm">
                    <tbody>
                      ${lineItems.map(item => `
                        <tr class="border-b border-gray-100">
                          <td class="py-2 text-gray-700">${item.name}</td>
                          <td class="py-2 text-right font-medium">${formatCurrency(item.price)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>

                <div class="px-4 pb-4 flex gap-2">
                  <button onclick="editBuilding(${index})" class="flex-1 py-2 text-sm font-semibold text-[#003057] border-2 border-[#003057] rounded-lg hover:bg-gray-50">
                    ‚úèÔ∏è Edit
                  </button>
                  ${state.buildings.length > 1 ? `
                    <button onclick="removeBuilding(${index})" class="py-2 px-4 text-sm font-semibold text-red-600 border-2 border-red-300 rounded-lg hover:bg-red-50">
                      üóëÔ∏è
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}

          <!-- Add Another Building Button -->
          <button onclick="addAnotherBuilding()"
                  class="w-full py-4 mb-4 border-2 border-dashed border-[#05c3de] rounded-xl text-[#003057] font-semibold hover:bg-[#e0f7fa] transition-colors">
            ‚ûï Add Another Building
          </button>

          <!-- Grand Total -->
          <div class="bg-[#003057] text-white rounded-xl p-4 mb-4">
            <div class="flex justify-between items-center">
              <div>
                <div class="text-sm opacity-80">${totalBuildingQty} Building${totalBuildingQty !== 1 ? 's' : ''} (${configCount} config${configCount !== 1 ? 's' : ''})</div>
                <div class="text-lg font-bold">Grand Total</div>
              </div>
              <div class="text-3xl font-bold">${formatCurrency(grandTotal)}</div>
            </div>
          </div>

          <div class="bg-[#e0f7fa] rounded-xl p-4 mb-6">
            <p class="text-sm text-gray-700">
              <strong>Note:</strong> This is an estimate. Final pricing will be confirmed in the contract.
              Prices shown are "starting at" prices and may vary based on site conditions and final specifications.
            </p>
          </div>

          <div class="flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ‚Üê Back
            </button>
            <button onclick="proceedToContract()" class="py-3 px-8 rounded-xl font-semibold btn-primary">
              Proceed to Contract ‚Üí
            </button>
          </div>
        </main>
      `;
    }

    // Contract Flow (Step 6+)
    function renderContract() {
      const section = CONTRACT_SECTIONS[state.contractStep];
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      const total = calculateTotal();

      return `
        <header class="header-bar p-3 shadow-lg no-print">
          <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                ${LOGO_SVG_SMALL}
                <div>
                  <h1 class="text-lg font-bold text-[#003057]">Burnett Customs</h1>
                  <p class="text-[#003057] text-xs opacity-80">${type.name} - ${size.label} √ó ${eave.label}</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-[#003057]">${formatCurrency(total)}</div>
                <div class="text-[#003057] text-xs opacity-80">Contract Sum</div>
              </div>
            </div>

            <!-- Progress indicator -->
            <div class="flex items-center justify-center gap-1 mt-2 overflow-x-auto pb-1">
              ${CONTRACT_SECTIONS.map((s, i) => `
                <div class="flex items-center">
                  <div class="progress-step ${i < state.contractStep ? 'completed' : i === state.contractStep ? 'current' : 'pending'}">
                    ${i < state.contractStep ? '‚úì' : i + 1}
                  </div>
                  ${i < CONTRACT_SECTIONS.length - 1 ? `<div class="w-3 h-0.5" style="background: ${i < state.contractStep ? '#05c3de' : '#003057'}"></div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </header>

        <main class="max-w-2xl mx-auto p-4">
          ${renderContractSection()}

          <div class="mt-6 flex justify-between items-center no-print">
            <button onclick="prevContractStep()" ${state.contractStep === 0 ? 'disabled' : ''}
                    class="py-3 px-6 rounded-xl font-semibold ${state.contractStep === 0 ? 'bg-gray-100 text-gray-400' : 'border-2 border-gray-300 text-gray-600 hover:bg-gray-50'}">
              ‚Üê Back
            </button>

            <div class="text-center">
              <p id="sectionWarning" class="text-sm text-red-500 mb-1"></p>
            </div>

            ${state.contractStep < CONTRACT_SECTIONS.length - 1 ? `
              <button id="nextSectionBtn" onclick="nextContractStep()"
                      class="py-3 px-6 rounded-xl font-semibold btn-primary">
                Next Section ‚Üí
              </button>
            ` : `
              <button onclick="sendContract()" ${state.sending ? 'disabled' : ''}
                      class="py-3 px-6 rounded-xl font-semibold btn-primary">
                ${state.sending ? 'Sending...' : 'üìß Send Contract'}
              </button>
            `}
          </div>
        </main>
      `;
    }

    function renderContractSection() {
      const section = CONTRACT_SECTIONS[state.contractStep];

      switch(section.id) {
        case 'info': return renderCustomerInfo();
        case 'projectOverview': return renderProjectOverview();
        case 'paymentTerms': return renderPaymentTerms();
        case 'timeline': return renderTimeline();
        case 'responsibilities': return renderResponsibilities();
        case 'warranties': return renderWarranties();
        case 'legalProvisions': return renderLegalProvisions();
        case 'signatures': return renderSignatures();
        default: return '<p>Section not found</p>';
      }
    }

    // Contract Section: Customer Info
    function renderCustomerInfo() {
      const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">üë§ Customer Information</h3>

          <div class="space-y-4">
            <div>
              <label class="block font-semibold text-gray-700 mb-1">Full Legal Name *</label>
              <input type="text" id="customerName" value="${state.customer.name}" oninput="updateCustomer('name', this.value)"
                     class="border-2 rounded-lg p-3 w-full text-lg ${state.customer.name ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Enter full legal name">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold text-gray-700 mb-1">Phone Number *</label>
                <input type="tel" id="customerPhone" value="${state.customer.phone}" oninput="updateCustomer('phone', this.value)"
                       class="border-2 rounded-lg p-3 w-full text-lg ${state.customer.phone ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="(555) 555-5555">
              </div>
              <div>
                <label class="block font-semibold text-gray-700 mb-1">Email Address *</label>
                <input type="email" id="customerEmail" value="${state.customer.email}" oninput="updateCustomer('email', this.value)"
                       class="border-2 rounded-lg p-3 w-full text-lg ${state.customer.email ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="you@email.com">
              </div>
            </div>

            <!-- Mailing Address Section -->
            <div class="border-t pt-4 mt-4">
              <h4 class="font-bold text-gray-800 mb-3">üìç Mailing Address</h4>
              <div class="space-y-3">
                <div>
                  <label class="block font-semibold text-gray-700 mb-1">Address Line 1 *</label>
                  <input type="text" value="${state.customer.address1}" oninput="updateCustomer('address1', this.value)"
                         class="border-2 rounded-lg p-3 w-full ${state.customer.address1 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Street address">
                </div>
                <div>
                  <label class="block font-semibold text-gray-700 mb-1">Address Line 2</label>
                  <input type="text" value="${state.customer.address2}" oninput="updateCustomer('address2', this.value)"
                         class="border-2 rounded-lg p-3 w-full ${state.customer.address2 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Apt, Suite, Unit, etc. (optional)">
                </div>
                <div class="grid grid-cols-6 gap-3">
                  <div class="col-span-3">
                    <label class="block font-semibold text-gray-700 mb-1">City *</label>
                    <input type="text" value="${state.customer.city}" oninput="updateCustomer('city', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.city ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="City">
                  </div>
                  <div class="col-span-1">
                    <label class="block font-semibold text-gray-700 mb-1">State *</label>
                    <select onchange="updateCustomer('state', this.value)"
                            class="border-2 rounded-lg p-3 w-full ${state.customer.state ? 'border-[#05c3de]' : 'border-gray-300'}">
                      ${states.map(s => `<option value="${s}" ${state.customer.state === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                  </div>
                  <div class="col-span-2">
                    <label class="block font-semibold text-gray-700 mb-1">Zip Code *</label>
                    <input type="text" value="${state.customer.zip}" oninput="updateCustomer('zip', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.zip ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Zip">
                  </div>
                </div>
              </div>
            </div>

            <!-- Property Address Section -->
            <div class="border-t pt-4 mt-4">
              <h4 class="font-bold text-gray-800 mb-3">üèóÔ∏è Property Address (Construction Site)</h4>
              <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                <input type="checkbox" id="sameAsMailing" ${state.customer.propertySameAsMailing ? 'checked' : ''}
                       onchange="toggleSameAsMailing()" class="w-5 h-5 cursor-pointer">
                <label for="sameAsMailing" class="cursor-pointer font-medium text-gray-700">
                  Property address is the same as mailing address
                </label>
              </div>

              ${!state.customer.propertySameAsMailing ? `
                <div class="space-y-3">
                  <div>
                    <label class="block font-semibold text-gray-700 mb-1">Address Line 1 *</label>
                    <input type="text" value="${state.customer.propertyAddress1}" oninput="updateCustomer('propertyAddress1', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.propertyAddress1 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Street address">
                  </div>
                  <div>
                    <label class="block font-semibold text-gray-700 mb-1">Address Line 2</label>
                    <input type="text" value="${state.customer.propertyAddress2}" oninput="updateCustomer('propertyAddress2', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.propertyAddress2 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Apt, Suite, Unit, etc. (optional)">
                  </div>
                  <div class="grid grid-cols-6 gap-3">
                    <div class="col-span-3">
                      <label class="block font-semibold text-gray-700 mb-1">City *</label>
                      <input type="text" value="${state.customer.propertyCity}" oninput="updateCustomer('propertyCity', this.value)"
                             class="border-2 rounded-lg p-3 w-full ${state.customer.propertyCity ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="City">
                    </div>
                    <div class="col-span-1">
                      <label class="block font-semibold text-gray-700 mb-1">State *</label>
                      <select onchange="updateCustomer('propertyState', this.value)"
                              class="border-2 rounded-lg p-3 w-full ${state.customer.propertyState ? 'border-[#05c3de]' : 'border-gray-300'}">
                        ${states.map(s => `<option value="${s}" ${state.customer.propertyState === s ? 'selected' : ''}>${s}</option>`).join('')}
                      </select>
                    </div>
                    <div class="col-span-2">
                      <label class="block font-semibold text-gray-700 mb-1">Zip Code *</label>
                      <input type="text" value="${state.customer.propertyZip}" oninput="updateCustomer('propertyZip', this.value)"
                             class="border-2 rounded-lg p-3 w-full ${state.customer.propertyZip ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Zip">
                    </div>
                  </div>
                </div>
              ` : `
                <div class="bg-[#e0f7fa] p-4 rounded-lg border-2 border-[#05c3de]">
                  <p class="text-[#003057]">‚úì Using mailing address as property address</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function toggleSameAsMailing() {
      state.customer.propertySameAsMailing = !state.customer.propertySameAsMailing;
      if (state.customer.propertySameAsMailing) {
        // Copy mailing address to property address
        state.customer.propertyAddress1 = state.customer.address1;
        state.customer.propertyAddress2 = state.customer.address2;
        state.customer.propertyCity = state.customer.city;
        state.customer.propertyState = state.customer.state;
        state.customer.propertyZip = state.customer.zip;
      }
      render();
    }

    // Contract Section 1: Project Overview (consolidated)
    function renderProjectOverview() {
      const sectionData = state.sections.projectOverview;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">üìñ Section 1: Project Overview</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DEFINITIONS</h4>
            <div class="legal-text space-y-2">
              <p><strong>"Owner"</strong> means the property owner signing this Contract.</p>
              <p><strong>"Contractor"</strong> means Burnett Customs, LLC.</p>
              <p><strong>"Work"</strong> means all labor, materials, equipment, and services required to complete the Project.</p>
              <p><strong>"Contract Sum"</strong> means the total price stated in this Contract for the Work.</p>
              <p><strong>"Substantial Completion"</strong> means the Work is sufficiently complete so the Owner can occupy or use the Project for its intended purpose.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">SCOPE OF CONTRACT</h4>
            <div class="legal-text">
              <p>This Contract Agreement covers Improvements only <strong>from drip edge to drip edge</strong>.</p>
              <p class="mt-2">The scope includes the metal building structure as configured in the estimate. Any work outside this scope requires a written Change Order.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">PLANS & REVISIONS</h4>
            <div class="legal-text">
              <p>Owner has <strong>3 opportunities</strong> to redo/amend/revise the Plans before Work commences at no cost.</p>
              <p class="mt-2">On the 4th revision and every revision thereafter: <strong>$550.00</strong> per revision.</p>
              <p class="mt-2">All requested revisions after work commences shall be a Change Order.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('projectOverview', isComplete)}
        </div>
      `;
    }

    // Contract Section 2: Payment Terms
    function renderPaymentTerms() {
      const sectionData = state.sections.paymentTerms;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">üí∞ Section 2: Payment Terms</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DRAW SCHEDULE</h4>
            <div class="legal-text">
              <p><strong>Draw 1 (30%):</strong> Due upon contract signing</p>
              <p><strong>Draw 2 (30%):</strong> Due upon delivery of materials to job site</p>
              <p><strong>Draw 3 (30%):</strong> Due upon completion of framing</p>
              <p><strong>Final Draw (10%):</strong> Due upon Substantial Completion</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">MATERIAL COSTS</h4>
            <div class="legal-text">
              <p>Material prices are subject to market fluctuations. If material costs increase more than <strong>5%</strong> between contract signing and material ordering, Owner will be notified and may:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Accept the price increase via Change Order</li>
                <li>Cancel the contract with refund of deposits less administrative fees</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">ADDITIONAL COSTS</h4>
            <div class="legal-text">
              <p><strong>Contractor's Risk Policy, Dirt Work & Pump Truck:</strong></p>
              <p>These expenses are at <strong>cost plus 20%</strong> due from Owner.</p>
              <p class="mt-2">Payment is due <strong>before the delivery of Foundation Material</strong>.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('paymentTerms', isComplete)}
        </div>
      `;
    }

    // Contract Section 3: Timeline & Changes
    function renderTimeline() {
      const sectionData = state.sections.timeline;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">üìÖ Section 3: Timeline & Changes</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CHANGE ORDERS</h4>
            <div class="legal-text">
              <p>Changes to the Work require a written Change Order signed by both parties.</p>
              <p class="mt-2">Change Orders will specify:</p>
              <ul class="list-disc ml-6">
                <li>Description of the change</li>
                <li>Adjustment to Contract Sum</li>
                <li>Adjustment to schedule (if any)</li>
              </ul>
              <p class="mt-2">Work on changes shall not begin until the Change Order is signed and any required payment is received.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DELAYS & FORCE MAJEURE</h4>
            <div class="legal-text">
              <p>Contractor shall not be liable for delays caused by:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Weather conditions unsuitable for construction</li>
                <li>Acts of God, natural disasters, or emergencies</li>
                <li>Material shortages or supplier delays beyond Contractor's control</li>
                <li>Government actions, inspections, or permit delays</li>
                <li>Owner-requested changes or Owner-caused delays</li>
              </ul>
              <p class="mt-2">The project timeline will be extended by the duration of any such delays.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('timeline', isComplete)}
        </div>
      `;
    }

    // Contract Section 4: Responsibilities
    function renderResponsibilities() {
      const sectionData = state.sections.responsibilities;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">üîß Section 4: Responsibilities</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONTRACTOR RESPONSIBILITIES</h4>
            <div class="legal-text">
              <p>Contractor shall:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Perform all Work in a good and workmanlike manner</li>
                <li>Furnish all labor, materials, and equipment necessary for the Work</li>
                <li>Comply with all applicable building codes and regulations</li>
                <li>Maintain a safe job site</li>
                <li>Obtain necessary permits (permit fees are Owner's responsibility)</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">OWNER RESPONSIBILITIES</h4>
            <div class="legal-text">
              <p>Owner shall:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Provide clear access to the job site</li>
                <li>Ensure the site is ready for construction (clear, level, accessible)</li>
                <li>Make timely payments according to the draw schedule</li>
                <li>Make decisions and provide approvals in a timely manner</li>
                <li>Notify Contractor of any known site conditions</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONSUMER PRODUCTS NOTICE</h4>
            <div class="legal-text">
              <p>Materials used may include products from third-party manufacturers. Contractor assigns to Owner any manufacturer warranties on such products but makes no independent warranty on consumer products.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('responsibilities', isComplete)}
        </div>
      `;
    }

    // Contract Section 5: Warranties & Insurance
    function renderWarranties() {
      const sectionData = state.sections.warranties;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">üõ°Ô∏è Section 5: Warranties & Insurance</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONTRACTOR WARRANTY</h4>
            <div class="legal-text">
              <p>Contractor warrants the Work against defects in workmanship for a period of <strong>ONE (1) YEAR</strong> from the date of Substantial Completion.</p>
              <p class="mt-2">This warranty covers defects in the Contractor's labor and installation only.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">WARRANTY LIMITATIONS</h4>
            <div class="legal-text">
              <p>The warranty does NOT cover:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Normal wear and tear</li>
                <li>Damage caused by Owner, third parties, or Acts of God</li>
                <li>Modifications made by anyone other than Contractor</li>
                <li>Failure to maintain the building properly</li>
                <li>Manufacturer product defects (covered by manufacturer warranty)</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">INSURANCE</h4>
            <div class="legal-text">
              <p>Contractor maintains:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>General Liability Insurance</li>
                <li>Workers' Compensation Insurance</li>
              </ul>
              <p class="mt-2">Owner is responsible for insuring the property and structure once Substantial Completion is achieved.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">EARLY OCCUPATION</h4>
            <div class="legal-text">
              <p>If Owner occupies or uses the Project before Substantial Completion:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Owner assumes all risk of loss or damage</li>
                <li>Owner must maintain insurance on the structure</li>
                <li>Warranty period begins on the date of early occupation</li>
              </ul>
            </div>
          </div>

          ${renderSectionAcknowledgment('warranties', isComplete)}
        </div>
      `;
    }

    // Contract Section 6: Legal Provisions
    function renderLegalProvisions() {
      const sectionData = state.sections.legalProvisions;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">‚öñÔ∏è Section 6: Legal Provisions</h3>

          <div class="contract-section bg-red-50 border-red-200">
            <h4 class="font-bold mb-2 text-red-800">‚ö†Ô∏è IMPORTANT LEGAL NOTICES - READ CAREFULLY</h4>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DEFAULT & LIABILITY</h4>
            <div class="legal-text">
              <p><strong>If Owner defaults</strong> (fails to make payment or breaches this Contract), Contractor may:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Stop Work and remove equipment from the site</li>
                <li>Retain all payments received</li>
                <li>Pursue all legal remedies available</li>
              </ul>
              <p class="mt-4"><strong>LIMITATION ON LIABILITY:</strong></p>
              <p class="font-semibold">NEITHER PARTY SHALL BE LIABLE TO THE OTHER FOR SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">BINDING ARBITRATION</h4>
            <div class="legal-text">
              <p class="font-semibold text-red-700">IMPORTANT - READ CAREFULLY:</p>
              <p class="mt-2">Any dispute arising from this Contract:</p>
              <ol class="list-decimal ml-6 mt-2">
                <li><strong>SHALL FIRST BE SUBMITTED TO MEDIATION</strong></li>
                <li>If not settled during mediation, <strong>SHALL THEREAFTER BE SUBMITTED TO BINDING ARBITRATION</strong></li>
              </ol>
              <p class="mt-2">as provided by the <strong>Federal Arbitration Act (9 U.S.C. ¬ß1 et seq.)</strong></p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">JURY TRIAL WAIVER</h4>
            <div class="legal-text">
              <p class="font-semibold">BOTH PARTIES VOLUNTARILY AND KNOWINGLY WAIVE ANY RIGHT TO A TRIAL BY JURY</p>
              <p class="mt-2">in any action or proceeding arising out of or related to this Contract.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">TEXAS RCLA NOTICE</h4>
            <div class="legal-text">
              <p class="font-semibold">IMPORTANT NOTICE REGARDING CONSTRUCTION DEFECTS:</p>
              <p class="mt-2">Chapter 27 of the Texas Property Code requires that before you file a lawsuit for defective construction against the Contractor, you must:</p>
              <ol class="list-decimal ml-6 mt-2">
                <li>Give Contractor written notice of the defect at least 60 days before filing suit</li>
                <li>Allow Contractor to inspect the property</li>
                <li>Allow Contractor the opportunity to make a written offer to repair or settle</li>
              </ol>
              <p class="mt-2">Failure to follow these procedures may affect your legal rights.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONFIDENTIALITY</h4>
            <div class="legal-text">
              <p>Both parties agree to keep confidential the terms of this Contract and any proprietary information exchanged during the Project.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('legalProvisions', isComplete)}
        </div>
      `;
    }

    // Contract Section 7: Final Signatures
    function renderSignatures() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      const total = calculateTotal();

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">‚úçÔ∏è Section 7: Final Acknowledgment & Signatures</h3>

          <div class="contract-section bg-[#e0f7fa]">
            <h4 class="font-bold mb-2">CONTRACT SUMMARY</h4>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
              <div>
                <p><strong>Building Type:</strong> ${type.name}</p>
                <p><strong>Size:</strong> ${size.label}</p>
                <p><strong>Eave Height:</strong> ${eave.label}</p>
              </div>
              <div>
                <p><strong>Contract Sum:</strong> ${formatCurrency(total)}</p>
                <p><strong>Owner:</strong> ${state.customer.name || 'Not entered'}</p>
                <p><strong>Contractor:</strong> Burnett Customs, LLC</p>
              </div>
            </div>
          </div>

          <div class="contract-section">
            <p class="legal-text font-semibold">By signing below, both parties acknowledge that:</p>
            <ul class="list-disc ml-6 mt-2 legal-text">
              <li>They have read and understand ALL sections of this Contract</li>
              <li>They have had the opportunity to consult with an attorney</li>
              <li>They agree to be bound by the terms and conditions herein</li>
              <li>The Contractor has personally walked the Owner through every section</li>
            </ul>
          </div>

          <!-- Owner Signature -->
          <div class="mt-6">
            <h4 class="font-bold text-lg mb-3">Owner Signature</h4>
            <div id="ownerSigContainer" class="bg-white p-4 rounded-lg border-2 ${state.ownerTypedName && state.ownerSigned ? 'border-[#05c3de]' : 'border-gray-300'}">
              <div class="mb-3">
                <label class="block text-sm font-semibold mb-1">Print Name:</label>
                <input type="text" id="ownerTypedNameInput" value="${state.ownerTypedName}" oninput="updateOwnerName(this.value)"
                       class="border-2 rounded-lg p-2 w-full ${state.ownerTypedName ? 'border-[#05c3de]' : 'border-gray-300'}"
                       placeholder="Type your full legal name">
              </div>
              <label class="block text-sm font-semibold mb-1">Signature:</label>
              <canvas id="ownerSigPad" width="400" height="100" class="signature-pad w-full ${state.ownerSigned ? 'signed' : ''}"></canvas>
              <button onclick="clearOwnerSignature()" class="mt-2 text-sm text-gray-500 hover:text-gray-700">Clear signature</button>
            </div>
          </div>

          <!-- Contractor Signature -->
          <div class="mt-6">
            <h4 class="font-bold text-lg mb-3">Contractor Signature</h4>
            <div id="contractorSigContainer" class="bg-white p-4 rounded-lg border-2 ${state.contractorTypedName && state.contractorSigned ? 'border-[#05c3de]' : 'border-gray-300'}">
              <div class="mb-3">
                <label class="block text-sm font-semibold mb-1">Print Name:</label>
                <input type="text" id="contractorTypedNameInput" value="${state.contractorTypedName}" oninput="updateContractorName(this.value)"
                       class="border-2 rounded-lg p-2 w-full ${state.contractorTypedName ? 'border-[#05c3de]' : 'border-gray-300'}">
                <p class="text-xs text-gray-500 mt-1">Company: Burnett Customs, LLC</p>
              </div>
              <label class="block text-sm font-semibold mb-1">Signature:</label>
              <canvas id="contractorSigPad" width="400" height="100" class="signature-pad w-full ${state.contractorSigned ? 'signed' : ''}"></canvas>
              <button onclick="clearContractorSignature()" class="mt-2 text-sm text-gray-500 hover:text-gray-700">Clear signature</button>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="mt-6">
            <h4 class="font-bold text-lg mb-3">Payment Method for First Draw</h4>
            <div class="bg-[#e0f7fa] p-4 rounded-lg border-2 border-[#05c3de] mb-4">
              <p class="text-sm"><strong>First Draw Due:</strong> ${formatCurrency(Math.round(total * 0.30))} (30% of Contract Sum)</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              ${['cash', 'check', 'card', 'financing', 'ach'].map(method => `
                <button onclick="selectPaymentMethod('${method}')"
                        class="p-3 rounded-lg border-2 text-center ${state.paymentMethod === method ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 hover:border-gray-300'}">
                  <span class="font-semibold capitalize">${method === 'ach' ? 'ACH Transfer' : method}</span>
                </button>
              `).join('')}
            </div>
            ${state.paymentMethod === 'card' ? `
              <p class="mt-3 text-sm text-[#003057]">üí≥ Card payment will be processed separately. Contractor will collect card information securely.</p>
            ` : ''}
          </div>

          ${state.sent ? `
            <div class="mt-6 bg-green-50 border-2 border-green-500 rounded-xl p-4 text-center">
              <p class="text-green-800 font-bold text-lg">‚úÖ Contract Sent Successfully!</p>
              <p class="text-green-700">Copies have been sent to both parties.</p>
              <div class="flex flex-col sm:flex-row gap-3 justify-center mt-4">
                <button onclick="downloadContract()" class="py-3 px-6 btn-secondary rounded-lg font-semibold">üì• Download Contract</button>
                <button onclick="printContract()" class="py-3 px-6 btn-primary rounded-lg font-semibold">üñ®Ô∏è Print Contract</button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Helper: Render Section Acknowledgment
    function renderSectionAcknowledgment(sectionId, isComplete) {
      const sectionData = state.sections[sectionId];
      return `
        <div class="section-ack ${isComplete ? 'complete' : ''}">
          <div class="flex items-start gap-3 mb-4">
            <input type="checkbox" id="check_${sectionId}" ${sectionData.checked ? 'checked' : ''}
                   onchange="toggleSectionCheck('${sectionId}')"
                   class="w-5 h-5 mt-1 cursor-pointer">
            <label for="check_${sectionId}" class="cursor-pointer">
              <span class="font-semibold">I have read and understand this section.</span>
              <span class="text-gray-600 text-sm block">By checking this box, I acknowledge that I have read, understand, and agree to the terms above.</span>
            </label>
          </div>

          <div class="initials-container">
            <label class="block text-sm font-semibold mb-2 text-center">Initial Below to Acknowledge:</label>
            <canvas id="initials_${sectionId}" width="200" height="70"
                    class="initials-pad ${sectionData.initialed ? 'signed' : ''}"></canvas>
            <button onclick="clearInitials('${sectionId}')"
                    class="mt-3 px-4 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md hover:bg-gray-50">
              Clear Initials
            </button>
            ${isComplete ? '<div class="mt-3 text-green-600 font-semibold text-center">‚úì Section Complete</div>' : ''}
          </div>
        </div>
      `;
    }

    // ==================== EVENT HANDLERS ====================

    function selectBuildingType(type) {
      state.buildingType = type;
      render();
    }

    function selectSize(sizeId) {
      state.buildingSize = sizeId;
      render();
    }

    function selectEave(eaveId) {
      state.eaveHeight = eaveId;
      render();
    }

    function adjustDoor(doorType, delta) {
      const current = state.doors[doorType].qty;
      state.doors[doorType].qty = Math.max(0, Math.min(4, current + delta));
      render();
    }

    function updateDoorPlacement(doorType, placement) {
      state.doors[doorType].placement = placement;
    }

    function toggleAddon(id) {
      // Toggle between 0 and 1 for non-qty items
      state.addons[id] = state.addons[id] ? 0 : 1;
      render();
    }

    function adjustAddon(id, delta, maxQty) {
      const current = state.addons[id] || 0;
      state.addons[id] = Math.max(0, Math.min(maxQty, current + delta));
      render();
    }

    function nextStep() {
      if (state.buildingType === 'boltUp' && state.step === 0) {
        state.step = 1; // Will render bolt-up form
      } else {
        state.step++;
      }
      render();
    }

    function goBack() {
      if (state.step > 0) {
        // Going back from summary - load the last building for editing
        if (state.step === 5 && state.buildings.length > 0) {
          const lastIndex = state.buildings.length - 1;
          const building = state.buildings[lastIndex];
          state.currentBuildingIndex = lastIndex;
          state.buildingType = building.buildingType;
          state.buildingSize = building.buildingSize;
          state.eaveHeight = building.eaveHeight;
          state.doors = JSON.parse(JSON.stringify(building.doors));
          state.addons = JSON.parse(JSON.stringify(building.addons));
          // Remove from array since we're editing
          state.buildings.pop();
          state.step = 4; // Go to addons
        } else {
          state.step--;
          if (state.buildingType === 'boltUp' && state.step === 0) {
            state.buildingType = null;
          }
        }
      }
      render();
    }

    function proceedToContract() {
      state.step = 6;
      state.contractStep = 0;
      render();
    }

    function nextContractStep() {
      const section = CONTRACT_SECTIONS[state.contractStep];

      // Validate current section if it requires acknowledgment
      if (section.requiresAck) {
        const sectionData = state.sections[section.id];
        if (!sectionData.checked || !sectionData.initialed) {
          document.getElementById('sectionWarning').textContent = 'Please check the box and add your initials to continue.';
          return;
        }
      }

      // Validate customer info
      if (section.id === 'info') {
        // Check basic info
        if (!state.customer.name || !state.customer.phone || !state.customer.email) {
          document.getElementById('sectionWarning').textContent = 'Please fill in name, phone, and email.';
          return;
        }
        // Check mailing address
        if (!state.customer.address1 || !state.customer.city || !state.customer.state || !state.customer.zip) {
          document.getElementById('sectionWarning').textContent = 'Please fill in complete mailing address.';
          return;
        }
        // Check property address (if not same as mailing)
        if (!state.customer.propertySameAsMailing) {
          if (!state.customer.propertyAddress1 || !state.customer.propertyCity || !state.customer.propertyState || !state.customer.propertyZip) {
            document.getElementById('sectionWarning').textContent = 'Please fill in complete property address or check "same as mailing".';
            return;
          }
        }
      }

      state.contractStep++;
      render();

      // Initialize signature pads if on signatures section
      if (CONTRACT_SECTIONS[state.contractStep].id === 'signatures') {
        setTimeout(initSignaturePads, 100);
      }
    }

    function prevContractStep() {
      if (state.contractStep > 0) {
        state.contractStep--;
        render();
      }
    }

    function toggleSectionCheck(sectionId) {
      state.sections[sectionId].checked = !state.sections[sectionId].checked;
      updateNavigationState();
    }

    function updateNavigationState() {
      const section = CONTRACT_SECTIONS[state.contractStep];
      if (!section.requiresAck) return;

      const sectionData = state.sections[section.id];
      const canProceed = sectionData.checked && sectionData.initialed;

      const nextBtn = document.getElementById('nextSectionBtn');
      const warning = document.getElementById('sectionWarning');

      if (nextBtn) {
        nextBtn.disabled = !canProceed;
        nextBtn.className = `py-3 px-6 rounded-xl font-semibold ${canProceed ? 'btn-primary' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`;
      }
      if (warning) {
        warning.textContent = '';
      }
    }

    function clearInitials(sectionId) {
      if (initialsPads[sectionId]) {
        initialsPads[sectionId].clear();
        state.sections[sectionId].initialed = false;
        delete state.initialsData[sectionId];
        updateNavigationState();
      }
    }

    function updateCustomer(field, value) {
      state.customer[field] = value;
      // Update input border color
      const input = document.getElementById('customer' + field.charAt(0).toUpperCase() + field.slice(1));
      if (input) {
        input.classList.remove('border-gray-300', 'border-[#05c3de]');
        input.classList.add(value ? 'border-[#05c3de]' : 'border-gray-300');
      }
    }

    function updateBoltUpField(field, value) {
      state.customer[field] = value;
    }

    function updateBoltUpSpec(field, value) {
      state.boltUpSpecs[field] = value;
    }

    function updateOwnerName(value) {
      state.ownerTypedName = value;
      const input = document.getElementById('ownerTypedNameInput');
      if (input) {
        input.classList.remove('border-gray-300', 'border-[#05c3de]');
        input.classList.add(value ? 'border-[#05c3de]' : 'border-gray-300');
      }
    }

    function updateContractorName(value) {
      state.contractorTypedName = value;
      const input = document.getElementById('contractorTypedNameInput');
      if (input) {
        input.classList.remove('border-gray-300', 'border-[#05c3de]');
        input.classList.add(value ? 'border-[#05c3de]' : 'border-gray-300');
      }
    }

    function selectPaymentMethod(method) {
      // Save signature data before re-render
      saveSignatureData();
      state.paymentMethod = method;
      render();
      setTimeout(() => {
        initSignaturePads();
        restoreSignatureData();
      }, 100);
    }

    function saveSignatureData() {
      // Save owner signature
      const ownerCanvas = document.getElementById('ownerSigPad');
      if (ownerCanvas && window.ownerPad && !window.ownerPad.isEmpty()) {
        state.ownerSigData = ownerCanvas.toDataURL('image/png');
      }
      // Save contractor signature
      const contractorCanvas = document.getElementById('contractorSigPad');
      if (contractorCanvas && window.contractorPad && !window.contractorPad.isEmpty()) {
        state.contractorSigData = contractorCanvas.toDataURL('image/png');
      }
      // Save initials for all sections
      Object.keys(state.sections).forEach(sectionId => {
        const initialsCanvas = document.getElementById('initials_' + sectionId);
        if (initialsCanvas && initialsPads[sectionId] && !initialsPads[sectionId].isEmpty()) {
          state.initialsData[sectionId] = initialsCanvas.toDataURL('image/png');
        }
      });
    }

    function restoreSignatureData() {
      // Restore owner signature
      if (state.ownerSigData) {
        const ownerCanvas = document.getElementById('ownerSigPad');
        if (ownerCanvas) {
          const img = new Image();
          img.onload = () => {
            const ctx = ownerCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            ownerCanvas.classList.add('signed');
          };
          img.src = state.ownerSigData;
        }
      }
      // Restore contractor signature
      if (state.contractorSigData) {
        const contractorCanvas = document.getElementById('contractorSigPad');
        if (contractorCanvas) {
          const img = new Image();
          img.onload = () => {
            const ctx = contractorCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            contractorCanvas.classList.add('signed');
          };
          img.src = state.contractorSigData;
        }
      }
      // Restore initials for all sections
      Object.keys(state.initialsData).forEach(sectionId => {
        const initialsCanvas = document.getElementById('initials_' + sectionId);
        if (initialsCanvas && state.initialsData[sectionId]) {
          const img = new Image();
          img.onload = () => {
            const ctx = initialsCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            initialsCanvas.classList.add('signed');
          };
          img.src = state.initialsData[sectionId];
        }
      });
    }

    function initSignaturePads() {
      // Owner signature - always reinitialize since canvas may be recreated
      const ownerCanvas = document.getElementById('ownerSigPad');
      if (ownerCanvas) {
        // Check if this is a new canvas element (different from what ownerPad was attached to)
        if (!window.ownerPad || window.ownerPad.canvas !== ownerCanvas) {
          window.ownerPad = new SignaturePad(ownerCanvas, (signed) => {
            state.ownerSigned = signed;
            if (signed) {
              state.ownerSigData = ownerCanvas.toDataURL('image/png');
            }
            ownerCanvas.classList.toggle('signed', signed);
          });
        }
      }

      // Contractor signature - always reinitialize since canvas may be recreated
      const contractorCanvas = document.getElementById('contractorSigPad');
      if (contractorCanvas) {
        if (!window.contractorPad || window.contractorPad.canvas !== contractorCanvas) {
          window.contractorPad = new SignaturePad(contractorCanvas, (signed) => {
            state.contractorSigned = signed;
            if (signed) {
              state.contractorSigData = contractorCanvas.toDataURL('image/png');
            }
            contractorCanvas.classList.toggle('signed', signed);
          });
        }
      }

      // Initialize initials pads for current section
      const section = CONTRACT_SECTIONS[state.contractStep];
      if (section && section.requiresAck) {
        const initialsCanvas = document.getElementById('initials_' + section.id);
        if (initialsCanvas) {
          if (!initialsPads[section.id] || initialsPads[section.id].canvas !== initialsCanvas) {
            initialsPads[section.id] = new SignaturePad(initialsCanvas, (signed) => {
              state.sections[section.id].initialed = signed;
              if (signed) {
                state.initialsData[section.id] = initialsCanvas.toDataURL('image/png');
              }
              initialsCanvas.classList.toggle('signed', signed);
              updateNavigationState();
            }, true);
          }
        }
      }
    }

    function clearOwnerSignature() {
      if (window.ownerPad) {
        window.ownerPad.clear();
        state.ownerSigned = false;
        state.ownerSigData = null;
      }
    }

    function clearContractorSignature() {
      if (window.contractorPad) {
        window.contractorPad.clear();
        state.contractorSigned = false;
        state.contractorSigData = null;
      }
    }

    function submitBoltUpQuote() {
      if (!state.customer.name || !state.customer.phone || !state.customer.email) {
        alert('Please fill in your name, phone, and email.');
        return;
      }

      const subject = encodeURIComponent('Bolt-Up Building Quote Request');
      const body = encodeURIComponent(`
BOLT-UP BUILDING QUOTE REQUEST
==============================

Contact Information:
- Name: ${state.customer.name}
- Phone: ${state.customer.phone}
- Email: ${state.customer.email}

Building Specifications:
- Desired Size: ${state.boltUpSpecs.customSize || 'Not specified'}
- Desired Eave Height: ${state.boltUpSpecs.customEave || 'Not specified'}

Door Preferences:
${state.boltUpSpecs.doorPrefs || 'Not specified'}

Add-On Preferences:
${state.boltUpSpecs.addOnPrefs || 'Not specified'}

Special Requirements/Notes:
${state.boltUpSpecs.specialReqs || 'None'}

---
Submitted via Burnett Metal Building Estimator
      `);

      window.location.href = `mailto:bobby@burnettcustoms.net?subject=${subject}&body=${body}`;

      alert('Your quote request is ready to send! Your email client should open with the details.');
    }

    function sendContract() {
      // Validate signatures
      if (!state.ownerTypedName || !state.ownerSigned) {
        alert('Owner must print their name and sign.');
        return;
      }
      if (!state.contractorTypedName || !state.contractorSigned) {
        alert('Contractor must print their name and sign.');
        return;
      }
      if (!state.paymentMethod) {
        alert('Please select a payment method.');
        return;
      }

      state.sending = true;
      render();
      setTimeout(initSignaturePads, 100);

      // Build contract summary for all buildings
      const total = calculateTotal();
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Build buildings summary text
      let buildingsSummary = '';
      state.buildings.forEach((building, index) => {
        const type = BUILDING_TYPES[building.buildingType];
        const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
        const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
        const qty = building.qty || 1;
        const unitPrice = getBuildingUnitPrice(building);
        const buildingTotal = calculateBuildingTotal(building);
        buildingsSummary += `
BUILDING CONFIG ${index + 1} (Qty: ${qty}):
- Type: ${type.name}
- Size: ${size.label}
- Eave Height: ${eave.label}
- Unit Price: ${formatCurrency(unitPrice)}
- Subtotal: ${formatCurrency(buildingTotal)}${qty > 1 ? ` (${qty} √ó ${formatCurrency(unitPrice)})` : ''}
`;
      });

      const firstBuilding = state.buildings[0];
      const firstType = BUILDING_TYPES[firstBuilding.buildingType];
      const firstSize = BUILDING_SIZES.find(s => s.id === firstBuilding.buildingSize);

      const subject = encodeURIComponent(`Burnett Customs Contract - ${state.customer.name} - ${totalBuildingQty} Building${totalBuildingQty !== 1 ? 's' : ''}`);
      const body = encodeURIComponent(`
BURNETT CUSTOMS - EXECUTED CONTRACT
====================================

ORDER SUMMARY:
- Total Buildings: ${totalBuildingQty} (${configCount} configuration${configCount !== 1 ? 's' : ''})
- Contract Sum: ${formatCurrency(total)}
${buildingsSummary}
OWNER INFORMATION:
- Name: ${state.customer.name}
- Phone: ${state.customer.phone}
- Email: ${state.customer.email}
- Mailing Address: ${state.customer.address1}${state.customer.address2 ? ', ' + state.customer.address2 : ''}, ${state.customer.city}, ${state.customer.state} ${state.customer.zip}
- Property Address: ${state.customer.propertySameAsMailing ? 'Same as mailing address' : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '') + ', ' + state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip}

PAYMENT:
- Method: ${state.paymentMethod}
- First Draw Due: ${formatCurrency(Math.round(total * 0.30))} (30%)

SIGNATURES:
- Owner: ${state.ownerTypedName} (Signed digitally)
- Contractor: ${state.contractorTypedName} (Signed digitally)
- Date: ${new Date().toLocaleDateString()}

All 6 contract sections were acknowledged with checkbox and initials by the Owner.

---
This contract was executed digitally via Burnett Metal Building Estimator.
Burnett Customs, LLC
      `);

      // Open emails
      const contractorLink = `mailto:bobby@burnettcustoms.net?subject=${subject}&body=${body}`;
      const customerLink = `mailto:${state.customer.email}?subject=${subject}&body=${body}`;

      window.open(contractorLink, '_blank');
      setTimeout(() => {
        window.open(customerLink, '_blank');
      }, 500);

      state.sent = true;
      state.sending = false;
      render();
      setTimeout(initSignaturePads, 100);

      alert('Your email client should open with the contract details. Please send both emails to complete the process.\n\nEmails to:\n‚Ä¢ ' + state.customer.email + '\n‚Ä¢ bobby@burnettcustoms.net');
    }

    // Print full contract
    function printContract() {
      const total = calculateTotal();
      const today = new Date().toLocaleDateString();
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Get initials data URLs
      const initialsData = {};
      ['projectOverview', 'paymentTerms', 'timeline', 'responsibilities', 'warranties', 'legalProvisions'].forEach(sectionId => {
        const canvas = document.getElementById('initials_' + sectionId);
        if (canvas) {
          initialsData[sectionId] = canvas.toDataURL('image/png');
        }
      });

      // Get signature data URLs
      const ownerSigCanvas = document.getElementById('ownerSigPad');
      const contractorSigCanvas = document.getElementById('contractorSigPad');
      const ownerSigData = ownerSigCanvas ? ownerSigCanvas.toDataURL('image/png') : '';
      const contractorSigData = contractorSigCanvas ? contractorSigCanvas.toDataURL('image/png') : '';

      // Build print HTML
      const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Burnett Customs Contract - ${state.customer.name}</title>
          <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1f2937; line-height: 1.5; }
            .container { max-width: 800px; margin: 0 auto; padding: 30px; }
            .header { text-align: center; border-bottom: 3px solid #003057; padding-bottom: 20px; margin-bottom: 25px; }
            .header h1 { font-size: 28px; color: #003057; margin-bottom: 5px; }
            .header p { font-size: 12px; color: #6b7280; }
            .summary-box { background: #f9fafb; border: 2px solid #003057; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
            .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .summary-item { font-size: 12px; }
            .summary-item strong { display: block; color: #003057; margin-bottom: 2px; }
            .section { page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; }
            .section h3 { font-size: 14px; color: #003057; border-bottom: 2px solid #05c3de; padding-bottom: 6px; margin-bottom: 12px; }
            .section p, .section li { font-size: 10px; line-height: 1.6; margin-bottom: 6px; color: #374151; }
            .section ul { margin-left: 20px; }
            .ack-line { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 10px; border-top: 1px dashed #9ca3af; font-size: 10px; }
            .initials-img { height: 35px; border: 1px solid #000; background: #fff; }
            .signature-page { page-break-before: always; margin-top: 30px; }
            .sig-section { margin-bottom: 30px; }
            .sig-section h4 { font-size: 14px; color: #003057; margin-bottom: 10px; }
            .sig-box { border: 1px solid #000; padding: 10px; margin-bottom: 5px; min-height: 70px; display: flex; align-items: center; justify-content: center; }
            .sig-img { max-height: 60px; max-width: 100%; }
            .sig-details { font-size: 10px; color: #6b7280; }
            .final-section { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; text-align: center; margin-top: 30px; }
            @media print {
              .section { page-break-inside: avoid; }
              .signature-page { page-break-before: always; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <svg viewBox="0 0 100 100" style="width: 60px; height: 60px; margin: 0 auto 10px;">
                <polygon points="50,2 93,27 93,73 50,98 7,73 7,27" fill="#003057" stroke="#003057" stroke-width="2"/>
                <polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#05c3de"/>
                <text x="30" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">B</text>
                <text x="52" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">C</text>
              </svg>
              <h1>BURNETT CUSTOMS</h1>
              <p>Metal Building Construction Agreement</p>
              <p>Contract Date: ${today}</p>
            </div>

            <div class="summary-box">
              <div class="summary-grid">
                <div class="summary-item">
                  <strong>Total Buildings</strong>
                  ${totalBuildingQty} (${configCount} config${configCount !== 1 ? 's' : ''})
                </div>
                <div class="summary-item">
                  <strong>Contract Sum</strong>
                  ${formatCurrency(total)}
                </div>
                <div class="summary-item">
                  <strong>Owner</strong>
                  ${state.customer.name}<br>
                  ${state.customer.phone} | ${state.customer.email}
                </div>
                <div class="summary-item">
                  <strong>Property Address</strong>
                  ${state.customer.propertySameAsMailing
                    ? state.customer.address1 + (state.customer.address2 ? ', ' + state.customer.address2 : '') + '<br>' + state.customer.city + ', ' + state.customer.state + ' ' + state.customer.zip
                    : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '') + '<br>' + state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip
                  }
                </div>
              </div>
              <!-- Buildings List -->
              ${state.buildings.map((building, index) => {
                const bType = BUILDING_TYPES[building.buildingType];
                const bSize = BUILDING_SIZES.find(s => s.id === building.buildingSize);
                const bEave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
                const bQty = building.qty || 1;
                const bUnitPrice = getBuildingUnitPrice(building);
                const bTotal = calculateBuildingTotal(building);
                return '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;"><strong style="color: #003057;">Building Config ' + (index + 1) + ' (Qty: ' + bQty + '):</strong> ' + bType.name + ' - ' + bSize.label + ' √ó ' + bEave.label + ' <span style="float: right;">' + formatCurrency(bTotal) + (bQty > 1 ? ' (' + bQty + ' √ó ' + formatCurrency(bUnitPrice) + ')' : '') + '</span></div>';
              }).join('')}
            </div>

            <!-- Section 1: Project Overview -->
            <div class="section">
              <h3>1. Project Overview</h3>
              <p><strong>Scope of Work:</strong> Contractor shall furnish all labor, materials, equipment, and services necessary to construct ${totalBuildingQty} metal building${totalBuildingQty !== 1 ? 's' : ''} at the property address specified above, in accordance with the specifications selected by Owner in this Contract.</p>
              <p><strong>Building Specifications:</strong> See building list above. Final specifications subject to engineering approval.</p>
              <p><strong>Contract Sum:</strong> ${formatCurrency(total)} - This is the total amount payable by Owner to Contractor for the complete and satisfactory performance of the Work described herein.</p>
              <div class="ack-line">
                <span>‚úì Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.projectOverview || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 2: Payment Terms -->
            <div class="section">
              <h3>2. Payment Terms</h3>
              <p><strong>Payment Schedule:</strong></p>
              <ul>
                <li><strong>First Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon contract signing</li>
                <li><strong>Second Draw (40%):</strong> ${formatCurrency(Math.round(total * 0.40))} - Due when materials arrive on site</li>
                <li><strong>Final Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon substantial completion</li>
              </ul>
              <p><strong>Late Payment:</strong> Payments not received within 10 days of due date shall accrue interest at 1.5% per month.</p>
              <p><strong>Selected Payment Method:</strong> ${state.paymentMethod ? state.paymentMethod.charAt(0).toUpperCase() + state.paymentMethod.slice(1) : 'Not selected'}</p>
              <div class="ack-line">
                <span>‚úì Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.paymentTerms || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 3: Timeline & Changes -->
            <div class="section">
              <h3>3. Timeline & Changes</h3>
              <p><strong>Project Timeline:</strong> Work shall commence within 30 days of receiving first payment and building permits. Estimated completion is 4-8 weeks from commencement, weather permitting.</p>
              <p><strong>Change Orders:</strong> Any modifications to the scope of work must be documented in writing and signed by both parties. Change orders may affect the Contract Sum and timeline.</p>
              <p><strong>Weather Delays:</strong> Contractor shall not be liable for delays caused by weather conditions, material shortages, or other circumstances beyond reasonable control.</p>
              <div class="ack-line">
                <span>‚úì Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.timeline || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 4: Responsibilities -->
            <div class="section">
              <h3>4. Responsibilities</h3>
              <p><strong>Contractor Responsibilities:</strong></p>
              <ul>
                <li>Provide all labor, materials, and equipment for metal building construction</li>
                <li>Obtain necessary building permits</li>
                <li>Maintain adequate insurance coverage</li>
                <li>Complete work in a professional, workmanlike manner</li>
              </ul>
              <p><strong>Owner Responsibilities:</strong></p>
              <ul>
                <li>Provide clear access to the construction site</li>
                <li>Ensure site is level and properly graded (unless concrete work is included)</li>
                <li>Make timely payments per the payment schedule</li>
                <li>Obtain any required easements or property approvals</li>
              </ul>
              <div class="ack-line">
                <span>‚úì Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.responsibilities || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 5: Warranties & Insurance -->
            <div class="section">
              <h3>5. Warranties & Insurance</h3>
              <p><strong>Workmanship Warranty:</strong> Contractor warrants all workmanship for a period of one (1) year from substantial completion.</p>
              <p><strong>Manufacturer Warranties:</strong> All manufacturer warranties on materials and components shall transfer to Owner.</p>
              <p><strong>Insurance:</strong> Contractor maintains general liability insurance and workers' compensation coverage. Owner is responsible for property insurance on the structure once construction begins.</p>
              <p><strong>Limitation:</strong> Warranties do not cover damage from acts of nature, misuse, or failure to maintain the structure properly.</p>
              <div class="ack-line">
                <span>‚úì Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.warranties || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 6: Legal Provisions -->
            <div class="section">
              <h3>6. Legal Provisions</h3>
              <p><strong>Governing Law:</strong> This Contract shall be governed by the laws of the State of Texas.</p>
              <p><strong>Dispute Resolution:</strong> Any disputes shall first be addressed through good-faith negotiation. If unresolved, disputes shall be settled through binding arbitration in the county where the project is located.</p>
              <p><strong>Entire Agreement:</strong> This Contract constitutes the entire agreement between parties and supersedes all prior negotiations and agreements.</p>
              <p><strong>Severability:</strong> If any provision is found invalid, the remaining provisions shall continue in full force.</p>
              <div class="ack-line">
                <span>‚úì Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.legalProvisions || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Signature Page -->
            <div class="signature-page">
              <h3 style="text-align: center; font-size: 18px; color: #003057; margin-bottom: 20px;">7. Final Acknowledgment & Signatures</h3>

              <p style="text-align: center; font-size: 11px; margin-bottom: 20px; color: #374151;">
                By signing below, both parties acknowledge that they have read and understand ALL sections of this Contract,
                have had the opportunity to consult with an attorney, agree to be bound by the terms and conditions herein,
                and that the Contractor has personally walked the Owner through every section.
              </p>

              <div class="sig-section">
                <h4>Owner Signature</h4>
                <div class="sig-box">
                  ${ownerSigData ? `<img src="${ownerSigData}" class="sig-img" alt="Owner Signature">` : '<span style="color: #9ca3af;">Signature</span>'}
                </div>
                <div class="sig-details">
                  <p><strong>Printed Name:</strong> ${state.ownerTypedName || '_______________________'}</p>
                  <p><strong>Date:</strong> ${today}</p>
                </div>
              </div>

              <div class="sig-section">
                <h4>Contractor Signature</h4>
                <div class="sig-box">
                  ${contractorSigData ? `<img src="${contractorSigData}" class="sig-img" alt="Contractor Signature">` : '<span style="color: #9ca3af;">Signature</span>'}
                </div>
                <div class="sig-details">
                  <p><strong>Printed Name:</strong> ${state.contractorTypedName || '_______________________'}</p>
                  <p><strong>Company:</strong> Burnett Customs, LLC</p>
                  <p><strong>Date:</strong> ${today}</p>
                </div>
              </div>

              <div class="final-section">
                <p style="font-size: 14px; font-weight: bold; color: #166534;">‚úÖ Contract Executed</p>
                <p style="font-size: 11px; color: #166534;">This contract was signed digitally via Burnett Metal Building Estimator on ${today}.</p>
              </div>
            </div>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printHTML);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    // Download full contract as HTML file
    function downloadContract() {
      const total = calculateTotal();
      const today = new Date().toLocaleDateString();
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Get initials data URLs
      const initialsData = {};
      ['projectOverview', 'paymentTerms', 'timeline', 'responsibilities', 'warranties', 'legalProvisions'].forEach(sectionId => {
        if (state.initialsData[sectionId]) {
          initialsData[sectionId] = state.initialsData[sectionId];
        } else {
          const canvas = document.getElementById('initials_' + sectionId);
          if (canvas) {
            initialsData[sectionId] = canvas.toDataURL('image/png');
          }
        }
      });

      // Get signature data
      const ownerSigData = state.ownerSigData || '';
      const contractorSigData = state.contractorSigData || '';

      // Build buildings list HTML
      const buildingsListHTML = state.buildings.map((building, index) => {
        const bType = BUILDING_TYPES[building.buildingType];
        const bSize = BUILDING_SIZES.find(s => s.id === building.buildingSize);
        const bEave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
        const bQty = building.qty || 1;
        const bUnitPrice = getBuildingUnitPrice(building);
        const bTotal = calculateBuildingTotal(building);
        return '<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e5e7eb;font-size:11px;"><strong style="color:#003057;">Building Config ' + (index + 1) + ' (Qty: ' + bQty + '):</strong> ' + bType.name + ' - ' + bSize.label + ' √ó ' + bEave.label + ' <span style="float:right;">' + formatCurrency(bTotal) + (bQty > 1 ? ' (' + bQty + ' √ó ' + formatCurrency(bUnitPrice) + ')' : '') + '</span></div>';
      }).join('');

      // Build contract HTML (same as print but self-contained)
      const contractHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Burnett Customs Contract - ${state.customer.name} - ${today.replace(/\\//g, '-')}</title>
          <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1f2937; line-height: 1.5; }
            .container { max-width: 800px; margin: 0 auto; padding: 30px; }
            .header { text-align: center; border-bottom: 3px solid #003057; padding-bottom: 20px; margin-bottom: 25px; }
            .header h1 { font-size: 28px; color: #003057; margin-bottom: 5px; }
            .header p { font-size: 12px; color: #6b7280; }
            .summary-box { background: #f9fafb; border: 2px solid #003057; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
            .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .summary-item { font-size: 12px; }
            .summary-item strong { display: block; color: #003057; margin-bottom: 2px; }
            .section { margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; page-break-inside: avoid; }
            .section h3 { font-size: 14px; color: #003057; border-bottom: 2px solid #05c3de; padding-bottom: 6px; margin-bottom: 12px; }
            .section p, .section li { font-size: 10px; line-height: 1.6; margin-bottom: 6px; color: #374151; }
            .section ul { margin-left: 20px; }
            .ack-line { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 10px; border-top: 1px dashed #9ca3af; font-size: 10px; }
            .initials-img { height: 35px; border: 1px solid #000; background: #fff; }
            .signature-page { margin-top: 30px; page-break-before: always; }
            .sig-section { margin-bottom: 30px; }
            .sig-section h4 { font-size: 14px; color: #003057; margin-bottom: 10px; }
            .sig-box { border: 1px solid #000; padding: 10px; margin-bottom: 5px; min-height: 70px; display: flex; align-items: center; justify-content: center; }
            .sig-img { max-height: 60px; max-width: 100%; }
            .sig-details { font-size: 10px; color: #6b7280; }
            .final-section { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; text-align: center; margin-top: 30px; }
            @media print { .section { page-break-inside: avoid; } .signature-page { page-break-before: always; } }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <svg viewBox="0 0 100 100" style="width: 60px; height: 60px; margin: 0 auto 10px;">
                <polygon points="50,2 93,27 93,73 50,98 7,73 7,27" fill="#003057" stroke="#003057" stroke-width="2"/>
                <polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#05c3de"/>
                <text x="30" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">B</text>
                <text x="52" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">C</text>
              </svg>
              <h1>BURNETT CUSTOMS</h1>
              <p>Metal Building Construction Agreement</p>
              <p>Contract Date: ${today}</p>
            </div>

            <div class="summary-box">
              <div class="summary-grid">
                <div class="summary-item"><strong>Total Buildings</strong>${totalBuildingQty} (${configCount} config${configCount !== 1 ? 's' : ''})</div>
                <div class="summary-item"><strong>Contract Sum</strong>${formatCurrency(total)}</div>
                <div class="summary-item"><strong>Owner</strong>${state.customer.name}<br>${state.customer.phone} | ${state.customer.email}</div>
                <div class="summary-item"><strong>Property Address</strong>${state.customer.propertySameAsMailing ? state.customer.address1 + (state.customer.address2 ? ', ' + state.customer.address2 : '') + '<br>' + state.customer.city + ', ' + state.customer.state + ' ' + state.customer.zip : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '') + '<br>' + state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip}</div>
              </div>
              ${buildingsListHTML}
            </div>

            <div class="section"><h3>1. Project Overview</h3><p><strong>Scope of Work:</strong> Contractor shall furnish all labor, materials, equipment, and services necessary to construct ${totalBuildingQty} metal building${totalBuildingQty !== 1 ? 's' : ''} at the property address specified above.</p><p><strong>Building Specifications:</strong> See building list above. Final specifications subject to engineering approval.</p><p><strong>Contract Sum:</strong> ${formatCurrency(total)}</p><div class="ack-line"><span>‚úì Owner acknowledges this section</span><span>Initials: <img src="${initialsData.projectOverview || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>2. Payment Terms</h3><p><strong>First Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon signing</p><p><strong>Second Draw (40%):</strong> ${formatCurrency(Math.round(total * 0.40))} - Due when materials arrive</p><p><strong>Final Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon completion</p><p><strong>Payment Method:</strong> ${state.paymentMethod ? state.paymentMethod.charAt(0).toUpperCase() + state.paymentMethod.slice(1) : 'Not selected'}</p><div class="ack-line"><span>‚úì Owner acknowledges this section</span><span>Initials: <img src="${initialsData.paymentTerms || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>3. Timeline & Changes</h3><p>Work shall commence within 30 days of first payment and permits. Estimated 4-8 weeks, weather permitting. Change orders must be in writing and signed by both parties.</p><div class="ack-line"><span>‚úì Owner acknowledges this section</span><span>Initials: <img src="${initialsData.timeline || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>4. Responsibilities</h3><p><strong>Contractor:</strong> Provide labor, materials, permits, insurance, professional work.</p><p><strong>Owner:</strong> Provide site access, level/graded site, timely payments, easements.</p><div class="ack-line"><span>‚úì Owner acknowledges this section</span><span>Initials: <img src="${initialsData.responsibilities || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>5. Warranties & Insurance</h3><p>1-year workmanship warranty. Manufacturer warranties transfer to Owner. Contractor maintains liability and workers' comp insurance.</p><div class="ack-line"><span>‚úì Owner acknowledges this section</span><span>Initials: <img src="${initialsData.warranties || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>6. Legal Provisions</h3><p>Governed by Texas law. Disputes via negotiation then binding arbitration. This is the entire agreement.</p><div class="ack-line"><span>‚úì Owner acknowledges this section</span><span>Initials: <img src="${initialsData.legalProvisions || ''}" class="initials-img"></span></div></div>

            <div class="signature-page">
              <h3 style="text-align:center;font-size:18px;color:#003057;margin-bottom:20px;">7. Final Acknowledgment & Signatures</h3>
              <p style="text-align:center;font-size:11px;margin-bottom:20px;">By signing below, both parties acknowledge they have read, understand, and agree to ALL terms.</p>
              <div class="sig-section"><h4>Owner Signature</h4><div class="sig-box">${ownerSigData ? '<img src="' + ownerSigData + '" class="sig-img">' : ''}</div><div class="sig-details"><p><strong>Printed Name:</strong> ${state.ownerTypedName}</p><p><strong>Date:</strong> ${today}</p></div></div>
              <div class="sig-section"><h4>Contractor Signature</h4><div class="sig-box">${contractorSigData ? '<img src="' + contractorSigData + '" class="sig-img">' : ''}</div><div class="sig-details"><p><strong>Printed Name:</strong> ${state.contractorTypedName}</p><p><strong>Company:</strong> Burnett Customs, LLC</p><p><strong>Date:</strong> ${today}</p></div></div>
              <div class="final-section"><p style="font-size:14px;font-weight:bold;color:#166534;">‚úÖ Contract Executed</p><p style="font-size:11px;color:#166534;">Signed digitally on ${today}</p></div>
            </div>
          </div>
        </body>
        </html>
      `;

      // Create download link
      const blob = new Blob([contractHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Burnett_Contract_' + state.customer.name.replace(/\\s+/g, '_') + '_' + today.replace(/\\//g, '-') + '.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize initials pads when contract sections load
    function initCurrentSectionPads() {
      const section = CONTRACT_SECTIONS[state.contractStep];
      if (section && section.requiresAck) {
        setTimeout(() => {
          const initialsCanvas = document.getElementById('initials_' + section.id);
          if (initialsCanvas && !initialsPads[section.id]) {
            initialsPads[section.id] = new SignaturePad(initialsCanvas, (signed) => {
              state.sections[section.id].initialed = signed;
              initialsCanvas.classList.toggle('signed', signed);
              updateNavigationState();
            }, true);
          }
        }, 100);
      }
    }

    // Override render to initialize pads
    const originalRender = render;
    render = function() {
      originalRender();
      if (state.step >= 6) {
        initCurrentSectionPads();
        if (CONTRACT_SECTIONS[state.contractStep].id === 'signatures') {
          setTimeout(initSignaturePads, 100);
        }
      }
    };

    // Initial render
    render();
  </script>
</body>
</html>
