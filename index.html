<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gryphon FrameWorks - Metal Building Estimator</title>

  <!-- Open Graph / Social Media Preview -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://mingagent.github.io/gryphon-frameworks/">
  <meta property="og:title" content="Gryphon FrameWorks - Metal Building Estimator">
  <meta property="og:description" content="Design your custom metal building and get an instant estimate. Pole barns, carports, and bolt-up construction.">
  <meta property="og:image" content="https://mingagent.github.io/gryphon-frameworks/preview.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Gryphon FrameWorks - Metal Building Estimator">
  <meta name="twitter:description" content="Design your custom metal building and get an instant estimate.">
  <meta name="twitter:image" content="https://mingagent.github.io/gryphon-frameworks/preview.png">

  <!-- General Meta -->
  <meta name="description" content="Design your custom metal building and get an instant estimate. Pole barns, carports, and bolt-up construction from Gryphon FrameWorks.">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    /* ==================== BRAND COLORS ====================
       Primary:   Dark Azure #003057, Vivid Azure #05c3de
       Secondary: Bright Cyan #04ceea
       Background: White page, Dark cards
    ========================================================= */
    :root {
      --primary-dark: #003057;
      --primary-vivid: #05c3de;
      --primary-bright: #04ceea;
      --accent-green: #22c55e;
      --secondary-darkest: #01315b;
      --bg-page: #ffffff;
      --bg-card: #003057;
      --text-on-card: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-page);
    }

    .signature-pad {
      border: 2px dashed #9ca3af;
      border-radius: 8px;
      background: var(--bg-white);
      touch-action: none;
      cursor: crosshair;
    }
    .signature-pad.signed { border-color: var(--primary-vivid); border-style: solid; }

    .initials-pad {
      border: 2px dashed #9ca3af;
      border-radius: 8px;
      background: var(--bg-white);
      touch-action: none;
      cursor: crosshair;
      display: block;
      width: 100%;
      max-width: 200px;
      height: 70px;
    }
    .initials-pad.signed { border-color: var(--primary-vivid); border-style: solid; }

    .initials-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: #f0f9ff;
      border-radius: 8px;
      margin-top: 8px;
    }

    @media (max-width: 640px) {
      .initials-pad {
        max-width: 100%;
        height: 80px;
      }
      .initials-container {
        padding: 20px 16px;
      }
    }

    .progress-step {
      width: 28px; height: 28px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 11px;
      transition: all 0.3s;
      flex-shrink: 0;
      cursor: pointer;
    }
    .progress-step.completed { background: var(--primary-vivid); color: #ffffff; }
    .progress-step.completed:hover { background: var(--primary-bright); transform: scale(1.15); box-shadow: 0 0 10px rgba(4, 206, 234, 0.5); }
    .progress-step.current { background: var(--primary-dark); color: #ffffff; transform: scale(1.1); }
    .progress-step.current:hover { box-shadow: 0 0 10px rgba(0, 48, 87, 0.5); }
    .progress-step.pending { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
    .progress-step.clickable:hover { background: #d1d5db; color: #6b7280; cursor: pointer; }

    .contract-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .legal-text {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .section-ack {
      background: #e0f7fa;
      border: 2px solid var(--primary-vivid);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .section-ack.complete {
      background: #e0f7fa;
      border-color: var(--primary-dark);
    }

    .btn-primary {
      background: var(--primary-dark);
      color: #ffffff !important;
      transition: background 0.2s;
    }
    .btn-primary:hover { background: var(--secondary-darkest); color: #ffffff !important; }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; color: #ffffff !important; }

    .btn-secondary {
      background: var(--primary-vivid);
      color: #003057 !important;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: #04b5cc; color: #003057 !important; }

    .btn-active {
      background: var(--primary-bright);
      color: #003057 !important;
      font-weight: 700;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(4, 206, 234, 0.4);
    }
    .btn-active:hover { background: #03b8d4; transform: translateY(-1px); color: #003057 !important; }

    .header-bar {
      background: var(--primary-bright);
      color: var(--primary-dark);
    }

    .type-card {
      background: var(--bg-card);
      color: var(--text-on-card);
      border: 3px solid var(--primary-vivid);
      transition: all 0.2s;
      cursor: pointer;
    }
    .type-card:hover {
      background: var(--primary-bright);
      color: #003057 !important;
      border-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(4, 206, 234, 0.4);
    }
    .type-card:hover * { color: #003057 !important; }
    .type-card.selected {
      border: 4px solid #00ffff;
      background: var(--secondary-darkest);
      color: var(--text-on-card);
      box-shadow: 0 0 15px rgba(4, 206, 234, 0.8), 0 0 30px rgba(4, 206, 234, 0.5), 0 0 45px rgba(4, 206, 234, 0.3), inset 0 0 20px rgba(4, 206, 234, 0.1);
      transform: scale(1.02);
    }
    .type-card.selected * { color: #ffffff !important; }
    .type-card.selected h3, .type-card.selected .text-\\[\\#05c3de\\] { color: #05c3de !important; }

    .size-card {
      background: var(--bg-card);
      color: var(--text-on-card);
      border: 2px solid var(--primary-vivid);
      transition: all 0.2s;
      cursor: pointer;
    }
    .size-card:hover {
      background: var(--primary-bright);
      color: #003057 !important;
      border-color: var(--primary-dark);
      box-shadow: 0 4px 15px rgba(4, 206, 234, 0.4);
    }
    .size-card:hover * { color: #003057 !important; }
    .size-card.selected {
      border: 4px solid #00ffff;
      background: var(--secondary-darkest);
      color: var(--text-on-card);
      box-shadow: 0 0 12px rgba(4, 206, 234, 0.8), 0 0 25px rgba(4, 206, 234, 0.5), 0 0 40px rgba(4, 206, 234, 0.3), inset 0 0 15px rgba(4, 206, 234, 0.1);
      transform: scale(1.03);
    }
    .size-card.selected * { color: #ffffff !important; }
    .size-card.selected .text-\\[\\#05c3de\\] { color: #05c3de !important; }

    .eave-btn {
      background: var(--bg-card);
      color: var(--text-on-card);
      border: 2px solid var(--primary-vivid);
      transition: all 0.2s;
    }
    .eave-btn:hover {
      background: var(--primary-bright);
      color: #003057 !important;
      border-color: var(--primary-dark);
    }
    .eave-btn:hover * { color: #003057 !important; }
    .eave-btn.selected {
      border: 3px solid #00ffff;
      background: var(--primary-bright);
      color: #003057 !important;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(4, 206, 234, 0.8), 0 0 20px rgba(4, 206, 234, 0.5);
    }
    .eave-btn.selected * { color: #003057 !important; }

    @media print {
      body { font-size: 9pt; line-height: 1.3; }
      .no-print { display: none !important; }
      .signature-pad, .initials-pad { border: 1px solid var(--bg-black) !important; }
    }

    /* Print contract styles */
    .print-contract-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #1f2937;
    }
    .print-header {
      text-align: center;
      border-bottom: 3px solid #003057;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .print-header h1 {
      font-size: 28px;
      color: #003057;
      margin: 0 0 10px 0;
    }
    .print-header p {
      font-size: 14px;
      color: #6b7280;
      margin: 5px 0;
    }
    .print-section {
      page-break-inside: avoid;
      margin-bottom: 25px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
    }
    .print-section h3 {
      font-size: 16px;
      color: #003057;
      border-bottom: 2px solid #05c3de;
      padding-bottom: 8px;
      margin: 0 0 15px 0;
    }
    .print-section p, .print-section li {
      font-size: 11px;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .print-initials-box {
      display: inline-block;
      border: 1px solid #000;
      width: 80px;
      height: 30px;
      margin-left: 10px;
      vertical-align: middle;
    }
    .print-signature-section {
      page-break-before: always;
      margin-top: 40px;
    }
    .print-signature-box {
      border: 1px solid #000;
      height: 60px;
      margin: 10px 0;
    }
    .print-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    .print-summary-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
    }
    .print-summary-table td:first-child {
      font-weight: 600;
      width: 40%;
    }
    .print-ack-line {
      font-size: 10px;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px dashed #9ca3af;
    }

    /* Building Profile Door Interactivity */
    .door-element {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .door-element:hover rect {
      filter: brightness(1.2);
      stroke-width: 3;
    }
    .door-element:hover {
      filter: drop-shadow(0 0 6px rgba(5, 195, 222, 0.8));
    }
    .door-element.selected rect {
      stroke: #05c3de;
      stroke-width: 4;
      filter: drop-shadow(0 0 8px rgba(5, 195, 222, 1));
    }

    /* Tooltip for doors */
    .door-tooltip {
      position: absolute;
      background: #003057;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .door-tooltip::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #003057;
    }

    /* Door list item highlighting */
    .door-list-item {
      transition: all 0.2s ease;
    }
    .door-list-item.highlighted {
      background: #e0f7fa !important;
      border-color: #05c3de !important;
      box-shadow: 0 0 0 2px rgba(5, 195, 222, 0.4);
    }

    /* Door entrance animation */
    @keyframes doorFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .door-element {
      animation: doorFadeIn 0.3s ease-out forwards;
    }
    .door-element.dragging {
      cursor: grabbing !important;
      filter: drop-shadow(0 4px 12px rgba(5, 195, 222, 0.8));
    }
    .door-element.dragging rect {
      stroke: #05c3de;
      stroke-width: 4;
    }

    /* Tooltip animation */
    @keyframes tooltipFadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .door-tooltip {
      animation: tooltipFadeIn 0.15s ease-out forwards;
    }

    /* Building profile container */
    .building-profile-container {
      background: linear-gradient(to bottom, #f0f9ff, #e0f2fe);
      border-radius: 12px;
      padding: 16px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body class="bg-white min-h-screen">
  <div id="app"></div>

  <script>
    // ==================== EMAILJS CONFIG ====================
    const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
    const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
    const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

    if (EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
      emailjs.init(EMAILJS_PUBLIC_KEY);
    }

    // ==================== APP STATE ====================
    const state = {
      // Estimator flow
      step: 0, // 0=type, 1=size, 2=eave, 3=doors, 4=addons, 5=summary, 6+=contract

      // Multiple buildings support
      buildings: [],  // Array of building configs
      currentBuildingIndex: 0,  // Which building we're editing

      // Current building being configured (will be pushed to buildings array)
      buildingType: null, // 'poleBarn', 'carport', 'boltUp'
      buildingSize: null,
      eaveHeight: null,

      // Door configuration (301 walkthrough is STANDARD - always 1 included)
      doors: {
        overhead: [], // Array of {size: '12x12', type: 'rollup', placement: 'gabled'}
        walkthrough301: 1, // Standard - always 1 included (additional can be purchased)
        extraWalkthrough: 0 // Additional walk-through doors beyond the standard 1
      },

      // Door positions on building profile (for drag & drop)
      // Keys: "{doorId}-{view}" e.g., "overhead-0-front"
      doorPositions: {},

      // Building profile view (front, back, left, right)
      buildingView: 'front',

      // Breezeway options (auto-center doors on walls)
      breezeway: {
        frontBack: false,  // Center doors on front and back walls
        sideSide: false    // Center doors on left and right walls
      },

      // Color selections
      colors: {
        wallPanels: 'white',
        roofPanels: 'white',
        trim: 'white',
        insulation: 'white'
      },

      // Add-ons
      addons: {},

      // Bolt-Up custom quote (when type is boltUp)
      boltUpSpecs: {
        customSize: '',
        customEave: '',
        doorPrefs: '',
        addOnPrefs: '',
        specialReqs: ''
      },

      // Contract signing flow (starts at step 6)
      contractStep: 0,

      // Customer info
      customer: {
        name: '',
        phone: '',
        email: '',
        address1: '',
        address2: '',
        city: '',
        state: 'TX',
        zip: '',
        propertySameAsMailing: false,
        propertyAddress1: '',
        propertyAddress2: '',
        propertyCity: '',
        propertyState: 'TX',
        propertyZip: ''
      },

      // 7 Contract sections acknowledgments
      sections: {
        projectOverview: { checked: false, initialed: false },
        paymentTerms: { checked: false, initialed: false },
        timeline: { checked: false, initialed: false },
        responsibilities: { checked: false, initialed: false },
        warranties: { checked: false, initialed: false },
        legalProvisions: { checked: false, initialed: false }
      },

      // Signatures
      ownerTypedName: '',
      ownerSigned: false,
      ownerSigData: null,  // Store signature image data
      contractorTypedName: 'Gryphon FrameWorks',
      contractorSigned: false,
      contractorSigData: null,  // Store signature image data
      initialsData: {},  // Store initials image data by section ID

      // Payment
      paymentMethod: null,
      paymentReference: '',

      // Sending
      sending: false,
      sent: false,
      sendError: null
    };

    // Store initials pads
    const initialsPads = {};

    // ==================== LOGO SVG ====================
    // Gryphon FrameWorks - Architectural Pillars Logo
    const LOGO_SVG = `
      <svg viewBox="0 0 200 100" class="h-12" style="width: auto;">
        <!-- Three Architectural Pillars -->
        <g id="pillars">
          <!-- Left Pillar -->
          <rect x="20" y="20" width="16" height="60" fill="#003057"/>
          <rect x="18" y="15" width="20" height="8" fill="#05c3de"/>
          <rect x="18" y="77" width="20" height="8" fill="#05c3de"/>
          <!-- Center Pillar (taller) -->
          <rect x="44" y="10" width="20" height="70" fill="#003057"/>
          <rect x="42" y="5" width="24" height="8" fill="#05c3de"/>
          <rect x="42" y="77" width="24" height="8" fill="#05c3de"/>
          <!-- Right Pillar -->
          <rect x="72" y="20" width="16" height="60" fill="#003057"/>
          <rect x="70" y="15" width="20" height="8" fill="#05c3de"/>
          <rect x="70" y="77" width="20" height="8" fill="#05c3de"/>
          <!-- Connecting Base -->
          <rect x="15" y="85" width="80" height="5" fill="#003057"/>
        </g>
        <!-- GRYPHON Text -->
        <text x="105" y="45" font-family="Arial, Helvetica, sans-serif" font-size="26" font-weight="900" fill="#003057" letter-spacing="2">GRYPHON</text>
        <!-- FRAMEWORKS Text -->
        <text x="105" y="70" font-family="Arial, Helvetica, sans-serif" font-size="14" font-weight="600" fill="#05c3de" letter-spacing="4">FRAMEWORKS</text>
      </svg>
    `;

    const LOGO_SVG_SMALL = `
      <svg viewBox="0 0 180 80" class="h-8" style="width: auto;">
        <!-- Three Architectural Pillars (compact) -->
        <g id="pillars-small">
          <!-- Left Pillar -->
          <rect x="8" y="16" width="10" height="44" fill="#003057"/>
          <rect x="6" y="12" width="14" height="5" fill="#05c3de"/>
          <rect x="6" y="58" width="14" height="5" fill="#05c3de"/>
          <!-- Center Pillar (taller) -->
          <rect x="24" y="8" width="12" height="52" fill="#003057"/>
          <rect x="22" y="4" width="16" height="5" fill="#05c3de"/>
          <rect x="22" y="58" width="16" height="5" fill="#05c3de"/>
          <!-- Right Pillar -->
          <rect x="42" y="16" width="10" height="44" fill="#003057"/>
          <rect x="40" y="12" width="14" height="5" fill="#05c3de"/>
          <rect x="40" y="58" width="14" height="5" fill="#05c3de"/>
          <!-- Connecting Base -->
          <rect x="4" y="63" width="54" height="4" fill="#003057"/>
        </g>
        <!-- GRYPHON Text -->
        <text x="65" y="38" font-family="Arial, Helvetica, sans-serif" font-size="20" font-weight="900" fill="#003057" letter-spacing="1">GRYPHON</text>
        <!-- FRAMEWORKS Text -->
        <text x="65" y="56" font-family="Arial, Helvetica, sans-serif" font-size="10" font-weight="600" fill="#05c3de" letter-spacing="3">FRAMEWORKS</text>
      </svg>
    `;

    // ==================== SVG ICONS (No Emojis) ====================

    // Building Type Icons - Professional architectural SVGs
    const ICON_POLE_BARN = `<svg viewBox="0 0 48 48" class="w-12 h-12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="8" y="20" width="4" height="22" fill="#05c3de"/>
      <rect x="36" y="20" width="4" height="22" fill="#05c3de"/>
      <rect x="20" y="24" width="8" height="18" fill="#003057" stroke="#05c3de" stroke-width="1"/>
      <path d="M6 22 L24 8 L42 22" stroke="#05c3de" stroke-width="3" fill="none"/>
      <path d="M10 20 L24 10 L38 20" fill="#003057"/>
      <line x1="24" y1="10" x2="24" y2="20" stroke="#05c3de" stroke-width="2"/>
    </svg>`;

    const ICON_CARPORT = `<svg viewBox="0 0 48 48" class="w-12 h-12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="6" y="18" width="4" height="24" fill="#05c3de"/>
      <rect x="38" y="18" width="4" height="24" fill="#05c3de"/>
      <path d="M4 20 L24 8 L44 20" stroke="#05c3de" stroke-width="3" fill="none"/>
      <path d="M8 18 L24 9 L40 18" fill="#003057"/>
      <ellipse cx="16" cy="38" rx="5" ry="5" fill="#003057" stroke="#05c3de" stroke-width="1.5"/>
      <ellipse cx="32" cy="38" rx="5" ry="5" fill="#003057" stroke="#05c3de" stroke-width="1.5"/>
      <rect x="12" y="32" width="24" height="6" rx="2" fill="#003057"/>
      <rect x="10" y="34" width="8" height="3" fill="#05c3de"/>
      <rect x="30" y="34" width="8" height="3" fill="#05c3de"/>
    </svg>`;

    const ICON_BOLT_UP = `<svg viewBox="0 0 48 48" class="w-12 h-12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="8" y="14" width="32" height="28" fill="#003057" stroke="#05c3de" stroke-width="2"/>
      <rect x="12" y="18" width="8" height="8" fill="#05c3de" opacity="0.6"/>
      <rect x="28" y="18" width="8" height="8" fill="#05c3de" opacity="0.6"/>
      <rect x="18" y="30" width="12" height="12" fill="#05c3de"/>
      <line x1="24" y1="30" x2="24" y2="42" stroke="#003057" stroke-width="1"/>
      <circle cx="12" cy="18" r="1.5" fill="#05c3de"/>
      <circle cx="36" cy="18" r="1.5" fill="#05c3de"/>
      <circle cx="12" cy="38" r="1.5" fill="#05c3de"/>
      <circle cx="36" cy="38" r="1.5" fill="#05c3de"/>
      <rect x="6" y="10" width="36" height="4" fill="#05c3de"/>
    </svg>`;

    // Warning/Alert Icon
    const ICON_WARNING = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 2 L18 16 L2 16 Z" fill="#f97316" stroke="#ea580c" stroke-width="1"/>
      <line x1="10" y1="7" x2="10" y2="11" stroke="white" stroke-width="2" stroke-linecap="round"/>
      <circle cx="10" cy="13.5" r="1" fill="white"/>
    </svg>`;

    // Contract Section Icons
    const ICON_USER = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><circle cx="12" cy="8" r="4"/><path d="M12 14c-5 0-8 2.5-8 5v1h16v-1c0-2.5-3-5-8-5z"/></svg>`;
    const ICON_BOOK = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><path d="M4 4h6c1.1 0 2 .9 2 2v14l-1-1H4V4zm16 0h-6c-1.1 0-2 .9-2 2v14l1-1h7V4z"/></svg>`;
    const ICON_MONEY = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><circle cx="12" cy="12" r="10" fill="none" stroke="#003057" stroke-width="2"/><path d="M12 6v12M9 9c0-1.5 1.5-2 3-2s3 .5 3 2-1.5 2-3 2-3 .5-3 2 1.5 2 3 2 3-.5 3-2"/></svg>`;
    const ICON_CALENDAR = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><rect x="3" y="4" width="18" height="18" rx="2" fill="none" stroke="#003057" stroke-width="2"/><line x1="3" y1="10" x2="21" y2="10" stroke="#003057" stroke-width="2"/><line x1="8" y1="2" x2="8" y2="6" stroke="#003057" stroke-width="2"/><line x1="16" y1="2" x2="16" y2="6" stroke="#003057" stroke-width="2"/></svg>`;
    const ICON_WRENCH = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9l-4.3-4.3c-1.1 2.4-.7 5.4 1.3 7.4 1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.4-.4.4-1 0-1.4z"/></svg>`;
    const ICON_SHIELD = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><path d="M12 2L4 6v6c0 5.5 3.4 10.3 8 12 4.6-1.7 8-6.5 8-12V6l-8-4z"/></svg>`;
    const ICON_SCALE = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><path d="M12 3v18M5 8l7-3 7 3M5 8v4c0 1.7 2 3 4 3h6c2 0 4-1.3 4-3V8"/><circle cx="5" cy="8" r="2"/><circle cx="19" cy="8" r="2"/></svg>`;
    const ICON_PEN = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
    const ICON_CHECK = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="#16a34a"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg>`;
    const ICON_CHECK_CIRCLE = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#16a34a"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" fill="none"/></svg>`;
    const ICON_CONSTRUCTION = `<svg viewBox="0 0 48 48" class="w-12 h-12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="8" y="32" width="32" height="4" fill="#05c3de"/>
      <rect x="12" y="20" width="4" height="12" fill="#003057"/>
      <rect x="32" y="20" width="4" height="12" fill="#003057"/>
      <path d="M10 22 L24 12 L38 22" stroke="#05c3de" stroke-width="3" fill="none"/>
      <rect x="20" y="24" width="8" height="8" fill="#05c3de" opacity="0.7"/>
    </svg>`;

    // Additional UI Icons
    const ICON_DOWNLOAD = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path d="M10 3a1 1 0 011 1v8.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V4a1 1 0 011-1z"/><path d="M3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/></svg>`;
    const ICON_CLIPBOARD = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/></svg>`;
    const ICON_PRINT = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"/></svg>`;
    const ICON_DOOR = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><rect x="5" y="2" width="14" height="20" rx="1" stroke="#003057" stroke-width="2" fill="none"/><circle cx="16" cy="12" r="1.5" fill="#003057"/></svg>`;

    // Simple checkmark for inline text (non-emoji)
    const CHECK_MARK = `<svg viewBox="0 0 12 12" class="w-3 h-3 inline-block" fill="currentColor"><path d="M10 3L4.5 8.5 2 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    const CHECK_MARK_GREEN = `<svg viewBox="0 0 12 12" class="w-3 h-3 inline-block" fill="#16a34a"><path d="M10 3L4.5 8.5 2 6" stroke="#16a34a" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

    // Additional Action Icons
    const ICON_EMAIL = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>`;
    const ICON_ROLLUP = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><rect x="4" y="4" width="16" height="16" rx="1" stroke="#05c3de" stroke-width="2" fill="none"/><line x1="4" y1="8" x2="20" y2="8" stroke="#05c3de" stroke-width="1.5"/><line x1="4" y1="12" x2="20" y2="12" stroke="#05c3de" stroke-width="1.5"/><line x1="4" y1="16" x2="20" y2="16" stroke="#05c3de" stroke-width="1.5"/><path d="M12 4v-2M12 22v-2" stroke="#003057" stroke-width="2"/></svg>`;
    const ICON_SECTIONAL = `<svg viewBox="0 0 24 24" class="w-6 h-6 inline-block" fill="#003057"><rect x="4" y="4" width="16" height="16" rx="1" stroke="#05c3de" stroke-width="2" fill="none"/><rect x="6" y="6" width="5" height="5" fill="#05c3de" opacity="0.5"/><rect x="13" y="6" width="5" height="5" fill="#05c3de" opacity="0.5"/><rect x="6" y="13" width="5" height="5" fill="#05c3de" opacity="0.5"/><rect x="13" y="13" width="5" height="5" fill="#05c3de" opacity="0.5"/></svg>`;
    const ICON_EDIT = `<svg viewBox="0 0 20 20" class="w-4 h-4 inline-block" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/></svg>`;
    const ICON_TRASH = `<svg viewBox="0 0 20 20" class="w-4 h-4 inline-block" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>`;
    const ICON_PLUS = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>`;
    const ICON_LOCATION = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/></svg>`;
    const ICON_CREDIT_CARD = `<svg viewBox="0 0 20 20" class="w-5 h-5 inline-block" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/></svg>`;

    // ==================== DATA ====================

    // Building Types
    const BUILDING_TYPES = {
      poleBarn: {
        name: 'Pole Barn',
        desc: 'Weld-Up Construction',
        color: '#003057',
        icon: ICON_POLE_BARN,
        hasFixedPricing: true
      },
      carport: {
        name: 'Carport',
        desc: 'Covered Structure',
        color: '#22c55e',
        icon: ICON_CARPORT,
        hasFixedPricing: true
      },
      boltUp: {
        name: 'Bolt-Up Construction',
        desc: 'Engineered Steel Building',
        color: '#05c3de',
        icon: ICON_BOLT_UP,
        hasFixedPricing: false,
        note: 'Custom Quote Required'
      }
    };

    // 10 Building Sizes with "Starting at" prices
    const BUILDING_SIZES = [
      { id: '30x40', label: "30' × 40'", sqft: 1200, startingPrice: 26500 },
      { id: '30x50', label: "30' × 50'", sqft: 1500, startingPrice: 31000 },
      { id: '40x40', label: "40' × 40'", sqft: 1600, startingPrice: 33000 },
      { id: '40x50', label: "40' × 50'", sqft: 2000, startingPrice: 39000 },
      { id: '40x60', label: "40' × 60'", sqft: 2400, startingPrice: 45000 },
      { id: '50x50', label: "50' × 50'", sqft: 2500, startingPrice: 47000 },
      { id: '50x60', label: "50' × 60'", sqft: 3000, startingPrice: 54000 },
      { id: '50x80', label: "50' × 80'", sqft: 4000, startingPrice: 68000 },
      { id: '60x60', label: "60' × 60'", sqft: 3600, startingPrice: 62000 },
      { id: '60x100', label: "60' × 100'", sqft: 6000, startingPrice: 95000 }
    ];

    // 5 Eave Heights
    const EAVE_HEIGHTS = [
      { id: '10', label: "10 ft", modifier: 0 },
      { id: '12', label: "12 ft", modifier: 1500 },
      { id: '14', label: "14 ft", modifier: 3500 },
      { id: '16', label: "16 ft", modifier: 6000 },
      { id: '20', label: "20 ft", modifier: 12000 }
    ];

    // ==================== ADMIN CONFIGURABLE PRICING ====================
    // These can be adjusted by admin without touching main logic
    const ADMIN_CONFIG = {
      // Gutter pricing (default $10/LF - industry range $8-15/LF installed)
      gutterPricePerLF: 10,
      gutterPriceWarningMin: 8,   // Warn if set below industry low
      gutterPriceWarningMax: 15,  // Warn if set above industry high

      // Gutter calculation modes
      gutterModes: {
        both_eaves: { label: 'Both Eaves (Typical Gable)', formula: 'length * 2' },
        perimeter: { label: 'Full Perimeter', formula: '(length + width) * 2' }
      },
      defaultGutterMode: 'both_eaves',

      // Downspout spacing (one every X feet)
      downspoutSpacingFt: 25,

      // Door constraints
      doorHeightClearance: 2,  // Door height must be this many feet less than eave
      maxDoorWidth: 14,
      maxDoorHeight: 14
    };

    // Door Height Options (discrete values per Bobby's specs)
    const DOOR_HEIGHTS = [
      { id: '8', value: 8, label: "8 ft" },
      { id: '10', value: 10, label: "10 ft" },
      { id: '12', value: 12, label: "12 ft" },
      { id: '14', value: 14, label: "14 ft" }
    ];

    // Door Width Options (discrete values)
    const DOOR_WIDTHS = [
      { id: '8', value: 8, label: "8 ft" },
      { id: '10', value: 10, label: "10 ft" },
      { id: '12', value: 12, label: "12 ft" },
      { id: '14', value: 14, label: "14 ft" }
    ];

    // Door Pricing Matrix (height x width = price)
    // Prices increase with size; base price ~$1,800 for 8x8
    const DOOR_PRICE_MATRIX = {
      '8x8': 1890, '8x10': 2090, '8x12': 2290, '8x14': 2490,
      '10x8': 2090, '10x10': 2290, '10x12': 2590, '10x14': 2890,
      '12x8': 2290, '12x10': 2490, '12x12': 2890, '12x14': 3190,
      '14x8': 2490, '14x10': 2790, '14x12': 3190, '14x14': 3490
    };

    // Calculate gutter linear footage based on building geometry
    function calculateGutterLF(buildingSize, mode = ADMIN_CONFIG.defaultGutterMode) {
      const size = BUILDING_SIZES.find(s => s.id === buildingSize);
      if (!size) return 0;

      const dims = size.label.replace(/'/g, '').split(' × ');
      const width = parseInt(dims[0]);
      const length = parseInt(dims[1]);

      switch (mode) {
        case 'both_eaves':
          return length * 2;  // Both eave sides (typical for gable roof)
        case 'perimeter':
          return (length + width) * 2;  // All four sides
        default:
          return length * 2;
      }
    }

    // Calculate gutter price based on LF
    function calculateGutterPrice(buildingSize, mode = ADMIN_CONFIG.defaultGutterMode) {
      const lf = calculateGutterLF(buildingSize, mode);
      return lf * ADMIN_CONFIG.gutterPricePerLF;
    }

    // Get eligible door heights based on eave height (must be 2ft less)
    function getEligibleDoorHeights(eaveHeight) {
      const maxHeight = parseInt(eaveHeight) - ADMIN_CONFIG.doorHeightClearance;
      return DOOR_HEIGHTS.filter(h => h.value <= maxHeight);
    }

    // Get door price from matrix
    function getDoorPrice(height, width) {
      const key = `${height}x${width}`;
      return DOOR_PRICE_MATRIX[key] || 0;
    }

    // Color Options (from Bobby+Josh discussion)
    const COLOR_OPTIONS = {
      panels: [
        { id: 'white', name: 'White', hex: '#ffffff' },
        { id: 'black', name: 'Black', hex: '#1a1a1a' },
        { id: 'charcoal', name: 'Charcoal', hex: '#36454f' },
        { id: 'gray', name: 'Gray', hex: '#808080' },
        { id: 'tan', name: 'Tan', hex: '#d2b48c' },
        { id: 'brown', name: 'Brown', hex: '#654321' },
        { id: 'red', name: 'Barn Red', hex: '#7c0a02' },
        { id: 'green', name: 'Hunter Green', hex: '#355e3b' },
        { id: 'galvalume', name: 'Galvalume (unpainted)', hex: '#b8b8b8' }
      ],
      trim: [
        { id: 'white', name: 'White', hex: '#ffffff' },
        { id: 'black', name: 'Black', hex: '#1a1a1a' },
        { id: 'charcoal', name: 'Charcoal', hex: '#36454f' },
        { id: 'tan', name: 'Tan', hex: '#d2b48c' },
        { id: 'brown', name: 'Brown', hex: '#654321' }
      ],
      insulation: [
        { id: 'white', name: 'White', hex: '#f5f5f5' },
        { id: 'black', name: 'Black', hex: '#2d2d2d' }
      ]
    };

    // Door Size Options (per Bobby: 8, 10, 12, 14 - max 14x14)
    const DOOR_SIZES = [
      { id: '8x8', width: 8, height: 8, label: "8' × 8'", price: 1890 },
      { id: '10x10', width: 10, height: 10, label: "10' × 10'", price: 2290 },
      { id: '12x12', width: 12, height: 12, label: "12' × 12'", price: 2890 },
      { id: '14x14', width: 14, height: 14, label: "14' × 14'", price: 3490 },
      { id: '10x8', width: 10, height: 8, label: "10' × 8'", price: 2090 },
      { id: '12x10', width: 12, height: 10, label: "12' × 10'", price: 2490 },
      { id: '14x12', width: 14, height: 12, label: "14' × 12'", price: 3190 }
    ];

    // Door Types
    const DOOR_TYPES = [
      { id: 'rollup', name: 'Roll-Up Door', desc: 'Coils overhead, saves space' },
      { id: 'sectional', name: 'Sectional Door', desc: 'Slides up in sections, quieter operation' }
    ];

    // Add-ons per specification (NOTE: 301 walkthrough door is NOW STANDARD - included in base price)
    const ADDONS = [
      { cat: 'Windows', items: [
        { id: 'win_3x3', name: "3'×3' Fixed Window", price: 525, hasQty: true, maxQty: 10 },
        { id: 'win_4x4', name: "4'×4' Slider Window", price: 695, hasQty: true, maxQty: 10 }
      ]},
      { cat: 'Insulation', items: [
        { id: 'wall_insulation', name: "Wall Insulation", price: 2500 },
        { id: 'roof_insulation', name: "Roof Insulation", price: 2000 }
      ]},
      { cat: 'Options', items: [
        { id: 'gutters', name: "Gutters & Downspouts", price: 0, perLF: true, note: 'Auto-calculated from roof length' },
        { id: 'wainscot', name: "Wainscot Siding (3' tall)", price: 1200, hasQty: true, maxQty: 4, note: 'Per wall' },
        { id: 'concrete_slab', name: "Concrete Slab (4\" w/ rebar)", price: 0, perSqFt: 8, note: 'Price based on building size' }
      ]},
      { cat: 'Additional Doors', items: [
        { id: 'extra_walkthrough', name: "Additional 3070 Walk-through Door", price: 1045, hasQty: true, maxQty: 4, note: '1 included standard' }
      ]}
    ];

    // 7 Contract sections (consolidated from 19)
    const CONTRACT_SECTIONS = [
      { id: 'info', title: 'Customer Information', icon: ICON_USER, requiresAck: false },
      { id: 'projectOverview', title: '1. Project Overview', icon: ICON_BOOK, requiresAck: true },
      { id: 'paymentTerms', title: '2. Payment Terms', icon: ICON_MONEY, requiresAck: true },
      { id: 'timeline', title: '3. Timeline & Changes', icon: ICON_CALENDAR, requiresAck: true },
      { id: 'responsibilities', title: '4. Responsibilities', icon: ICON_WRENCH, requiresAck: true },
      { id: 'warranties', title: '5. Warranties & Insurance', icon: ICON_SHIELD, requiresAck: true },
      { id: 'legalProvisions', title: '6. Legal Provisions', icon: ICON_SCALE, requiresAck: true },
      { id: 'signatures', title: '7. Final Acknowledgment', icon: ICON_PEN, requiresAck: false }
    ];

    // Bill of Materials generator
    function generateBOM(building, index) {
      const type = BUILDING_TYPES[building.buildingType];
      const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
      const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
      const qty = building.qty || 1;

      // Parse dimensions from size label
      const dims = size.label.replace(/'/g, '').split(' × ');
      const width = parseInt(dims[0]);
      const length = parseInt(dims[1]);
      const height = parseInt(eave.id);
      const sqft = size.sqft;
      const perimeterFt = (width + length) * 2;
      const roofSqFt = sqft * 1.1; // 10% for pitch
      const wallSqFt = perimeterFt * height;

      let materials = [];
      let lineNum = 1;

      // STRUCTURAL STEEL
      materials.push({ section: 'STRUCTURAL STEEL', items: [] });
      const steelSection = materials[materials.length - 1].items;

      // Columns (corners + intermediate every 10ft)
      const columnsPerSide = Math.ceil(length / 10) + 1;
      const totalColumns = (columnsPerSide * 2) + 4;
      steelSection.push({ line: lineNum++, item: `Steel Columns (${height}ft W-Section)`, qty: totalColumns, unit: 'EA', notes: 'Primary structural columns' });

      // Rafters
      const rafterCount = columnsPerSide;
      steelSection.push({ line: lineNum++, item: `Steel Rafters (${width}ft span)`, qty: rafterCount, unit: 'EA', notes: 'Roof support' });

      // Purlins (roof)
      const purlinRows = Math.ceil(length / 5);
      const purlinsPerRow = Math.ceil(width / 5);
      steelSection.push({ line: lineNum++, item: 'Roof Purlins (C-Section)', qty: purlinRows * purlinsPerRow, unit: 'EA', notes: '5ft O.C. spacing' });

      // Girts (wall)
      const girtRows = Math.ceil(height / 5);
      const girtsTotal = girtRows * Math.ceil(perimeterFt / 25);
      steelSection.push({ line: lineNum++, item: 'Wall Girts (C-Section)', qty: girtsTotal, unit: 'EA', notes: 'Wall support' });

      // Base plates and anchor bolts
      steelSection.push({ line: lineNum++, item: 'Column Base Plates', qty: totalColumns, unit: 'EA', notes: '1/2" thick steel' });
      steelSection.push({ line: lineNum++, item: 'Anchor Bolt Sets (4-bolt)', qty: totalColumns, unit: 'SET', notes: '3/4" x 18" J-bolts' });

      // ROOFING
      materials.push({ section: 'ROOFING', items: [] });
      const roofSection = materials[materials.length - 1].items;
      const roofPanels = Math.ceil(roofSqFt / 36); // 3ft wide panels
      roofSection.push({ line: lineNum++, item: '26 Gauge Roof Panels (3ft × 12ft)', qty: roofPanels, unit: 'EA', notes: 'Galvalume Plus' });
      roofSection.push({ line: lineNum++, item: 'Ridge Cap (10ft sections)', qty: Math.ceil(length / 10), unit: 'EA', notes: '' });
      roofSection.push({ line: lineNum++, item: 'Roof Panel Screws (#14 × 1")', qty: roofPanels * 40, unit: 'EA', notes: 'Self-drilling w/ washer' });
      roofSection.push({ line: lineNum++, item: 'Butyl Tape Sealant (50ft roll)', qty: Math.ceil(length / 25), unit: 'ROLL', notes: '' });

      // WALL PANELS
      materials.push({ section: 'WALL PANELS', items: [] });
      const wallSection = materials[materials.length - 1].items;
      const wallPanels = Math.ceil(wallSqFt / 36);
      wallSection.push({ line: lineNum++, item: '26 Gauge Wall Panels (3ft × 12ft)', qty: wallPanels, unit: 'EA', notes: 'Color: Customer choice' });
      wallSection.push({ line: lineNum++, item: 'Wall Panel Screws (#14 × 1")', qty: wallPanels * 35, unit: 'EA', notes: 'Color matched' });

      // TRIM & FLASHING
      materials.push({ section: 'TRIM & FLASHING', items: [] });
      const trimSection = materials[materials.length - 1].items;
      trimSection.push({ line: lineNum++, item: 'Corner Trim (10ft sections)', qty: Math.ceil(height * 4 / 10), unit: 'EA', notes: '' });
      trimSection.push({ line: lineNum++, item: 'Base Trim (10ft sections)', qty: Math.ceil(perimeterFt / 10), unit: 'EA', notes: '' });
      trimSection.push({ line: lineNum++, item: 'Eave Trim (10ft sections)', qty: Math.ceil(length * 2 / 10), unit: 'EA', notes: '' });
      trimSection.push({ line: lineNum++, item: 'Rake Trim (10ft sections)', qty: Math.ceil(width * 2 / 10), unit: 'EA', notes: '' });
      trimSection.push({ line: lineNum++, item: 'J-Trim (10ft sections)', qty: 20, unit: 'EA', notes: 'Around openings' });

      // DOORS (301 walk-through is ALWAYS included as standard)
      materials.push({ section: 'DOORS', items: [] });
      const doorSection = materials[materials.length - 1].items;

      // Standard 301 Walk-through Door (always included)
      const totalWalkthrough = 1 + (building.doors.extraWalkthrough || 0);
      doorSection.push({ line: lineNum++, item: "3070 Walk-Through Door (3' × 7')", qty: totalWalkthrough, unit: 'EA', notes: '1 standard + ' + (building.doors.extraWalkthrough || 0) + ' additional' });
      doorSection.push({ line: lineNum++, item: 'Walk-Through Door Frame', qty: totalWalkthrough, unit: 'SET', notes: 'Pre-hung w/ hardware' });

      // Overhead Doors (from new structure)
      if (building.doors.overhead && building.doors.overhead.length > 0) {
        building.doors.overhead.forEach((door, idx) => {
          const doorSize = DOOR_SIZES.find(d => d.id === door.size);
          const doorLabel = doorSize ? doorSize.label : door.size;
          const doorType = door.type === 'rollup' ? 'Roll-Up' : 'Sectional';
          doorSection.push({ line: lineNum++, item: `${doorLabel} ${doorType} Door`, qty: 1, unit: 'EA', notes: `${door.placement === 'gabled' ? 'Gabled end' : 'Eave side'}, wind-rated` });
          doorSection.push({ line: lineNum++, item: `${doorType} Door Frame Kit (${doorLabel})`, qty: 1, unit: 'SET', notes: '' });
        });
      }

      // WINDOWS
      const win3x3 = building.addons['win_3x3'] || 0;
      const win4x4 = building.addons['win_4x4'] || 0;
      if (win3x3 > 0 || win4x4 > 0) {
        materials.push({ section: 'WINDOWS', items: [] });
        const winSection = materials[materials.length - 1].items;
        if (win3x3 > 0) {
          winSection.push({ line: lineNum++, item: "3' × 3' Fixed Window (Insulated)", qty: win3x3, unit: 'EA', notes: 'Aluminum frame' });
        }
        if (win4x4 > 0) {
          winSection.push({ line: lineNum++, item: "4' × 4' Slider Window (Insulated)", qty: win4x4, unit: 'EA', notes: 'Aluminum frame, screens' });
        }
      }

      // INSULATION
      const hasWallIns = building.addons['wall_insulation'] || 0;
      const hasRoofIns = building.addons['roof_insulation'] || 0;
      if (hasWallIns || hasRoofIns) {
        materials.push({ section: 'INSULATION', items: [] });
        const insSection = materials[materials.length - 1].items;
        if (hasWallIns) {
          const wallInsRolls = Math.ceil(wallSqFt / 500);
          insSection.push({ line: lineNum++, item: 'Wall Insulation (R-13 Faced)', qty: wallInsRolls, unit: 'ROLL', notes: '500 sq ft per roll' });
          insSection.push({ line: lineNum++, item: 'Insulation Support Bands', qty: Math.ceil(wallSqFt / 100), unit: 'EA', notes: '' });
        }
        if (hasRoofIns) {
          const roofInsRolls = Math.ceil(roofSqFt / 500);
          insSection.push({ line: lineNum++, item: 'Roof Insulation (R-19 Faced)', qty: roofInsRolls, unit: 'ROLL', notes: '500 sq ft per roll' });
        }
      }

      // GUTTERS (LF-based calculation)
      if (building.addons['gutters']) {
        materials.push({ section: 'GUTTERS & DRAINAGE', items: [] });
        const gutterSection = materials[materials.length - 1].items;
        // Calculate gutter LF using the helper function
        const gutterLF = calculateGutterLF(building.buildingSize);
        const downspoutCount = Math.ceil(gutterLF / ADMIN_CONFIG.downspoutSpacingFt);

        gutterSection.push({ line: lineNum++, item: '5" K-Style Gutters (10ft)', qty: Math.ceil(gutterLF / 10), unit: 'EA', notes: `${gutterLF} LF total @ $${ADMIN_CONFIG.gutterPricePerLF}/LF` });
        gutterSection.push({ line: lineNum++, item: '3" × 4" Downspouts (10ft)', qty: downspoutCount, unit: 'EA', notes: `1 per ${ADMIN_CONFIG.downspoutSpacingFt}ft` });
        gutterSection.push({ line: lineNum++, item: 'Gutter Brackets', qty: Math.ceil(gutterLF / 3), unit: 'EA', notes: '3ft O.C. spacing' });
        gutterSection.push({ line: lineNum++, item: 'Downspout Brackets', qty: downspoutCount * 2, unit: 'EA', notes: '2 per downspout' });
        gutterSection.push({ line: lineNum++, item: 'End Caps', qty: 4, unit: 'EA', notes: '' });
        gutterSection.push({ line: lineNum++, item: 'Gutter Sealant', qty: Math.ceil(gutterLF / 50), unit: 'TUBE', notes: '' });
      }

      // WAINSCOT
      const wainscotQty = building.addons['wainscot'] || 0;
      if (wainscotQty > 0) {
        materials.push({ section: 'WAINSCOT', items: [] });
        const wainSection = materials[materials.length - 1].items;
        const wainSqFt = (wainscotQty === 4 ? perimeterFt : (wainscotQty * (wainscotQty <= 2 ? length : width))) * 3;
        const wainPanels = Math.ceil(wainSqFt / 36);
        wainSection.push({ line: lineNum++, item: 'Wainscot Panels (3ft × 10ft)', qty: wainPanels, unit: 'EA', notes: '3ft height' });
        wainSection.push({ line: lineNum++, item: 'Wainscot Cap Trim (10ft)', qty: Math.ceil(wainSqFt / 30), unit: 'EA', notes: '' });
      }

      // CONCRETE (if selected)
      if (building.addons['concrete_slab']) {
        materials.push({ section: 'CONCRETE & FOUNDATION', items: [] });
        const concreteSection = materials[materials.length - 1].items;
        const cubicYards = Math.ceil((sqft * 4/12) / 27 * 1.1);
        const rebarFt = Math.ceil(sqft / 16 * 2);
        concreteSection.push({ line: lineNum++, item: 'Concrete (4000 PSI)', qty: cubicYards, unit: 'CY', notes: '4" thick slab' });
        concreteSection.push({ line: lineNum++, item: '#4 Rebar (20ft lengths)', qty: Math.ceil(rebarFt / 20), unit: 'EA', notes: '16" O.C. grid' });
        concreteSection.push({ line: lineNum++, item: 'Rebar Chairs', qty: Math.ceil(sqft / 16), unit: 'EA', notes: '' });
        concreteSection.push({ line: lineNum++, item: 'Vapor Barrier (6 mil)', qty: Math.ceil(sqft / 1500), unit: 'ROLL', notes: '1500 sq ft roll' });
        concreteSection.push({ line: lineNum++, item: 'Expansion Joint Material', qty: Math.ceil(perimeterFt / 50), unit: 'ROLL', notes: '' });
        concreteSection.push({ line: lineNum++, item: 'Form Boards (2×4×12)', qty: Math.ceil(perimeterFt / 12) * 2, unit: 'EA', notes: 'Perimeter forms' });
      }

      // HARDWARE & FASTENERS
      materials.push({ section: 'HARDWARE & FASTENERS', items: [] });
      const hwSection = materials[materials.length - 1].items;
      hwSection.push({ line: lineNum++, item: 'Structural Bolts (3/4" × 2")', qty: totalColumns * 8, unit: 'EA', notes: 'Grade 5' });
      hwSection.push({ line: lineNum++, item: 'Structural Bolts (5/8" × 1.5")', qty: rafterCount * 12, unit: 'EA', notes: 'Rafter connections' });
      hwSection.push({ line: lineNum++, item: 'Tek Screws (#12 × 1")', qty: 500, unit: 'EA', notes: 'Girt/purlin attach' });
      hwSection.push({ line: lineNum++, item: 'Tube Caulk (Construction)', qty: 12, unit: 'EA', notes: '' });

      return { building, size, eave, type, qty, materials, totalLines: lineNum - 1 };
    }

    // ==================== SIGNATURE/INITIALS PAD ====================
    class SignaturePad {
      constructor(canvas, onChange, isInitials = false) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.drawing = false;
        this.onChange = onChange;
        this.isInitials = isInitials;
        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = isInitials ? 1.5 : 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';

        canvas.addEventListener('mousedown', (e) => this.start(e));
        canvas.addEventListener('mousemove', (e) => this.draw(e));
        canvas.addEventListener('mouseup', () => this.stop());
        canvas.addEventListener('mouseleave', () => this.stop());
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); this.start(e); }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); this.draw(e); }, { passive: false });
        canvas.addEventListener('touchend', () => this.stop());
      }

      getPos(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        return { x: x * (this.canvas.width / rect.width), y: y * (this.canvas.height / rect.height) };
      }

      start(e) {
        this.drawing = true;
        const pos = this.getPos(e);
        this.ctx.beginPath();
        this.ctx.moveTo(pos.x, pos.y);
      }

      draw(e) {
        if (!this.drawing) return;
        const pos = this.getPos(e);
        this.ctx.lineTo(pos.x, pos.y);
        this.ctx.stroke();
        this.ctx.beginPath();
        this.ctx.moveTo(pos.x, pos.y);
      }

      stop() {
        if (this.drawing) {
          this.drawing = false;
          if (this.onChange) this.onChange(true);
        }
      }

      clear() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        if (this.onChange) this.onChange(false);
      }

      isEmpty() {
        const data = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height).data;
        for (let i = 3; i < data.length; i += 4) {
          if (data[i] !== 0) return false;
        }
        return true;
      }

      getDataURL() {
        return this.canvas.toDataURL('image/png');
      }
    }

    // ==================== HELPER FUNCTIONS ====================
    function formatCurrency(num) {
      return '$' + num.toLocaleString();
    }

    function getSelectedSize() {
      return BUILDING_SIZES.find(s => s.id === state.buildingSize);
    }

    function getSelectedEave() {
      return EAVE_HEIGHTS.find(e => e.id === state.eaveHeight);
    }

    // Calculate total for current building config
    function calculateCurrentBuildingTotal() {
      const size = getSelectedSize();
      const eave = getSelectedEave();
      if (!size || !eave) return 0;

      let total = size.startingPrice + eave.modifier;

      // Add overhead doors (each has a size with a price from matrix)
      if (state.doors.overhead && state.doors.overhead.length > 0) {
        state.doors.overhead.forEach(door => {
          // Use new price matrix if available, fallback to DOOR_SIZES
          const matrixPrice = getDoorPrice(door.height, door.width);
          if (matrixPrice > 0) {
            total += matrixPrice;
          } else {
            const doorSize = DOOR_SIZES.find(d => d.id === door.size);
            if (doorSize) total += doorSize.price;
          }
        });
      }
      // Add extra walk-through doors (standard 301 is included in base price)
      total += (state.doors.extraWalkthrough || 0) * 1045;

      // Add selected add-ons (quantity stored directly in state.addons[id])
      ADDONS.forEach(cat => {
        cat.items.forEach(item => {
          const qty = state.addons[item.id] || 0;
          if (qty > 0 && !item.id.startsWith('door_')) {
            if (item.perLF) {
              // Gutter pricing: calculate based on linear footage
              total += calculateGutterPrice(state.buildingSize);
            } else if (item.perSqFt) {
              total += item.perSqFt * size.sqft;
            } else {
              total += item.price * qty;
            }
          }
        });
      });

      return total;
    }

    // Calculate total for a specific building in the array (multiplied by qty)
    function calculateBuildingTotal(building) {
      const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
      const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
      if (!size || !eave) return 0;

      let unitPrice = size.startingPrice + eave.modifier;

      // Add overhead doors
      if (building.doors.overhead && building.doors.overhead.length > 0) {
        building.doors.overhead.forEach(door => {
          // Use new price matrix if available, fallback to DOOR_SIZES
          const matrixPrice = getDoorPrice(door.height, door.width);
          if (matrixPrice > 0) {
            unitPrice += matrixPrice;
          } else {
            const doorSize = DOOR_SIZES.find(d => d.id === door.size);
            if (doorSize) unitPrice += doorSize.price;
          }
        });
      }
      // Add extra walk-through doors (standard 301 is included in base price)
      unitPrice += (building.doors.extraWalkthrough || 0) * 1045;

      ADDONS.forEach(cat => {
        cat.items.forEach(item => {
          const qty = building.addons[item.id] || 0;
          if (qty > 0 && !item.id.startsWith('door_')) {
            if (item.perLF) {
              // Gutter pricing: calculate based on linear footage
              unitPrice += calculateGutterPrice(building.buildingSize);
            } else if (item.perSqFt) {
              unitPrice += item.perSqFt * size.sqft;
            } else {
              unitPrice += item.price * qty;
            }
          }
        });
      });

      // Multiply by building quantity
      const buildingQty = building.qty || 1;
      return unitPrice * buildingQty;
    }

    // Get unit price for a single building (without quantity multiplier)
    function getBuildingUnitPrice(building) {
      const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
      const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
      if (!size || !eave) return 0;

      let unitPrice = size.startingPrice + eave.modifier;

      // Add overhead doors
      if (building.doors.overhead && building.doors.overhead.length > 0) {
        building.doors.overhead.forEach(door => {
          // Use new price matrix if available, fallback to DOOR_SIZES
          const matrixPrice = getDoorPrice(door.height, door.width);
          if (matrixPrice > 0) {
            unitPrice += matrixPrice;
          } else {
            const doorSize = DOOR_SIZES.find(d => d.id === door.size);
            if (doorSize) unitPrice += doorSize.price;
          }
        });
      }
      // Add extra walk-through doors (standard 301 is included in base price)
      unitPrice += (building.doors.extraWalkthrough || 0) * 1045;

      ADDONS.forEach(cat => {
        cat.items.forEach(item => {
          const qty = building.addons[item.id] || 0;
          if (qty > 0 && !item.id.startsWith('door_')) {
            if (item.perLF) {
              // Gutter pricing: calculate based on linear footage
              unitPrice += calculateGutterPrice(building.buildingSize);
            } else if (item.perSqFt) {
              unitPrice += item.perSqFt * size.sqft;
            } else {
              unitPrice += item.price * qty;
            }
          }
        });
      });

      return unitPrice;
    }

    // Calculate grand total of all buildings
    function calculateTotal() {
      let total = 0;
      // Add all saved buildings
      state.buildings.forEach(building => {
        total += calculateBuildingTotal(building);
      });
      // Add current building if configured (and not already saved)
      if (state.buildingType && state.buildingSize && state.eaveHeight) {
        // Check if current config is already in buildings array
        const isEditing = state.buildings.length > 0 && state.currentBuildingIndex < state.buildings.length;
        if (!isEditing) {
          total += calculateCurrentBuildingTotal();
        }
      }
      return total;
    }

    // Save current building configuration to buildings array
    function saveCurrentBuilding() {
      const existingQty = (state.currentBuildingIndex < state.buildings.length)
        ? (state.buildings[state.currentBuildingIndex].qty || 1)
        : 1;

      const buildingConfig = {
        buildingType: state.buildingType,
        buildingSize: state.buildingSize,
        eaveHeight: state.eaveHeight,
        doors: JSON.parse(JSON.stringify(state.doors)),
        colors: JSON.parse(JSON.stringify(state.colors)),
        addons: JSON.parse(JSON.stringify(state.addons)),
        qty: existingQty
      };

      if (state.currentBuildingIndex < state.buildings.length) {
        // Update existing building
        state.buildings[state.currentBuildingIndex] = buildingConfig;
      } else {
        // Add new building
        state.buildings.push(buildingConfig);
      }
    }

    // Adjust building quantity
    function adjustBuildingQty(index, delta) {
      const building = state.buildings[index];
      const newQty = Math.max(1, Math.min(99, (building.qty || 1) + delta));
      building.qty = newQty;
      render();
    }

    // Add another building
    function addAnotherBuilding() {
      // Save current building first
      saveCurrentBuilding();
      // Reset for new building
      state.currentBuildingIndex = state.buildings.length;
      state.buildingType = null;
      state.buildingSize = null;
      state.eaveHeight = null;
      state.doors = { overhead: [], walkthrough301: 1, extraWalkthrough: 0 };
      state.colors = { wallPanels: 'white', roofPanels: 'white', trim: 'white', insulation: 'white' };
      state.addons = {};
      state.step = 0;
      render();
    }

    // Edit an existing building
    function editBuilding(index) {
      const building = state.buildings[index];
      state.currentBuildingIndex = index;
      state.buildingType = building.buildingType;
      state.buildingSize = building.buildingSize;
      state.eaveHeight = building.eaveHeight;
      state.doors = JSON.parse(JSON.stringify(building.doors));
      state.colors = JSON.parse(JSON.stringify(building.colors || { wallPanels: 'white', roofPanels: 'white', trim: 'white', insulation: 'white' }));
      state.addons = JSON.parse(JSON.stringify(building.addons));
      state.step = 0;
      render();
    }

    // Remove a building
    function removeBuilding(index) {
      if (confirm('Remove this building from the order?')) {
        state.buildings.splice(index, 1);
        if (state.buildings.length === 0) {
          // Reset to empty state
          state.currentBuildingIndex = 0;
        } else {
          state.currentBuildingIndex = Math.min(state.currentBuildingIndex, state.buildings.length - 1);
        }
        render();
      }
    }

    // ==================== BUILDING PROFILE VISUALIZATION ====================

    // Render the building profile SVG for door placement preview
    function renderBuildingProfile() {
      if (!state.buildingSize || !state.eaveHeight) {
        return `<div class="bg-gray-100 rounded-xl p-6 text-center border-2 border-dashed border-gray-300">
          <p class="text-gray-500">Select building size and eave height to see preview</p>
        </div>`;
      }

      const size = BUILDING_SIZES.find(s => s.id === state.buildingSize);
      const eaveHeight = parseInt(state.eaveHeight);
      const currentView = state.buildingView || 'front';

      // Parse dimensions from size label (e.g., "30' × 40'" → width=30, depth=40)
      const dims = size.label.replace(/'/g, '').split(' × ');
      const buildingWidthFt = parseInt(dims[0]);  // Gabled end width
      const buildingDepthFt = parseInt(dims[1]);  // Eave side depth

      // Determine which dimension to show based on view
      const isFrontBack = currentView === 'front' || currentView === 'back';
      const viewWidthFt = isFrontBack ? buildingWidthFt : buildingDepthFt;
      const viewLabel = isFrontBack ? `${buildingWidthFt}' Wide (Gabled End)` : `${buildingDepthFt}' Deep (Eave Side)`;

      // SVG viewBox dimensions (scale building to fit)
      const svgWidth = 400;
      const svgHeight = 280;
      const margin = 40;
      const groundY = svgHeight - 50;

      // Scale factor: fit building view width within SVG
      const maxBuildingWidth = svgWidth - margin * 2;
      const scale = maxBuildingWidth / viewWidthFt;
      const scaledWidth = viewWidthFt * scale;
      const scaledHeight = Math.min(eaveHeight * scale * 1.5, svgHeight - 120); // Cap height

      // Roof pitch: 3:12 for gabled end, flat for eave side
      const roofPitch = isFrontBack ? 0.125 : 0;
      const roofRise = (scaledWidth / 2) * roofPitch;

      // Building position
      const buildingX = margin;
      const buildingY = groundY - scaledHeight;

      // Get selected colors
      const wallColor = COLOR_OPTIONS.panels.find(c => c.id === state.colors.wallPanels)?.hex || '#ffffff';
      const roofColor = COLOR_OPTIONS.panels.find(c => c.id === state.colors.roofPanels)?.hex || '#ffffff';
      const trimColor = COLOR_OPTIONS.trim.find(c => c.id === state.colors.trim)?.hex || '#003057';

      // Calculate all doors
      const allDoors = [];

      // Standard walk-through door (always present)
      allDoors.push({
        type: 'walkthrough',
        width: 3,
        height: 7,
        label: '3×7 Walk-Through',
        placement: 'gabled',
        id: 'standard-walkthrough'
      });

      // Additional walk-through doors
      for (let i = 0; i < (state.doors.extraWalkthrough || 0); i++) {
        allDoors.push({
          type: 'walkthrough',
          width: 3,
          height: 7,
          label: '3×7 Walk-Through',
          placement: 'gabled',
          id: `extra-walkthrough-${i}`
        });
      }

      // Overhead doors
      (state.doors.overhead || []).forEach((door, idx) => {
        allDoors.push({
          type: 'overhead',
          width: door.width || parseInt(door.size?.split('x')[1]) || 10,
          height: door.height || parseInt(door.size?.split('x')[0]) || 10,
          doorType: door.type,
          placement: door.placement || 'gabled',
          label: `${door.height || door.size?.split('x')[0]}'×${door.width || door.size?.split('x')[1]}' ${door.type === 'rollup' ? 'Roll-Up' : 'Sectional'}`,
          id: `overhead-${idx}`
        });
      });

      // Position doors on the building based on current view
      const gabledDoors = allDoors.filter(d => d.placement === 'gabled');
      const sideDoors = allDoors.filter(d => d.placement === 'eave');

      // Select doors to show based on current view
      const doorsForView = isFrontBack ? gabledDoors : sideDoors;

      // Calculate clearance (2'-6" = 2.5 ft from posts)
      const clearanceFt = 2.5;
      const clearancePixels = clearanceFt * scale;

      // Render door SVGs for current view
      let doorSVGs = '';
      let doorLabelSVGs = '';
      const totalViewDoorsWidth = doorsForView.reduce((sum, d) => sum + d.width, 0);
      const totalDoorsScaledWidth = totalViewDoorsWidth * scale * 0.8 + (doorsForView.length - 1) * 10; // doors + gaps

      // Start position respecting 2'-6" clearance from left post
      // Center doors in the valid zone between left clearance and center post clearance
      const leftValidStart = buildingX + clearancePixels;
      const centerPostX = buildingX + scaledWidth / 2;
      const leftZoneEnd = centerPostX - clearancePixels;

      // If doors fit in left zone, center them there; otherwise distribute across valid zones
      let doorX;
      if (totalDoorsScaledWidth <= leftZoneEnd - leftValidStart) {
        // Center in left zone
        doorX = leftValidStart + (leftZoneEnd - leftValidStart - totalDoorsScaledWidth) / 2;
      } else {
        // Start at left valid position
        doorX = leftValidStart;
      }

      doorsForView.forEach((door, idx) => {
        const doorScaledWidth = door.width * scale * 0.8;
        const doorScaledHeight = Math.min(door.height * scale * 1.2, scaledHeight * 0.85);
        const doorY = groundY - doorScaledHeight;

        // Check for saved position (view-specific key), otherwise use calculated default
        const positionKey = `${door.id}-${currentView}`;
        const savedX = state.doorPositions && state.doorPositions[positionKey];
        const actualDoorX = savedX !== undefined ? savedX : doorX;

        const fillColor = door.type === 'walkthrough' ? '#8B4513' : '#505050';
        const strokeColor = trimColor;

        const tooltipText = door.type === 'walkthrough'
          ? `${door.width}' × ${door.height}' Walk-Through — Drag to reposition`
          : `${door.height}' × ${door.width}' ${door.doorType === 'rollup' ? 'Roll-Up' : 'Sectional'} — Drag to reposition`;

        doorSVGs += `
          <g class="door-element" data-door-id="${door.id}" data-tooltip="${tooltipText}" style="cursor: grab;"
             onmouseenter="showDoorTooltip(event, this)" onmouseleave="hideDoorTooltip()"
             onmousedown="startDoorDrag(event, this)"
             ontouchstart="startDoorDrag(event, this)">
            <rect x="${actualDoorX}" y="${doorY}" width="${doorScaledWidth}" height="${doorScaledHeight}"
                  fill="${fillColor}" stroke="${strokeColor}" stroke-width="2" rx="2"/>`;

        // Add door details
        if (door.type === 'walkthrough') {
          // Door handle
          doorSVGs += `<circle cx="${actualDoorX + doorScaledWidth - 8}" cy="${doorY + doorScaledHeight/2}" r="3" fill="#FFD700" pointer-events="none"/>`;
        } else {
          // Overhead door panels
          const panelCount = 4;
          for (let p = 1; p < panelCount; p++) {
            const panelY = doorY + (doorScaledHeight / panelCount) * p;
            doorSVGs += `<line x1="${actualDoorX + 2}" y1="${panelY}" x2="${actualDoorX + doorScaledWidth - 2}" y2="${panelY}" stroke="${strokeColor}" stroke-width="1" pointer-events="none"/>`;
          }
        }

        doorSVGs += `</g>`;

        // Door label (follows the door position)
        doorLabelSVGs += `
          <text x="${actualDoorX + doorScaledWidth/2}" y="${groundY + 20}"
                font-size="9" fill="#003057" text-anchor="middle" font-family="Arial, sans-serif">
            ${door.width}'×${door.height}'
          </text>`;

        // Move default position for next door
        doorX += doorScaledWidth + 10;
      });

      // Building type specific elements
      let buildingTypeElements = '';

      // Calculate clearance zones (2'-6" = 2.5 ft from posts)
      const clearanceFt = 2.5;
      const clearancePixels = clearanceFt * scale;
      const postWidth = 8;

      // Post positions
      const leftPostX = buildingX;
      const centerPostX = buildingX + scaledWidth / 2;
      const rightPostX = buildingX + scaledWidth;

      // Clearance zone indicators (shown for all building types)
      const clearanceZones = `
        <!-- Post clearance zones (2'-6" rule) - shown as subtle red zones -->
        <rect x="${leftPostX}" y="${groundY - scaledHeight * 0.9}" width="${clearancePixels}"
              height="${scaledHeight * 0.9}" fill="#ef4444" opacity="0.15"/>
        <rect x="${centerPostX - clearancePixels/2}" y="${groundY - scaledHeight * 0.9}" width="${clearancePixels}"
              height="${scaledHeight * 0.9}" fill="#ef4444" opacity="0.15"/>
        <rect x="${rightPostX - clearancePixels}" y="${groundY - scaledHeight * 0.9}" width="${clearancePixels}"
              height="${scaledHeight * 0.9}" fill="#ef4444" opacity="0.15"/>

        <!-- Post position markers -->
        <line x1="${leftPostX}" y1="${groundY}" x2="${leftPostX}" y2="${groundY - scaledHeight}"
              stroke="#8B4513" stroke-width="4" stroke-dasharray="4,2"/>
        <line x1="${centerPostX}" y1="${groundY}" x2="${centerPostX}" y2="${groundY - scaledHeight}"
              stroke="#8B4513" stroke-width="4" stroke-dasharray="4,2"/>
        <line x1="${rightPostX}" y1="${groundY}" x2="${rightPostX}" y2="${groundY - scaledHeight}"
              stroke="#8B4513" stroke-width="4" stroke-dasharray="4,2"/>

        <!-- Clearance labels -->
        <text x="${leftPostX + clearancePixels/2}" y="${groundY - 5}"
              font-size="7" fill="#ef4444" text-anchor="middle" font-family="Arial">2'6"</text>
        <text x="${centerPostX}" y="${groundY - 5}"
              font-size="7" fill="#ef4444" text-anchor="middle" font-family="Arial">2'6"</text>
        <text x="${rightPostX - clearancePixels/2}" y="${groundY - 5}"
              font-size="7" fill="#ef4444" text-anchor="middle" font-family="Arial">2'6"</text>
      `;

      if (state.buildingType === 'poleBarn') {
        // Pole barn posts (more prominent)
        buildingTypeElements = clearanceZones + `
          <rect x="${leftPostX - postWidth/2 + 4}" y="${buildingY + 10}" width="${postWidth}" height="${scaledHeight - 10}" fill="#8B4513" opacity="0.8"/>
          <rect x="${rightPostX - postWidth/2 - 4}" y="${buildingY + 10}" width="${postWidth}" height="${scaledHeight - 10}" fill="#8B4513" opacity="0.8"/>
          <rect x="${centerPostX - postWidth/2}" y="${buildingY + 10}" width="${postWidth}" height="${scaledHeight - 10}" fill="#8B4513" opacity="0.8"/>
        `;
      } else if (state.buildingType === 'carport') {
        // Carport with clearance zones
        buildingTypeElements = clearanceZones + `
          <line x1="${buildingX + 10}" y1="${buildingY}" x2="${buildingX + 10}" y2="${groundY}"
                stroke="${trimColor}" stroke-width="3" stroke-dasharray="8,4"/>
          <line x1="${buildingX + scaledWidth - 10}" y1="${buildingY}" x2="${buildingX + scaledWidth - 10}" y2="${groundY}"
                stroke="${trimColor}" stroke-width="3" stroke-dasharray="8,4"/>
        `;
      } else {
        // Default: just show clearance zones for structural posts
        buildingTypeElements = clearanceZones;
      }

      return `
        <div class="bg-gradient-to-b from-sky-100 to-sky-200 rounded-xl p-4 border border-gray-200">
          <div class="flex items-center justify-center gap-2 mb-2">
            <p class="text-xs text-gray-500 text-center">Drag doors to reposition</p>
            <span class="text-xs px-2 py-0.5 bg-red-100 text-red-700 rounded-full font-medium">2'-6" min from posts</span>
          </div>
          <svg viewBox="0 0 ${svgWidth} ${svgHeight}" class="w-full" style="max-height: 280px;">
            <!-- Sky gradient -->
            <defs>
              <linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:0.3"/>
                <stop offset="100%" style="stop-color:#E0F4FF;stop-opacity:0.5"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="${svgWidth}" height="${groundY}" fill="url(#skyGrad)"/>

            <!-- Ground -->
            <rect x="0" y="${groundY}" width="${svgWidth}" height="${svgHeight - groundY}" fill="#4a5568"/>
            <line x1="0" y1="${groundY}" x2="${svgWidth}" y2="${groundY}" stroke="#2d3748" stroke-width="2"/>

            <!-- View Label -->
            <text x="${svgWidth / 2}" y="18"
                  font-size="14" fill="#003057" text-anchor="middle" font-weight="bold" font-family="Arial, sans-serif">
              ${currentView.charAt(0).toUpperCase() + currentView.slice(1)} ${isFrontBack ? 'Wall' : 'Side'}
            </text>

            <!-- Building walls -->
            <rect x="${buildingX}" y="${buildingY}" width="${scaledWidth}" height="${scaledHeight}"
                  fill="${wallColor}" stroke="${trimColor}" stroke-width="3"/>

            <!-- Roof - peaked for front/back (gabled), flat for sides (eave) -->
            ${isFrontBack ?
              `<polygon points="${buildingX - 5},${buildingY} ${buildingX + scaledWidth/2},${buildingY - roofRise} ${buildingX + scaledWidth + 5},${buildingY}"
                       fill="${roofColor}" stroke="${trimColor}" stroke-width="3"/>` :
              `<rect x="${buildingX - 5}" y="${buildingY - 8}" width="${scaledWidth + 10}" height="10"
                    fill="${roofColor}" stroke="${trimColor}" stroke-width="2"/>
               <line x1="${buildingX - 5}" y1="${buildingY - 8}" x2="${buildingX + scaledWidth + 5}" y2="${buildingY - 8}"
                     stroke="${trimColor}" stroke-width="3"/>`
            }

            <!-- Building type specific elements -->
            ${buildingTypeElements}

            <!-- Doors -->
            ${doorSVGs}
            ${doorsForView.length === 0 ? `
              <text x="${svgWidth / 2}" y="${groundY - scaledHeight/2}"
                    font-size="14" fill="#6b7280" text-anchor="middle" font-family="Arial, sans-serif">
                No doors on this wall
              </text>
              <text x="${svgWidth / 2}" y="${groundY - scaledHeight/2 + 18}"
                    font-size="11" fill="#9ca3af" text-anchor="middle" font-family="Arial, sans-serif">
                Add ${isFrontBack ? 'gabled' : 'eave side'} doors above
              </text>
            ` : ''}

            <!-- Dimension: Width -->
            <g class="dimension-line">
              <line x1="${buildingX}" y1="${groundY + 35}" x2="${buildingX + scaledWidth}" y2="${groundY + 35}"
                    stroke="#003057" stroke-width="1.5" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
              <text x="${buildingX + scaledWidth/2}" y="${groundY + 48}"
                    font-size="12" fill="#003057" text-anchor="middle" font-weight="bold" font-family="Arial, sans-serif">
                ${viewWidthFt}' ${isFrontBack ? 'Wide' : 'Deep'}
              </text>
            </g>

            <!-- Dimension: Height -->
            <g class="dimension-line">
              <line x1="${buildingX + scaledWidth + 20}" y1="${groundY}" x2="${buildingX + scaledWidth + 20}" y2="${buildingY}"
                    stroke="#003057" stroke-width="1.5"/>
              <text x="${buildingX + scaledWidth + 30}" y="${buildingY + scaledHeight/2}"
                    font-size="11" fill="#003057" font-weight="bold" font-family="Arial, sans-serif"
                    transform="rotate(-90, ${buildingX + scaledWidth + 30}, ${buildingY + scaledHeight/2})">
                ${eaveHeight}' Eave
              </text>
            </g>

            <!-- Door labels -->
            ${doorLabelSVGs}

            <!-- Arrow markers -->
            <defs>
              <marker id="arrowStart" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto">
                <path d="M6,0 L0,3 L6,6" fill="none" stroke="#003057" stroke-width="1"/>
              </marker>
              <marker id="arrowEnd" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto">
                <path d="M0,0 L6,3 L0,6" fill="none" stroke="#003057" stroke-width="1"/>
              </marker>
            </defs>
          </svg>

          <!-- Door Summary -->
          <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
              <p class="text-xs font-semibold text-gray-600">Configured Doors (${allDoors.length}):</p>
              <div class="flex items-center gap-3 text-xs">
                <span class="flex items-center gap-1">
                  <span class="w-3 h-3 bg-red-200 rounded opacity-60"></span>
                  <span class="text-gray-500">No-go zone (2'-6" from posts)</span>
                </span>
                <span class="flex items-center gap-1">
                  <span class="w-3 h-3 bg-amber-700 rounded"></span>
                  <span class="text-gray-500">Posts</span>
                </span>
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              ${allDoors.map(d => `
                <span class="text-xs px-2 py-1 rounded ${d.type === 'walkthrough' ? 'bg-amber-100 text-amber-800' : 'bg-gray-200 text-gray-700'}">
                  ${d.label}
                </span>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Door interactivity functions
    let activeDoorTooltip = null;
    let selectedDoorId = null;
    let isDraggingDoor = false;
    let draggedDoorElement = null;
    let dragStartX = 0;
    let dragOffsetX = 0;

    function startDoorDrag(event, element) {
      event.preventDefault();
      event.stopPropagation();

      isDraggingDoor = true;
      draggedDoorElement = element;

      const clientX = event.touches ? event.touches[0].clientX : event.clientX;
      const svg = element.closest('svg');
      const svgRect = svg.getBoundingClientRect();
      const doorRect = element.querySelector('rect');
      const currentX = parseFloat(doorRect.getAttribute('x'));

      // Calculate the offset from the mouse to the door's left edge
      const svgX = (clientX - svgRect.left) * (svg.viewBox.baseVal.width / svgRect.width);
      dragOffsetX = svgX - currentX;
      dragStartX = currentX;

      element.classList.add('dragging');
      hideDoorTooltip();

      // Add global event listeners
      document.addEventListener('mousemove', handleDoorDrag);
      document.addEventListener('mouseup', endDoorDrag);
      document.addEventListener('touchmove', handleDoorDrag, { passive: false });
      document.addEventListener('touchend', endDoorDrag);
    }

    // Door placement constants
    const DOOR_POST_CLEARANCE_FT = 2.5; // 2'-6" minimum clearance from posts

    function handleDoorDrag(event) {
      if (!isDraggingDoor || !draggedDoorElement) return;

      event.preventDefault();

      const clientX = event.touches ? event.touches[0].clientX : event.clientX;
      const svg = draggedDoorElement.closest('svg');
      const svgRect = svg.getBoundingClientRect();

      // Convert screen coordinates to SVG coordinates
      const svgX = (clientX - svgRect.left) * (svg.viewBox.baseVal.width / svgRect.width);
      let newX = svgX - dragOffsetX;

      // Get building boundaries and scale
      const margin = 40;
      const svgWidth = svg.viewBox.baseVal.width;
      const doorRect = draggedDoorElement.querySelector('rect');
      const doorWidth = parseFloat(doorRect.getAttribute('width'));

      // Get building width from state for proper scaling
      const size = BUILDING_SIZES.find(s => s.id === state.buildingSize);
      const dims = size ? size.label.replace(/'/g, '').split(' × ') : [40, 60];
      const buildingWidthFt = parseInt(dims[0]);
      const scaledBuildingWidth = svgWidth - margin * 2;
      const scale = scaledBuildingWidth / buildingWidthFt;

      // Calculate clearance in SVG pixels (2'-6" = 2.5 ft)
      const clearancePixels = DOOR_POST_CLEARANCE_FT * scale;

      // Post positions (left edge, center, right edge)
      const leftPostX = margin;
      const centerPostX = margin + scaledBuildingWidth / 2;
      const rightPostX = margin + scaledBuildingWidth;

      // Valid zones: must be clearancePixels away from posts
      // Left zone: from leftPost + clearance to centerPost - clearance - doorWidth
      // Right zone: from centerPost + clearance to rightPost - clearance - doorWidth
      const leftZoneMin = leftPostX + clearancePixels;
      const leftZoneMax = centerPostX - clearancePixels - doorWidth;
      const rightZoneMin = centerPostX + clearancePixels;
      const rightZoneMax = rightPostX - clearancePixels - doorWidth;

      // Constrain to valid zones with snap behavior
      if (newX < leftZoneMin) {
        newX = leftZoneMin;
      } else if (newX > leftZoneMax && newX < rightZoneMin) {
        // In the dead zone around center post - snap to nearest valid edge
        if (newX - leftZoneMax < rightZoneMin - newX) {
          newX = leftZoneMax;
        } else {
          newX = rightZoneMin;
        }
      } else if (newX > rightZoneMax) {
        newX = rightZoneMax;
      }

      // Show warning indicator if near invalid zone
      const warningIndicator = document.getElementById('door-placement-warning');
      if (warningIndicator) {
        const nearLeftPost = Math.abs(newX - leftPostX) < clearancePixels * 1.5;
        const nearCenterPost = Math.abs(newX + doorWidth/2 - centerPostX) < clearancePixels * 1.5;
        const nearRightPost = Math.abs(newX + doorWidth - rightPostX) < clearancePixels * 1.5;

        if (nearLeftPost || nearCenterPost || nearRightPost) {
          warningIndicator.style.display = 'block';
        } else {
          warningIndicator.style.display = 'none';
        }
      }

      // Move all elements in the door group
      const currentDoorX = parseFloat(doorRect.getAttribute('x'));
      const deltaX = newX - currentDoorX;

      // Update rect position
      doorRect.setAttribute('x', newX);

      // Update any child elements (door handle, panel lines)
      draggedDoorElement.querySelectorAll('circle').forEach(circle => {
        const cx = parseFloat(circle.getAttribute('cx'));
        circle.setAttribute('cx', cx + deltaX);
      });

      draggedDoorElement.querySelectorAll('line').forEach(line => {
        const x1 = parseFloat(line.getAttribute('x1'));
        const x2 = parseFloat(line.getAttribute('x2'));
        line.setAttribute('x1', x1 + deltaX);
        line.setAttribute('x2', x2 + deltaX);
      });
    }

    function endDoorDrag(event) {
      if (!isDraggingDoor || !draggedDoorElement) return;

      const doorId = draggedDoorElement.getAttribute('data-door-id');
      const doorView = draggedDoorElement.getAttribute('data-view') || state.buildingView;
      const doorRect = draggedDoorElement.querySelector('rect');
      const finalX = parseFloat(doorRect.getAttribute('x'));

      // Save the position to state with view-specific key
      const positionKey = `${doorId}-${doorView}`;
      state.doorPositions[positionKey] = finalX;

      draggedDoorElement.classList.remove('dragging');

      // Clean up
      isDraggingDoor = false;
      draggedDoorElement = null;

      document.removeEventListener('mousemove', handleDoorDrag);
      document.removeEventListener('mouseup', endDoorDrag);
      document.removeEventListener('touchmove', handleDoorDrag);
      document.removeEventListener('touchend', endDoorDrag);
    }

    function showDoorTooltip(event, element) {
      // Remove any existing tooltip
      hideDoorTooltip();

      const tooltipText = element.getAttribute('data-tooltip');
      if (!tooltipText) return;

      const tooltip = document.createElement('div');
      tooltip.className = 'door-tooltip';
      tooltip.textContent = tooltipText;
      tooltip.id = 'door-tooltip-active';
      document.body.appendChild(tooltip);

      // Position tooltip near the element
      const rect = element.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();

      // Position above the door element
      let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
      let top = rect.top - tooltipRect.height - 10;

      // Keep tooltip within viewport
      if (left < 10) left = 10;
      if (left + tooltipRect.width > window.innerWidth - 10) {
        left = window.innerWidth - tooltipRect.width - 10;
      }
      if (top < 10) {
        top = rect.bottom + 10; // Show below if not enough space above
      }

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';

      activeDoorTooltip = tooltip;
    }

    function hideDoorTooltip() {
      if (activeDoorTooltip) {
        activeDoorTooltip.remove();
        activeDoorTooltip = null;
      }
      // Also remove by ID in case reference was lost
      const existing = document.getElementById('door-tooltip-active');
      if (existing) existing.remove();
    }

    function selectDoorElement(element) {
      const doorId = element.getAttribute('data-door-id');

      // Remove selection from previously selected door
      document.querySelectorAll('.door-element.selected').forEach(el => {
        el.classList.remove('selected');
      });

      // Toggle selection
      if (selectedDoorId === doorId) {
        selectedDoorId = null;
      } else {
        selectedDoorId = doorId;
        element.classList.add('selected');

        // Find and highlight corresponding door in the door list
        highlightDoorInList(doorId);
      }
    }

    function highlightDoorInList(doorId) {
      // Remove previous highlights
      document.querySelectorAll('.door-list-item.highlighted').forEach(el => {
        el.classList.remove('highlighted');
      });

      // Find the door list item with matching data-door-id
      const listItem = document.querySelector(`.door-list-item[data-door-id="${doorId}"]`);
      if (listItem) {
        listItem.classList.add('highlighted');
        listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // Touch support for mobile
    function handleDoorTouch(event, element) {
      event.preventDefault();
      showDoorTooltip(event.touches[0], element);
      selectDoorElement(element);
    }

    // ==================== RENDER FUNCTIONS ====================
    function render() {
      const app = document.getElementById('app');

      // Determine what to render based on step
      if (state.step === 0) {
        app.innerHTML = renderBuildingType();
      } else if (state.buildingType === 'boltUp') {
        app.innerHTML = renderBoltUpForm();
      } else if (state.step === 1) {
        app.innerHTML = renderBuildingSize();
      } else if (state.step === 2) {
        app.innerHTML = renderEaveHeight();
      } else if (state.step === 3) {
        app.innerHTML = renderDoorConfig();
      } else if (state.step === 4) {
        app.innerHTML = renderAddons();
      } else if (state.step === 5) {
        app.innerHTML = renderSummary();
      } else {
        app.innerHTML = renderContract();
      }
    }

    // Step 0: Building Type Selection
    function renderBuildingType() {
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG}
              <div>
                <h1 class="text-xl font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">Metal Building Estimator</p>
              </div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Select Building Type</h2>
            <p class="text-gray-600">Choose the type of metal building for your project</p>
          </div>

          <div class="grid gap-4 md:grid-cols-3">
            ${Object.entries(BUILDING_TYPES).map(([key, type]) => `
              <div onclick="selectBuildingType('${key}')"
                   class="type-card rounded-xl p-6 text-center ${state.buildingType === key ? 'selected' : ''}">
                <div class="text-4xl mb-3">${type.icon}</div>
                <h3 class="text-xl font-bold" style="color: ${type.color === '#003057' ? '#04ceea' : type.color}">${type.name}</h3>
                <p class="text-gray-300 text-sm mt-1">${type.desc}</p>
                ${type.hasFixedPricing ?
                  `<p class="text-[#04ceea] font-semibold mt-3">Starting at $26,500</p>` :
                  `<p class="text-orange-400 font-semibold mt-3">${ICON_WARNING} ${type.note}</p>`
                }
              </div>
            `).join('')}
          </div>

          <div class="mt-8 flex justify-end">
            <button onclick="nextStep()" ${!state.buildingType ? 'disabled' : ''}
                    class="py-3 px-8 rounded-xl font-semibold ${state.buildingType ? 'btn-active' : 'bg-gray-200 text-gray-400'}">
              Next →
            </button>
          </div>
        </main>
      `;
    }

    // Bolt-Up Custom Quote Form
    function renderBoltUpForm() {
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG}
              <div>
                <h1 class="text-xl font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">Bolt-Up Construction - Custom Quote</p>
              </div>
            </div>
          </div>
        </header>

        <main class="max-w-2xl mx-auto p-4">
          <div class="bg-orange-50 border-2 border-orange-400 rounded-xl p-4 mb-6">
            <p class="text-orange-800 font-semibold">${ICON_WARNING} Bolt-Up Construction requires a custom quote</p>
            <p class="text-orange-700 text-sm mt-1">Pricing varies based on wind zone, snow zone, and engineering requirements. Please provide your specifications below.</p>
          </div>

          <div class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Request Custom Quote</h2>

            <div class="space-y-4">
              <div>
                <label class="block font-semibold text-gray-700 mb-1">Your Name *</label>
                <input type="text" value="${state.customer.name}" oninput="updateBoltUpField('name', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="Full name">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Phone *</label>
                <input type="tel" value="${state.customer.phone}" oninput="updateBoltUpField('phone', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="(555) 555-5555">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Email *</label>
                <input type="email" value="${state.customer.email}" oninput="updateBoltUpField('email', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="you@email.com">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Desired Building Size</label>
                <input type="text" value="${state.boltUpSpecs.customSize}" oninput="updateBoltUpSpec('customSize', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="e.g., 60' x 80' or custom dimensions">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Desired Eave Height</label>
                <input type="text" value="${state.boltUpSpecs.customEave}" oninput="updateBoltUpSpec('customEave', this.value)"
                       class="border-2 rounded-lg p-3 w-full" placeholder="e.g., 16 ft, 20 ft, etc.">
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Door Preferences</label>
                <textarea value="${state.boltUpSpecs.doorPrefs}" oninput="updateBoltUpSpec('doorPrefs', this.value)"
                          class="border-2 rounded-lg p-3 w-full" rows="2"
                          placeholder="e.g., Two 14x14 roll-up doors on front, one walk door on side">${state.boltUpSpecs.doorPrefs}</textarea>
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Add-On Preferences</label>
                <textarea value="${state.boltUpSpecs.addOnPrefs}" oninput="updateBoltUpSpec('addOnPrefs', this.value)"
                          class="border-2 rounded-lg p-3 w-full" rows="2"
                          placeholder="e.g., Insulation, gutters, windows, concrete slab">${state.boltUpSpecs.addOnPrefs}</textarea>
              </div>

              <div>
                <label class="block font-semibold text-gray-700 mb-1">Special Requirements / Notes</label>
                <textarea value="${state.boltUpSpecs.specialReqs}" oninput="updateBoltUpSpec('specialReqs', this.value)"
                          class="border-2 rounded-lg p-3 w-full" rows="3"
                          placeholder="Any other specifications, site conditions, or requirements...">${state.boltUpSpecs.specialReqs}</textarea>
              </div>
            </div>

            <div class="mt-6 flex gap-4">
              <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
                ← Back
              </button>
              <button onclick="submitBoltUpQuote()"
                      class="flex-1 py-3 px-6 rounded-xl font-semibold btn-primary">
                ${ICON_EMAIL} Request Quote
              </button>
            </div>
          </div>
        </main>
      `;
    }

    // Step 1: Building Size Selection
    function renderBuildingSize() {
      const type = BUILDING_TYPES[state.buildingType];
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Select Building Size</h2>
            <p class="text-gray-600">Standard 3-on-12 roof pitch on all buildings</p>
          </div>

          <div class="grid gap-3 grid-cols-2 md:grid-cols-5">
            ${BUILDING_SIZES.map(size => `
              <div onclick="selectSize('${size.id}')"
                   class="size-card rounded-lg p-4 text-center ${state.buildingSize === size.id ? 'selected' : ''}">
                <div class="font-bold text-lg text-white">${size.label}</div>
                <div class="text-gray-300 text-sm">${size.sqft.toLocaleString()} sq ft</div>
                <div class="text-[#04ceea] font-semibold text-sm mt-2">Starting at</div>
                <div class="text-[#04ceea] font-bold">${formatCurrency(size.startingPrice)}</div>
              </div>
            `).join('')}
          </div>

          <div class="mt-6 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ← Back
            </button>
            <button onclick="nextStep()" ${!state.buildingSize ? 'disabled' : ''}
                    class="py-3 px-8 rounded-xl font-semibold ${state.buildingSize ? 'btn-active' : 'bg-gray-200 text-gray-400'}">
              Next →
            </button>
          </div>
        </main>
      `;
    }

    // Step 2: Eave Height Selection
    function renderEaveHeight() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name} - ${size.label}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Select Eave Height</h2>
            <p class="text-gray-600">Choose the wall height for your building</p>
          </div>

          <div class="flex flex-wrap justify-center gap-4">
            ${EAVE_HEIGHTS.map(eave => `
              <button onclick="selectEave('${eave.id}')"
                      class="eave-btn rounded-xl p-6 text-center min-w-[120px] ${state.eaveHeight === eave.id ? 'selected' : ''}">
                <div class="text-3xl font-bold ${state.eaveHeight === eave.id ? 'text-[#003057]' : 'text-white'}">${eave.label}</div>
                <div class="text-sm mt-2 ${state.eaveHeight === eave.id ? 'text-[#003057]' : 'text-[#04ceea]'}">
                  ${eave.modifier === 0 ? 'Base price' : '+' + formatCurrency(eave.modifier)}
                </div>
              </button>
            `).join('')}
          </div>

          <div class="mt-8 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ← Back
            </button>
            <button onclick="nextStep()" ${!state.eaveHeight ? 'disabled' : ''}
                    class="py-3 px-8 rounded-xl font-semibold ${state.eaveHeight ? 'btn-active' : 'bg-gray-200 text-gray-400'}">
              Next →
            </button>
          </div>
        </main>
      `;
    }

    // Get available door sizes based on eave height (door height must be 2ft less than eave)
    function getAvailableDoorSizes() {
      const eaveHeight = parseInt(state.eaveHeight);
      const maxDoorHeight = eaveHeight - 2;
      return DOOR_SIZES.filter(door => door.height <= maxDoorHeight);
    }

    // Step 3: Door Configuration & Colors
    function renderDoorConfig() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      const availableDoorSizes = getAvailableDoorSizes();
      const eaveHeight = parseInt(state.eaveHeight);

      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name} - ${size.label} × ${eave.label}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Doors & Colors</h2>
            <p class="text-gray-600">Configure doors and select your building colors</p>
          </div>

          <div class="bg-white rounded-xl p-6 shadow-lg space-y-6">

            <!-- STANDARD WALKTHROUGH DOOR (Included) -->
            <div class="border-b pb-6">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <h3 class="font-bold text-lg text-green-700 flex items-center gap-2">${CHECK_MARK_GREEN} 3070 Walk-Through Door</h3>
                  <p class="text-green-600 text-sm font-medium">INCLUDED STANDARD (3' × 7')</p>
                </div>
                <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold">
                  1 Included
                </div>
              </div>
              <p class="text-gray-500 text-sm">Every building includes one standard 3070 walk-through door at no additional cost.</p>

              <!-- Additional Walk-Through Doors -->
              <div class="mt-4 bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-semibold text-sm">Additional Walk-Through Doors</p>
                    <p class="text-gray-500 text-xs">$1,045 each</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <button onclick="adjustExtraWalkthrough(-1)" class="w-8 h-8 rounded-full bg-gray-200 text-[#003057] font-bold">−</button>
                    <span class="text-xl font-bold w-6 text-center">${state.doors.extraWalkthrough}</span>
                    <button onclick="adjustExtraWalkthrough(1)" class="w-8 h-8 rounded-full bg-[#05c3de] text-[#003057] font-bold">+</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- OVERHEAD DOORS -->
            <div class="border-b pb-6">
              <h3 class="font-bold text-lg mb-2">Overhead Doors</h3>
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                <p class="text-amber-800 text-sm">
                  <strong>${ICON_WARNING} Door Height Rule:</strong> Maximum door height is <strong>${eaveHeight - ADMIN_CONFIG.doorHeightClearance} ft</strong>
                  (${ADMIN_CONFIG.doorHeightClearance} ft less than your ${eaveHeight} ft eave height)
                </p>
              </div>

              <!-- Current Overhead Doors -->
              ${state.doors.overhead.length > 0 ? `
                <div class="space-y-3 mb-4">
                  ${state.doors.overhead.map((door, idx) => {
                    const price = getDoorPrice(door.height, door.width) || DOOR_SIZES.find(d => d.id === door.size)?.price || 0;
                    return `
                    <div class="door-list-item flex items-center justify-between bg-gray-50 rounded-lg p-3 border-2 border-transparent"
                         data-door-id="overhead-${idx}">
                      <div class="flex items-center gap-3">
                        ${door.type === 'rollup' ? ICON_ROLLUP : ICON_SECTIONAL}
                        <div>
                          <p class="font-semibold">${door.height || door.size?.split('x')[0]}' H × ${door.width || door.size?.split('x')[1]}' W ${door.type === 'rollup' ? 'Roll-Up' : 'Sectional'}</p>
                          <p class="text-gray-500 text-sm">${door.placement === 'gabled' ? 'Gabled End' : 'Eave Side'}</p>
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="font-bold text-[#003057]">${formatCurrency(price)}</span>
                        <button onclick="removeOverheadDoor(${idx})" class="w-8 h-8 rounded-full bg-red-100 text-red-600 font-bold">×</button>
                      </div>
                    </div>
                  `}).join('')}
                </div>
              ` : '<p class="text-gray-400 text-sm italic mb-4">No overhead doors added yet</p>'}

              <!-- Add New Overhead Door - STEPWISE HEIGHT × WIDTH -->
              <div class="bg-blue-50 rounded-lg p-4 border-2 border-dashed border-blue-200">
                <p class="font-semibold text-sm mb-3 text-[#003057]">Add Overhead Door (Step by Step):</p>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-3">
                  <!-- Step 1: Height (filtered by eligibility) -->
                  <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">1. Height</label>
                    <select id="newDoorHeight" onchange="updateDoorPricePreview()" class="w-full p-2 border rounded-lg bg-white">
                      <option value="">Select</option>
                      ${getEligibleDoorHeights(state.eaveHeight).map(h => `<option value="${h.value}">${h.label}</option>`).join('')}
                    </select>
                  </div>

                  <!-- Step 2: Width -->
                  <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">2. Width</label>
                    <select id="newDoorWidth" onchange="updateDoorPricePreview()" class="w-full p-2 border rounded-lg bg-white">
                      <option value="">Select</option>
                      ${DOOR_WIDTHS.map(w => `<option value="${w.value}">${w.label}</option>`).join('')}
                    </select>
                  </div>

                  <!-- Step 3: Type -->
                  <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">3. Type</label>
                    <select id="newDoorType" class="w-full p-2 border rounded-lg bg-white">
                      <option value="rollup">Roll-Up</option>
                      <option value="sectional">Sectional</option>
                    </select>
                  </div>

                  <!-- Step 4: Placement -->
                  <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">4. Placement</label>
                    <select id="newDoorPlacement" class="w-full p-2 border rounded-lg bg-white">
                      <option value="gabled">Gabled End</option>
                      <option value="eave">Eave Side</option>
                    </select>
                  </div>
                </div>

                <!-- Price Preview -->
                <div id="doorPricePreview" class="bg-white rounded-lg p-3 mb-3 text-center">
                  <p class="text-gray-500 text-sm">Select height and width to see price</p>
                </div>

                <button onclick="addOverheadDoorNew()" class="w-full py-2 bg-[#003057] text-white rounded-lg font-semibold hover:bg-[#004477]">
                  + Add Door
                </button>
              </div>
            </div>

            <!-- DOOR PLACEMENT VISUALIZATION -->
            <div class="border-b pb-6" id="door-placement-preview-section">
              <h3 class="font-bold text-lg mb-3">Door Placement Preview</h3>

              <!-- View Cycling Controls -->
              <div class="flex flex-wrap items-center gap-2 mb-3">
                <span class="text-sm font-medium text-gray-600">View:</span>
                <div class="flex rounded-lg overflow-hidden border border-gray-300">
                  <button onclick="setBuildingView('front')"
                          class="px-3 py-1.5 text-sm font-medium ${state.buildingView === 'front' ? 'bg-[#003057] text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                    Front
                  </button>
                  <button onclick="setBuildingView('back')"
                          class="px-3 py-1.5 text-sm font-medium border-l ${state.buildingView === 'back' ? 'bg-[#003057] text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                    Back
                  </button>
                  <button onclick="setBuildingView('left')"
                          class="px-3 py-1.5 text-sm font-medium border-l ${state.buildingView === 'left' ? 'bg-[#003057] text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                    Left Side
                  </button>
                  <button onclick="setBuildingView('right')"
                          class="px-3 py-1.5 text-sm font-medium border-l ${state.buildingView === 'right' ? 'bg-[#003057] text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                    Right Side
                  </button>
                </div>
              </div>

              <!-- Breezeway Options -->
              <div class="flex flex-wrap gap-4 mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <span class="text-sm font-semibold text-[#003057]">Breezeway (Auto-Center):</span>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" ${state.breezeway.frontBack ? 'checked' : ''}
                         onchange="toggleBreezeway('frontBack')"
                         class="w-4 h-4 rounded border-gray-300 text-[#05c3de] focus:ring-[#05c3de]">
                  <span class="text-sm text-gray-700">Front / Back</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" ${state.breezeway.sideSide ? 'checked' : ''}
                         onchange="toggleBreezeway('sideSide')"
                         class="w-4 h-4 rounded border-gray-300 text-[#05c3de] focus:ring-[#05c3de]">
                  <span class="text-sm text-gray-700">Side / Side</span>
                </label>
              </div>

              ${renderBuildingProfile()}
            </div>

            <!-- COLOR SELECTION -->
            <div>
              <h3 class="font-bold text-lg mb-4">Building Colors</h3>

              <!-- Wall Panels -->
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Wall Panels</label>
                <div class="flex flex-wrap gap-2">
                  ${COLOR_OPTIONS.panels.map(c => `
                    <button onclick="setColor('wallPanels', '${c.id}')"
                            class="w-10 h-10 rounded-lg border-2 ${state.colors.wallPanels === c.id ? 'border-[#003057] ring-2 ring-[#05c3de]' : 'border-gray-300'}"
                            style="background-color: ${c.hex};"
                            title="${c.name}">
                      ${state.colors.wallPanels === c.id ? '<span class="text-xs">✓</span>' : ''}
                    </button>
                  `).join('')}
                </div>
                <p class="text-xs text-gray-500 mt-1">Selected: ${COLOR_OPTIONS.panels.find(c => c.id === state.colors.wallPanels)?.name || 'White'}</p>
              </div>

              <!-- Roof Panels -->
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Roof Panels</label>
                <div class="flex flex-wrap gap-2">
                  ${COLOR_OPTIONS.panels.map(c => `
                    <button onclick="setColor('roofPanels', '${c.id}')"
                            class="w-10 h-10 rounded-lg border-2 ${state.colors.roofPanels === c.id ? 'border-[#003057] ring-2 ring-[#05c3de]' : 'border-gray-300'}"
                            style="background-color: ${c.hex};"
                            title="${c.name}">
                      ${state.colors.roofPanels === c.id ? '<span class="text-xs">✓</span>' : ''}
                    </button>
                  `).join('')}
                </div>
                <p class="text-xs text-gray-500 mt-1">Selected: ${COLOR_OPTIONS.panels.find(c => c.id === state.colors.roofPanels)?.name || 'White'}</p>
              </div>

              <!-- Trim -->
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Trim</label>
                <div class="flex flex-wrap gap-2">
                  ${COLOR_OPTIONS.trim.map(c => `
                    <button onclick="setColor('trim', '${c.id}')"
                            class="w-10 h-10 rounded-lg border-2 ${state.colors.trim === c.id ? 'border-[#003057] ring-2 ring-[#05c3de]' : 'border-gray-300'}"
                            style="background-color: ${c.hex};"
                            title="${c.name}">
                      ${state.colors.trim === c.id ? '<span class="text-xs">✓</span>' : ''}
                    </button>
                  `).join('')}
                </div>
                <p class="text-xs text-gray-500 mt-1">Selected: ${COLOR_OPTIONS.trim.find(c => c.id === state.colors.trim)?.name || 'White'}</p>
              </div>

              <!-- Insulation Color -->
              <div>
                <label class="block text-sm font-semibold mb-2">Insulation (if selected)</label>
                <div class="flex gap-2">
                  ${COLOR_OPTIONS.insulation.map(c => `
                    <button onclick="setColor('insulation', '${c.id}')"
                            class="px-4 py-2 rounded-lg border-2 ${state.colors.insulation === c.id ? 'border-[#003057] ring-2 ring-[#05c3de] bg-gray-100' : 'border-gray-300'}"
                            title="${c.name}">
                      <span class="inline-block w-4 h-4 rounded mr-2" style="background-color: ${c.hex}; border: 1px solid #ccc;"></span>
                      ${c.name}
                    </button>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ← Back
            </button>
            <button onclick="nextStep()" class="py-3 px-8 rounded-xl font-semibold btn-active">
              Next →
            </button>
          </div>
        </main>
      `;
    }

    // Door helper functions
    function adjustExtraWalkthrough(delta) {
      const newQty = Math.max(0, Math.min(4, state.doors.extraWalkthrough + delta));
      state.doors.extraWalkthrough = newQty;
      render();
    }

    function addOverheadDoor() {
      const sizeSelect = document.getElementById('newDoorSize');
      const typeSelect = document.getElementById('newDoorType');
      const placementSelect = document.getElementById('newDoorPlacement');

      if (!sizeSelect.value) {
        alert('Please select a door size');
        return;
      }

      state.doors.overhead.push({
        size: sizeSelect.value,
        type: typeSelect.value,
        placement: placementSelect.value
      });
      render();
    }

    // NEW: Stepwise door selection with height × width
    function updateDoorPricePreview() {
      const heightSelect = document.getElementById('newDoorHeight');
      const widthSelect = document.getElementById('newDoorWidth');
      const previewDiv = document.getElementById('doorPricePreview');

      if (!heightSelect || !widthSelect || !previewDiv) return;

      const height = parseInt(heightSelect.value);
      const width = parseInt(widthSelect.value);

      if (height && width) {
        const price = getDoorPrice(height, width);
        if (price > 0) {
          previewDiv.innerHTML = `
            <p class="text-lg font-bold text-[#003057]">${height}' × ${width}' Door</p>
            <p class="text-2xl font-bold text-green-600">${formatCurrency(price)}</p>
          `;
        } else {
          previewDiv.innerHTML = `<p class="text-red-500 text-sm">Size combination not available</p>`;
        }
      } else {
        previewDiv.innerHTML = `<p class="text-gray-500 text-sm">Select height and width to see price</p>`;
      }
    }

    function addOverheadDoorNew() {
      const heightSelect = document.getElementById('newDoorHeight');
      const widthSelect = document.getElementById('newDoorWidth');
      const typeSelect = document.getElementById('newDoorType');
      const placementSelect = document.getElementById('newDoorPlacement');

      const height = parseInt(heightSelect?.value);
      const width = parseInt(widthSelect?.value);

      if (!height || !width) {
        alert('Please select both door height and width');
        return;
      }

      // Validate against price matrix
      const price = getDoorPrice(height, width);
      if (price <= 0) {
        alert('This size combination is not available. Please select a different size.');
        return;
      }

      // Validate door height against eave height
      const eaveHeight = parseInt(state.eaveHeight);
      if (height > eaveHeight - ADMIN_CONFIG.doorHeightClearance) {
        alert(`Door height cannot exceed ${eaveHeight - ADMIN_CONFIG.doorHeightClearance} ft for a ${eaveHeight} ft eave height.`);
        return;
      }

      state.doors.overhead.push({
        height: height,
        width: width,
        size: `${height}x${width}`,  // For backward compatibility
        type: typeSelect?.value || 'rollup',
        placement: placementSelect?.value || 'gabled'
      });
      render();
    }

    function removeOverheadDoor(index) {
      state.doors.overhead.splice(index, 1);
      render();
    }

    function setColor(colorType, colorId) {
      state.colors[colorType] = colorId;
      render();
    }

    function setBuildingView(view) {
      state.buildingView = view;
      render();
    }

    function toggleBreezeway(type) {
      state.breezeway[type] = !state.breezeway[type];

      // If breezeway is enabled, auto-center doors on appropriate walls
      if (state.breezeway[type]) {
        autoCenterDoorsForBreezeway(type);
      }

      render();
    }

    function autoCenterDoorsForBreezeway(type) {
      // Get building dimensions
      const size = BUILDING_SIZES.find(s => s.id === state.buildingSize);
      if (!size) return;

      const dims = size.label.replace(/'/g, '').split(' × ');
      const buildingWidth = parseInt(dims[0]);
      const buildingDepth = parseInt(dims[1]);

      // SVG dimensions
      const svgWidth = 400;
      const margin = 40;
      const scaledBuildingWidth = svgWidth - margin * 2;

      // Determine which walls to center doors on
      const wallsToCenter = type === 'frontBack' ? ['front', 'back'] : ['left', 'right'];

      // For each wall, find doors assigned to it and center them
      wallsToCenter.forEach(wall => {
        const wallWidth = (wall === 'front' || wall === 'back') ? buildingWidth : buildingDepth;
        const scale = scaledBuildingWidth / wallWidth;

        // Get all gabled doors (these go on front/back) or eave doors (these go on sides)
        const relevantDoors = (state.doors.overhead || []).filter(door => {
          if (wall === 'front' || wall === 'back') {
            return door.placement === 'gabled';
          } else {
            return door.placement === 'eave';
          }
        });

        // Calculate total width of doors
        let totalDoorWidth = 0;
        relevantDoors.forEach(door => {
          const doorWidthFt = door.width || parseInt(door.size?.split('x')[1]) || 10;
          totalDoorWidth += doorWidthFt * scale * 0.8 + 10; // door width + gap
        });
        totalDoorWidth -= 10; // Remove last gap

        // Center position
        const centerX = margin + scaledBuildingWidth / 2 - totalDoorWidth / 2;

        // Set positions for each door
        let currentX = centerX;
        relevantDoors.forEach((door, idx) => {
          const doorId = `overhead-${state.doors.overhead.indexOf(door)}`;
          const positionKey = `${doorId}-${wall}`;
          state.doorPositions[positionKey] = currentX;

          const doorWidthFt = door.width || parseInt(door.size?.split('x')[1]) || 10;
          currentX += doorWidthFt * scale * 0.8 + 10;
        });

        // Also center the standard walkthrough door
        const walkthroughKey = `standard-walkthrough-${wall}`;
        const walkthroughWidth = 3 * scale * 0.8;
        state.doorPositions[walkthroughKey] = margin + scaledBuildingWidth / 2 - walkthroughWidth / 2;
      });
    }

    // Step 4: Add-ons
    function renderAddons() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">${type.name} - ${size.label} × ${eave.label}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(calculateTotal())}</div>
              <div class="text-[#003057] text-xs opacity-80">Estimated Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto p-4">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-[#003057] mb-2">Add-Ons & Options</h2>
            <p class="text-gray-600">Customize your building with additional features</p>
          </div>

          <div class="space-y-6">
            ${ADDONS.filter(cat => cat.cat !== 'Doors').map(category => `
              <div class="bg-white rounded-xl p-4 shadow">
                <h3 class="font-bold text-lg mb-3 text-[#003057]">${category.cat}</h3>
                <div class="space-y-3">
                  ${category.items.filter(item => !item.id.startsWith('door_')).map(item => {
                    const qty = state.addons[item.id] || 0;
                    const selected = qty > 0;

                    // Calculate price display based on pricing type
                    let priceDisplay = formatCurrency(item.price);
                    let priceNote = '';

                    if (item.perLF) {
                      // Gutter pricing: LF-based
                      const gutterLF = calculateGutterLF(state.buildingSize);
                      const gutterPrice = calculateGutterPrice(state.buildingSize);
                      priceDisplay = formatCurrency(gutterPrice);
                      priceNote = `${gutterLF} LF × $${ADMIN_CONFIG.gutterPricePerLF}/LF`;
                    } else if (item.perSqFt) {
                      priceDisplay = formatCurrency(item.perSqFt * size.sqft);
                      priceNote = `${size.sqft} sq ft × $${item.perSqFt}/sq ft`;
                    }

                    // Items with quantity controls
                    if (item.hasQty) {
                      return `
                        <div class="flex items-center justify-between p-3 rounded-lg border-2 ${selected ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 bg-white'}">
                          <div class="flex-1">
                            <span class="font-semibold">${item.name}</span>
                            ${item.note ? `<span class="text-gray-500 text-sm ml-2">(${item.note})</span>` : ''}
                            <div class="text-[#003057] font-bold text-sm">${priceDisplay} each</div>
                          </div>
                          <div class="flex items-center gap-3">
                            <button onclick="adjustAddon('${item.id}', -1, ${item.maxQty || 10})"
                                    class="w-9 h-9 rounded-full bg-gray-200 text-[#003057] font-bold text-lg ${qty === 0 ? 'opacity-50' : ''}">−</button>
                            <span class="text-xl font-bold w-6 text-center">${qty}</span>
                            <button onclick="adjustAddon('${item.id}', 1, ${item.maxQty || 10})"
                                    class="w-9 h-9 rounded-full bg-[#05c3de] text-[#003057] font-bold text-lg">+</button>
                          </div>
                        </div>
                      `;
                    }

                    // Toggle items (yes/no) - special display for perLF items like gutters
                    if (item.perLF) {
                      return `
                        <div class="flex items-center justify-between p-3 rounded-lg border-2 ${selected ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 bg-white'}">
                          <div class="flex-1">
                            <span class="font-semibold">${item.name}</span>
                            <div class="text-xs text-gray-500 mt-1">${priceNote}</div>
                          </div>
                          <div class="flex items-center gap-4">
                            <span class="font-bold text-[#003057]">${priceDisplay}</span>
                            <button onclick="toggleAddon('${item.id}')"
                                    class="w-10 h-10 rounded-full text-lg font-bold"
                                    style="background: ${selected ? '#05c3de' : '#f3f4f6'}; color: ${selected ? 'white' : '#9ca3af'}">
                              ${selected ? '✓' : '+'}
                            </button>
                          </div>
                        </div>
                      `;
                    }

                    // Standard toggle items
                    return `
                      <div class="flex items-center justify-between p-3 rounded-lg border-2 ${selected ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 bg-white'}">
                        <div class="flex-1">
                          <span class="font-semibold">${item.name}</span>
                          ${item.note ? `<span class="text-gray-500 text-sm ml-2">(${item.note})</span>` : ''}
                          ${priceNote ? `<div class="text-xs text-gray-500 mt-1">${priceNote}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-4">
                          <span class="font-bold text-[#003057]">${priceDisplay}</span>
                          <button onclick="toggleAddon('${item.id}')"
                                  class="w-10 h-10 rounded-full text-lg font-bold"
                                  style="background: ${selected ? '#05c3de' : '#f3f4f6'}; color: ${selected ? 'white' : '#9ca3af'}">
                            ${selected ? '✓' : '+'}
                          </button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            `).join('')}
          </div>

          <div class="mt-6 flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ← Back
            </button>
            <button onclick="nextStep()" class="py-3 px-8 rounded-xl font-semibold btn-active">
              View Summary →
            </button>
          </div>
        </main>
      `;
    }

    // Step 5: Summary
    function renderSummary() {
      // Save current building to array if not already there
      if (state.buildingType && state.buildingSize && state.eaveHeight) {
        saveCurrentBuilding();
      }

      const grandTotal = state.buildings.reduce((sum, b) => sum + calculateBuildingTotal(b), 0);
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Generate line items for each building
      function getBuildingLineItems(building, index) {
        const type = BUILDING_TYPES[building.buildingType];
        const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
        const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
        let items = [];

        items.push({ name: `${type.name} - ${size.label} × ${eave.label}`, price: size.startingPrice + eave.modifier });

        // Standard 301 Walk-through door (included in base)
        items.push({ name: `  3070 Walk-Through Door (Standard) - Included`, price: 0 });

        // Overhead doors (use new height × width if available)
        if (building.doors.overhead && building.doors.overhead.length > 0) {
          building.doors.overhead.forEach(door => {
            // Try new height×width price matrix first, fallback to DOOR_SIZES
            let doorPrice = 0;
            let doorLabel = '';

            if (door.height && door.width) {
              doorPrice = getDoorPrice(door.height, door.width);
              doorLabel = `${door.height}' × ${door.width}'`;
            } else {
              const doorSize = DOOR_SIZES.find(d => d.id === door.size);
              doorPrice = doorSize ? doorSize.price : 0;
              doorLabel = doorSize ? doorSize.label : door.size;
            }

            const doorType = door.type === 'rollup' ? 'Roll-Up' : 'Sectional';
            items.push({ name: `  ${doorLabel} ${doorType} Door`, price: doorPrice });
          });
        }

        // Extra walk-through doors
        if (building.doors.extraWalkthrough > 0) {
          items.push({ name: `  Additional Walk-Through × ${building.doors.extraWalkthrough}`, price: building.doors.extraWalkthrough * 1045 });
        }

        // Colors (display only, no extra cost)
        const colors = building.colors || { wallPanels: 'white', roofPanels: 'white', trim: 'white' };
        const wallColor = COLOR_OPTIONS.panels.find(c => c.id === colors.wallPanels)?.name || 'White';
        const roofColor = COLOR_OPTIONS.panels.find(c => c.id === colors.roofPanels)?.name || 'White';
        const trimColor = COLOR_OPTIONS.trim.find(c => c.id === colors.trim)?.name || 'White';
        items.push({ name: `  Colors: ${wallColor} walls, ${roofColor} roof, ${trimColor} trim`, price: 0 });

        ADDONS.forEach(cat => {
          cat.items.forEach(item => {
            const qty = building.addons[item.id] || 0;
            if (qty > 0 && !item.id.startsWith('door_')) {
              let price = 0;
              let displayName = `  ${item.name}`;

              if (item.perLF) {
                // Gutter pricing: LF-based
                const gutterLF = calculateGutterLF(building.buildingSize);
                price = calculateGutterPrice(building.buildingSize);
                displayName = `  ${item.name} (${gutterLF} LF)`;
              } else if (item.perSqFt) {
                price = item.perSqFt * size.sqft;
              } else {
                price = item.price * qty;
                displayName = qty > 1 ? `  ${item.name} × ${qty}` : `  ${item.name}`;
              }

              items.push({ name: displayName, price });
            }
          });
        });

        return items;
      }

      return `
        <header class="header-bar p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              ${LOGO_SVG_SMALL}
              <div>
                <h1 class="text-lg font-bold text-[#003057]">Gryphon FrameWorks</h1>
                <p class="text-[#003057] text-sm opacity-80">Order Summary</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-[#003057]">${formatCurrency(grandTotal)}</div>
              <div class="text-[#003057] text-xs opacity-80">${totalBuildingQty} Building${totalBuildingQty !== 1 ? 's' : ''} Total</div>
            </div>
          </div>
        </header>

        <main class="max-w-2xl mx-auto p-4">
          <!-- Building Cards -->
          ${state.buildings.map((building, index) => {
            const type = BUILDING_TYPES[building.buildingType];
            const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
            const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
            const unitPrice = getBuildingUnitPrice(building);
            const buildingQty = building.qty || 1;
            const buildingTotal = calculateBuildingTotal(building);
            const lineItems = getBuildingLineItems(building, index);

            return `
              <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-4">
                <div class="bg-[#003057] text-white p-4">
                  <div class="flex justify-between items-start">
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <span class="bg-[#05c3de] text-[#003057] text-xs font-bold px-2 py-1 rounded">Building ${index + 1}</span>
                      </div>
                      <h2 class="text-lg font-bold">${type.name} - ${size.label} × ${eave.label}</h2>
                      <p class="text-sm opacity-80 mt-1">Unit Price: ${formatCurrency(unitPrice)}</p>
                    </div>
                    <div class="text-right">
                      <div class="text-xl font-bold">${formatCurrency(buildingTotal)}</div>
                      ${buildingQty > 1 ? `<div class="text-xs opacity-80">(${buildingQty} × ${formatCurrency(unitPrice)})</div>` : ''}
                    </div>
                  </div>

                  <!-- Quantity Selector -->
                  <div class="mt-3 flex items-center justify-between bg-[#01315b] rounded-lg p-3">
                    <span class="text-sm font-medium">How many of this building?</span>
                    <div class="flex items-center gap-3">
                      <button onclick="adjustBuildingQty(${index}, -1)"
                              class="w-10 h-10 rounded-full bg-[#05c3de] text-[#003057] font-bold text-xl flex items-center justify-center hover:bg-[#04ceea] transition-colors ${buildingQty <= 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                        −
                      </button>
                      <span class="text-2xl font-bold w-12 text-center">${buildingQty}</span>
                      <button onclick="adjustBuildingQty(${index}, 1)"
                              class="w-10 h-10 rounded-full bg-[#05c3de] text-[#003057] font-bold text-xl flex items-center justify-center hover:bg-[#04ceea] transition-colors">
                        +
                      </button>
                    </div>
                  </div>
                </div>

                <div class="p-4">
                  <table class="w-full text-sm">
                    <tbody>
                      ${lineItems.map(item => `
                        <tr class="border-b border-gray-100">
                          <td class="py-2 text-gray-700">${item.name}</td>
                          <td class="py-2 text-right font-medium">${formatCurrency(item.price)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>

                <div class="px-4 pb-4 flex gap-2">
                  <button onclick="editBuilding(${index})" class="flex-1 py-2 text-sm font-semibold text-[#003057] border-2 border-[#003057] rounded-lg hover:bg-gray-50">
                    ${ICON_EDIT} Edit
                  </button>
                  ${state.buildings.length > 1 ? `
                    <button onclick="removeBuilding(${index})" class="py-2 px-4 text-sm font-semibold text-red-600 border-2 border-red-300 rounded-lg hover:bg-red-50">
                      ${ICON_TRASH}
                    </button>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}

          <!-- Add Another Building Button -->
          <button onclick="addAnotherBuilding()"
                  class="w-full py-4 mb-4 border-2 border-dashed border-[#05c3de] rounded-xl text-[#003057] font-semibold hover:bg-[#e0f7fa] transition-colors">
            ${ICON_PLUS} Add Another Building
          </button>

          <!-- Grand Total -->
          <div class="bg-[#003057] text-white rounded-xl p-4 mb-4">
            <div class="flex justify-between items-center">
              <div>
                <div class="text-sm opacity-80">${totalBuildingQty} Building${totalBuildingQty !== 1 ? 's' : ''} (${configCount} config${configCount !== 1 ? 's' : ''})</div>
                <div class="text-lg font-bold">Grand Total</div>
              </div>
              <div class="text-3xl font-bold">${formatCurrency(grandTotal)}</div>
            </div>
          </div>

          <div class="bg-[#e0f7fa] rounded-xl p-4 mb-6">
            <p class="text-sm text-gray-700">
              <strong>Note:</strong> This is an estimate. Final pricing will be confirmed in the contract.
              Prices shown are "starting at" prices and may vary based on site conditions and final specifications.
            </p>
          </div>

          <div class="flex justify-between">
            <button onclick="goBack()" class="py-3 px-6 rounded-xl font-semibold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
              ← Back
            </button>
            <button onclick="proceedToContract()" class="py-3 px-8 rounded-xl font-semibold btn-primary">
              Proceed to Contract →
            </button>
          </div>
        </main>
      `;
    }

    // Contract Flow (Step 6+)
    function renderContract() {
      const section = CONTRACT_SECTIONS[state.contractStep];
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      const total = calculateTotal();

      return `
        <header class="header-bar p-3 shadow-lg no-print">
          <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                ${LOGO_SVG_SMALL}
                <div>
                  <h1 class="text-lg font-bold text-[#003057]">Gryphon FrameWorks</h1>
                  <p class="text-[#003057] text-xs opacity-80">${type.name} - ${size.label} × ${eave.label}</p>
                </div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-[#003057]">${formatCurrency(total)}</div>
                <div class="text-[#003057] text-xs opacity-80">Contract Sum</div>
              </div>
            </div>

            <!-- Progress indicator (clickable) -->
            <div class="flex items-center justify-center gap-1 mt-2 overflow-x-auto pb-1">
              ${CONTRACT_SECTIONS.map((s, i) => `
                <div class="flex items-center">
                  <div onclick="${i <= state.contractStep ? `goToContractStep(${i})` : ''}"
                       title="${s.title}"
                       class="progress-step ${i < state.contractStep ? 'completed' : i === state.contractStep ? 'current' : 'pending'}">
                    ${i < state.contractStep ? '✓' : i + 1}
                  </div>
                  ${i < CONTRACT_SECTIONS.length - 1 ? `<div class="w-3 h-0.5" style="background: ${i < state.contractStep ? '#05c3de' : '#003057'}"></div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </header>

        <main class="max-w-2xl mx-auto p-4">
          ${renderContractSection()}

          <div class="mt-6 flex justify-between items-center no-print">
            <button onclick="prevContractStep()" ${state.contractStep === 0 ? 'disabled' : ''}
                    class="py-3 px-6 rounded-xl font-semibold ${state.contractStep === 0 ? 'bg-gray-100 text-gray-400' : 'border-2 border-gray-300 text-gray-600 hover:bg-gray-50'}">
              ← Back
            </button>

            <div class="text-center">
              <p id="sectionWarning" class="text-sm text-red-500 mb-1"></p>
            </div>

            ${state.contractStep < CONTRACT_SECTIONS.length - 1 ? `
              <button id="nextSectionBtn" onclick="nextContractStep()"
                      class="py-3 px-6 rounded-xl font-semibold btn-primary">
                Next Section →
              </button>
            ` : `
              <button onclick="sendContract()" ${state.sending ? 'disabled' : ''}
                      class="py-3 px-6 rounded-xl font-semibold btn-primary">
                ${state.sending ? 'Sending...' : '${ICON_EMAIL} Send Contract'}
              </button>
            `}
          </div>
        </main>
      `;
    }

    function renderContractSection() {
      const section = CONTRACT_SECTIONS[state.contractStep];

      switch(section.id) {
        case 'info': return renderCustomerInfo();
        case 'projectOverview': return renderProjectOverview();
        case 'paymentTerms': return renderPaymentTerms();
        case 'timeline': return renderTimeline();
        case 'responsibilities': return renderResponsibilities();
        case 'warranties': return renderWarranties();
        case 'legalProvisions': return renderLegalProvisions();
        case 'signatures': return renderSignatures();
        default: return '<p>Section not found</p>';
      }
    }

    // Contract Section: Customer Info
    function renderCustomerInfo() {
      const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_USER} Customer Information</h3>

          <div class="space-y-4">
            <div>
              <label class="block font-semibold text-gray-700 mb-1">Full Legal Name *</label>
              <input type="text" id="customerName" value="${state.customer.name}" oninput="updateCustomer('name', this.value)"
                     class="border-2 rounded-lg p-3 w-full text-lg ${state.customer.name ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Enter full legal name">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-semibold text-gray-700 mb-1">Phone Number *</label>
                <input type="tel" id="customerPhone" value="${state.customer.phone}" oninput="updateCustomer('phone', this.value)"
                       class="border-2 rounded-lg p-3 w-full text-lg ${state.customer.phone ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="(555) 555-5555">
              </div>
              <div>
                <label class="block font-semibold text-gray-700 mb-1">Email Address *</label>
                <input type="email" id="customerEmail" value="${state.customer.email}" oninput="updateCustomer('email', this.value)"
                       class="border-2 rounded-lg p-3 w-full text-lg ${state.customer.email ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="you@email.com">
              </div>
            </div>

            <!-- Mailing Address Section -->
            <div class="border-t pt-4 mt-4">
              <h4 class="font-bold text-gray-800 mb-3">${ICON_LOCATION} Mailing Address</h4>
              <div class="space-y-3">
                <div>
                  <label class="block font-semibold text-gray-700 mb-1">Address Line 1 *</label>
                  <input type="text" value="${state.customer.address1}" oninput="updateCustomer('address1', this.value)"
                         class="border-2 rounded-lg p-3 w-full ${state.customer.address1 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Street address">
                </div>
                <div>
                  <label class="block font-semibold text-gray-700 mb-1">Address Line 2</label>
                  <input type="text" value="${state.customer.address2}" oninput="updateCustomer('address2', this.value)"
                         class="border-2 rounded-lg p-3 w-full ${state.customer.address2 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Apt, Suite, Unit, etc. (optional)">
                </div>
                <div class="grid grid-cols-6 gap-3">
                  <div class="col-span-3">
                    <label class="block font-semibold text-gray-700 mb-1">City *</label>
                    <input type="text" value="${state.customer.city}" oninput="updateCustomer('city', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.city ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="City">
                  </div>
                  <div class="col-span-1">
                    <label class="block font-semibold text-gray-700 mb-1">State *</label>
                    <select onchange="updateCustomer('state', this.value)"
                            class="border-2 rounded-lg p-3 w-full ${state.customer.state ? 'border-[#05c3de]' : 'border-gray-300'}">
                      ${states.map(s => `<option value="${s}" ${state.customer.state === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                  </div>
                  <div class="col-span-2">
                    <label class="block font-semibold text-gray-700 mb-1">Zip Code *</label>
                    <input type="text" value="${state.customer.zip}" oninput="updateCustomer('zip', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.zip ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Zip">
                  </div>
                </div>
              </div>
            </div>

            <!-- Property Address Section -->
            <div class="border-t pt-4 mt-4">
              <h4 class="font-bold text-gray-800 mb-3">${ICON_CONSTRUCTION} Property Address (Construction Site)</h4>
              <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                <input type="checkbox" id="sameAsMailing" ${state.customer.propertySameAsMailing ? 'checked' : ''}
                       onchange="toggleSameAsMailing()" class="w-5 h-5 cursor-pointer">
                <label for="sameAsMailing" class="cursor-pointer font-medium text-gray-700">
                  Property address is the same as mailing address
                </label>
              </div>

              ${!state.customer.propertySameAsMailing ? `
                <div class="space-y-3">
                  <div>
                    <label class="block font-semibold text-gray-700 mb-1">Address Line 1 *</label>
                    <input type="text" value="${state.customer.propertyAddress1}" oninput="updateCustomer('propertyAddress1', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.propertyAddress1 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Street address">
                  </div>
                  <div>
                    <label class="block font-semibold text-gray-700 mb-1">Address Line 2</label>
                    <input type="text" value="${state.customer.propertyAddress2}" oninput="updateCustomer('propertyAddress2', this.value)"
                           class="border-2 rounded-lg p-3 w-full ${state.customer.propertyAddress2 ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Apt, Suite, Unit, etc. (optional)">
                  </div>
                  <div class="grid grid-cols-6 gap-3">
                    <div class="col-span-3">
                      <label class="block font-semibold text-gray-700 mb-1">City *</label>
                      <input type="text" value="${state.customer.propertyCity}" oninput="updateCustomer('propertyCity', this.value)"
                             class="border-2 rounded-lg p-3 w-full ${state.customer.propertyCity ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="City">
                    </div>
                    <div class="col-span-1">
                      <label class="block font-semibold text-gray-700 mb-1">State *</label>
                      <select onchange="updateCustomer('propertyState', this.value)"
                              class="border-2 rounded-lg p-3 w-full ${state.customer.propertyState ? 'border-[#05c3de]' : 'border-gray-300'}">
                        ${states.map(s => `<option value="${s}" ${state.customer.propertyState === s ? 'selected' : ''}>${s}</option>`).join('')}
                      </select>
                    </div>
                    <div class="col-span-2">
                      <label class="block font-semibold text-gray-700 mb-1">Zip Code *</label>
                      <input type="text" value="${state.customer.propertyZip}" oninput="updateCustomer('propertyZip', this.value)"
                             class="border-2 rounded-lg p-3 w-full ${state.customer.propertyZip ? 'border-[#05c3de]' : 'border-gray-300'}" placeholder="Zip">
                    </div>
                  </div>
                </div>
              ` : `
                <div class="bg-[#e0f7fa] p-4 rounded-lg border-2 border-[#05c3de]">
                  <p class="text-[#003057]">✓ Using mailing address as property address</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function toggleSameAsMailing() {
      state.customer.propertySameAsMailing = !state.customer.propertySameAsMailing;
      if (state.customer.propertySameAsMailing) {
        // Copy mailing address to property address
        state.customer.propertyAddress1 = state.customer.address1;
        state.customer.propertyAddress2 = state.customer.address2;
        state.customer.propertyCity = state.customer.city;
        state.customer.propertyState = state.customer.state;
        state.customer.propertyZip = state.customer.zip;
      }
      render();
    }

    // Contract Section 1: Project Overview (consolidated)
    function renderProjectOverview() {
      const sectionData = state.sections.projectOverview;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_BOOK} Section 1: Project Overview</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DEFINITIONS</h4>
            <div class="legal-text space-y-2">
              <p><strong>"Owner"</strong> means the property owner signing this Contract.</p>
              <p><strong>"Contractor"</strong> means Gryphon FrameWorks, LLC.</p>
              <p><strong>"Work"</strong> means all labor, materials, equipment, and services required to complete the Project.</p>
              <p><strong>"Contract Sum"</strong> means the total price stated in this Contract for the Work.</p>
              <p><strong>"Substantial Completion"</strong> means the Work is sufficiently complete so the Owner can occupy or use the Project for its intended purpose.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">SCOPE OF CONTRACT</h4>
            <div class="legal-text">
              <p>This Contract Agreement covers Improvements only <strong>from drip edge to drip edge</strong>.</p>
              <p class="mt-2">The scope includes the metal building structure as configured in the estimate. Any work outside this scope requires a written Change Order.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">PLANS & REVISIONS</h4>
            <div class="legal-text">
              <p>Owner has <strong>3 opportunities</strong> to redo/amend/revise the Plans before Work commences at no cost.</p>
              <p class="mt-2">On the 4th revision and every revision thereafter: <strong>$550.00</strong> per revision.</p>
              <p class="mt-2">All requested revisions after work commences shall be a Change Order.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('projectOverview', isComplete)}
        </div>
      `;
    }

    // Contract Section 2: Payment Terms
    function renderPaymentTerms() {
      const sectionData = state.sections.paymentTerms;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_MONEY} Section 2: Payment Terms</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DRAW SCHEDULE</h4>
            <div class="legal-text">
              <p><strong>Draw 1 (30%):</strong> Due upon contract signing</p>
              <p><strong>Draw 2 (30%):</strong> Due upon delivery of materials to job site</p>
              <p><strong>Draw 3 (30%):</strong> Due upon completion of framing</p>
              <p><strong>Final Draw (10%):</strong> Due upon Substantial Completion</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">MATERIAL COSTS</h4>
            <div class="legal-text">
              <p>Material prices are subject to market fluctuations. If material costs increase more than <strong>5%</strong> between contract signing and material ordering, Owner will be notified and may:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Accept the price increase via Change Order</li>
                <li>Cancel the contract with refund of deposits less administrative fees</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">ADDITIONAL COSTS</h4>
            <div class="legal-text">
              <p><strong>Contractor's Risk Policy, Dirt Work & Pump Truck:</strong></p>
              <p>These expenses are at <strong>cost plus 20%</strong> due from Owner.</p>
              <p class="mt-2">Payment is due <strong>before the delivery of Foundation Material</strong>.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('paymentTerms', isComplete)}
        </div>
      `;
    }

    // Contract Section 3: Timeline & Changes
    function renderTimeline() {
      const sectionData = state.sections.timeline;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_CALENDAR} Section 3: Timeline & Changes</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CHANGE ORDERS</h4>
            <div class="legal-text">
              <p>Changes to the Work require a written Change Order signed by both parties.</p>
              <p class="mt-2">Change Orders will specify:</p>
              <ul class="list-disc ml-6">
                <li>Description of the change</li>
                <li>Adjustment to Contract Sum</li>
                <li>Adjustment to schedule (if any)</li>
              </ul>
              <p class="mt-2">Work on changes shall not begin until the Change Order is signed and any required payment is received.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DELAYS & FORCE MAJEURE</h4>
            <div class="legal-text">
              <p>Contractor shall not be liable for delays caused by:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Weather conditions unsuitable for construction</li>
                <li>Acts of God, natural disasters, or emergencies</li>
                <li>Material shortages or supplier delays beyond Contractor's control</li>
                <li>Government actions, inspections, or permit delays</li>
                <li>Owner-requested changes or Owner-caused delays</li>
              </ul>
              <p class="mt-2">The project timeline will be extended by the duration of any such delays.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('timeline', isComplete)}
        </div>
      `;
    }

    // Contract Section 4: Responsibilities
    function renderResponsibilities() {
      const sectionData = state.sections.responsibilities;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_WRENCH} Section 4: Responsibilities</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONTRACTOR RESPONSIBILITIES</h4>
            <div class="legal-text">
              <p>Contractor shall:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Perform all Work in a good and workmanlike manner</li>
                <li>Furnish all labor, materials, and equipment necessary for the Work</li>
                <li>Comply with all applicable building codes and regulations</li>
                <li>Maintain a safe job site</li>
                <li>Obtain necessary permits (permit fees are Owner's responsibility)</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">OWNER RESPONSIBILITIES</h4>
            <div class="legal-text">
              <p>Owner shall:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Provide clear access to the job site</li>
                <li>Ensure the site is ready for construction (clear, level, accessible)</li>
                <li>Make timely payments according to the draw schedule</li>
                <li>Make decisions and provide approvals in a timely manner</li>
                <li>Notify Contractor of any known site conditions</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONSUMER PRODUCTS NOTICE</h4>
            <div class="legal-text">
              <p>Materials used may include products from third-party manufacturers. Contractor assigns to Owner any manufacturer warranties on such products but makes no independent warranty on consumer products.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('responsibilities', isComplete)}
        </div>
      `;
    }

    // Contract Section 5: Warranties & Insurance
    function renderWarranties() {
      const sectionData = state.sections.warranties;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_SHIELD} Section 5: Warranties & Insurance</h3>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONTRACTOR WARRANTY</h4>
            <div class="legal-text">
              <p>Contractor warrants the Work against defects in workmanship for a period of <strong>ONE (1) YEAR</strong> from the date of Substantial Completion.</p>
              <p class="mt-2">This warranty covers defects in the Contractor's labor and installation only.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">WARRANTY LIMITATIONS</h4>
            <div class="legal-text">
              <p>The warranty does NOT cover:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Normal wear and tear</li>
                <li>Damage caused by Owner, third parties, or Acts of God</li>
                <li>Modifications made by anyone other than Contractor</li>
                <li>Failure to maintain the building properly</li>
                <li>Manufacturer product defects (covered by manufacturer warranty)</li>
              </ul>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">INSURANCE</h4>
            <div class="legal-text">
              <p>Contractor maintains:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>General Liability Insurance</li>
                <li>Workers' Compensation Insurance</li>
              </ul>
              <p class="mt-2">Owner is responsible for insuring the property and structure once Substantial Completion is achieved.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">EARLY OCCUPATION</h4>
            <div class="legal-text">
              <p>If Owner occupies or uses the Project before Substantial Completion:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Owner assumes all risk of loss or damage</li>
                <li>Owner must maintain insurance on the structure</li>
                <li>Warranty period begins on the date of early occupation</li>
              </ul>
            </div>
          </div>

          ${renderSectionAcknowledgment('warranties', isComplete)}
        </div>
      `;
    }

    // Contract Section 6: Legal Provisions
    function renderLegalProvisions() {
      const sectionData = state.sections.legalProvisions;
      const isComplete = sectionData.checked && sectionData.initialed;

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_SCALE} Section 6: Legal Provisions</h3>

          <div class="contract-section bg-red-50 border-red-200">
            <h4 class="font-bold mb-2 text-red-800">${ICON_WARNING} IMPORTANT LEGAL NOTICES - READ CAREFULLY</h4>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">DEFAULT & LIABILITY</h4>
            <div class="legal-text">
              <p><strong>If Owner defaults</strong> (fails to make payment or breaches this Contract), Contractor may:</p>
              <ul class="list-disc ml-6 mt-2">
                <li>Stop Work and remove equipment from the site</li>
                <li>Retain all payments received</li>
                <li>Pursue all legal remedies available</li>
              </ul>
              <p class="mt-4"><strong>LIMITATION ON LIABILITY:</strong></p>
              <p class="font-semibold">NEITHER PARTY SHALL BE LIABLE TO THE OTHER FOR SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">BINDING ARBITRATION</h4>
            <div class="legal-text">
              <p class="font-semibold text-red-700">IMPORTANT - READ CAREFULLY:</p>
              <p class="mt-2">Any dispute arising from this Contract:</p>
              <ol class="list-decimal ml-6 mt-2">
                <li><strong>SHALL FIRST BE SUBMITTED TO MEDIATION</strong></li>
                <li>If not settled during mediation, <strong>SHALL THEREAFTER BE SUBMITTED TO BINDING ARBITRATION</strong></li>
              </ol>
              <p class="mt-2">as provided by the <strong>Federal Arbitration Act (9 U.S.C. §1 et seq.)</strong></p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">JURY TRIAL WAIVER</h4>
            <div class="legal-text">
              <p class="font-semibold">BOTH PARTIES VOLUNTARILY AND KNOWINGLY WAIVE ANY RIGHT TO A TRIAL BY JURY</p>
              <p class="mt-2">in any action or proceeding arising out of or related to this Contract.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">TEXAS RCLA NOTICE</h4>
            <div class="legal-text">
              <p class="font-semibold">IMPORTANT NOTICE REGARDING CONSTRUCTION DEFECTS:</p>
              <p class="mt-2">Chapter 27 of the Texas Property Code requires that before you file a lawsuit for defective construction against the Contractor, you must:</p>
              <ol class="list-decimal ml-6 mt-2">
                <li>Give Contractor written notice of the defect at least 60 days before filing suit</li>
                <li>Allow Contractor to inspect the property</li>
                <li>Allow Contractor the opportunity to make a written offer to repair or settle</li>
              </ol>
              <p class="mt-2">Failure to follow these procedures may affect your legal rights.</p>
            </div>
          </div>

          <div class="contract-section">
            <h4 class="font-bold mb-2">CONFIDENTIALITY</h4>
            <div class="legal-text">
              <p>Both parties agree to keep confidential the terms of this Contract and any proprietary information exchanged during the Project.</p>
            </div>
          </div>

          ${renderSectionAcknowledgment('legalProvisions', isComplete)}
        </div>
      `;
    }

    // Contract Section 7: Final Signatures
    function renderSignatures() {
      const type = BUILDING_TYPES[state.buildingType];
      const size = getSelectedSize();
      const eave = getSelectedEave();
      const total = calculateTotal();

      return `
        <div class="bg-white rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-[#003057]">${ICON_PEN} Section 7: Final Acknowledgment & Signatures</h3>

          <div class="contract-section bg-[#e0f7fa]">
            <h4 class="font-bold mb-2">CONTRACT SUMMARY</h4>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
              <div>
                <p><strong>Building Type:</strong> ${type.name}</p>
                <p><strong>Size:</strong> ${size.label}</p>
                <p><strong>Eave Height:</strong> ${eave.label}</p>
              </div>
              <div>
                <p><strong>Contract Sum:</strong> ${formatCurrency(total)}</p>
                <p><strong>Owner:</strong> ${state.customer.name || 'Not entered'}</p>
                <p><strong>Contractor:</strong> Gryphon FrameWorks, LLC</p>
              </div>
            </div>
          </div>

          <div class="contract-section">
            <p class="legal-text font-semibold">By signing below, both parties acknowledge that:</p>
            <ul class="list-disc ml-6 mt-2 legal-text">
              <li>They have read and understand ALL sections of this Contract</li>
              <li>They have had the opportunity to consult with an attorney</li>
              <li>They agree to be bound by the terms and conditions herein</li>
              <li>The Contractor has personally walked the Owner through every section</li>
            </ul>
          </div>

          <!-- Owner Signature -->
          <div class="mt-6">
            <h4 class="font-bold text-lg mb-3">Owner Signature</h4>
            <div id="ownerSigContainer" class="bg-white p-4 rounded-lg border-2 ${state.ownerTypedName && state.ownerSigned ? 'border-[#05c3de]' : 'border-gray-300'}">
              <div class="mb-3">
                <label class="block text-sm font-semibold mb-1">Print Name:</label>
                <input type="text" id="ownerTypedNameInput" value="${state.ownerTypedName}" oninput="updateOwnerName(this.value)"
                       class="border-2 rounded-lg p-2 w-full ${state.ownerTypedName ? 'border-[#05c3de]' : 'border-gray-300'}"
                       placeholder="Type your full legal name">
              </div>
              <label class="block text-sm font-semibold mb-1">Signature:</label>
              <canvas id="ownerSigPad" width="400" height="100" class="signature-pad w-full ${state.ownerSigned ? 'signed' : ''}"></canvas>
              <button onclick="clearOwnerSignature()" class="mt-2 text-sm text-gray-500 hover:text-gray-700">Clear signature</button>
            </div>
          </div>

          <!-- Contractor Signature -->
          <div class="mt-6">
            <h4 class="font-bold text-lg mb-3">Contractor Signature</h4>
            <div id="contractorSigContainer" class="bg-white p-4 rounded-lg border-2 ${state.contractorTypedName && state.contractorSigned ? 'border-[#05c3de]' : 'border-gray-300'}">
              <div class="mb-3">
                <label class="block text-sm font-semibold mb-1">Print Name:</label>
                <input type="text" id="contractorTypedNameInput" value="${state.contractorTypedName}" oninput="updateContractorName(this.value)"
                       class="border-2 rounded-lg p-2 w-full ${state.contractorTypedName ? 'border-[#05c3de]' : 'border-gray-300'}">
                <p class="text-xs text-gray-500 mt-1">Company: Gryphon FrameWorks, LLC</p>
              </div>
              <label class="block text-sm font-semibold mb-1">Signature:</label>
              <canvas id="contractorSigPad" width="400" height="100" class="signature-pad w-full ${state.contractorSigned ? 'signed' : ''}"></canvas>
              <button onclick="clearContractorSignature()" class="mt-2 text-sm text-gray-500 hover:text-gray-700">Clear signature</button>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="mt-6">
            <h4 class="font-bold text-lg mb-3">Payment Method for First Draw</h4>
            <div class="bg-[#e0f7fa] p-4 rounded-lg border-2 border-[#05c3de] mb-4">
              <p class="text-sm"><strong>First Draw Due:</strong> ${formatCurrency(Math.round(total * 0.30))} (30% of Contract Sum)</p>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              ${['cash', 'check', 'card', 'financing', 'ach'].map(method => `
                <button onclick="selectPaymentMethod('${method}')"
                        class="p-3 rounded-lg border-2 text-center ${state.paymentMethod === method ? 'border-[#05c3de] bg-[#e0f7fa]' : 'border-gray-200 hover:border-gray-300'}">
                  <span class="font-semibold capitalize">${method === 'ach' ? 'ACH Transfer' : method}</span>
                </button>
              `).join('')}
            </div>
            ${state.paymentMethod === 'card' ? `
              <p class="mt-3 text-sm text-[#003057]">${ICON_CREDIT_CARD} Card payment will be processed separately. Contractor will collect card information securely.</p>
            ` : ''}
          </div>

          ${state.sent ? `
            <div class="mt-6 bg-green-50 border-2 border-green-500 rounded-xl p-4 text-center">
              <p class="text-green-800 font-bold text-lg">${ICON_CHECK_CIRCLE} Contract Sent Successfully!</p>
              <p class="text-green-700">Copies have been sent to both parties.</p>
              <div class="flex flex-col sm:flex-row gap-3 justify-center mt-4">
                <button onclick="downloadContract()" class="py-3 px-6 btn-secondary rounded-lg font-semibold">${ICON_DOWNLOAD} Contract</button>
                <button onclick="downloadBOM()" class="py-3 px-6 btn-secondary rounded-lg font-semibold">${ICON_CLIPBOARD} Bill of Materials</button>
                <button onclick="printContract()" class="py-3 px-6 btn-primary rounded-lg font-semibold">${ICON_PRINT} Print</button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Helper: Render Section Acknowledgment
    function renderSectionAcknowledgment(sectionId, isComplete) {
      const sectionData = state.sections[sectionId];
      return `
        <div class="section-ack ${isComplete ? 'complete' : ''}">
          <div class="flex items-start gap-3 mb-4">
            <input type="checkbox" id="check_${sectionId}" ${sectionData.checked ? 'checked' : ''}
                   onchange="toggleSectionCheck('${sectionId}')"
                   class="w-5 h-5 mt-1 cursor-pointer">
            <label for="check_${sectionId}" class="cursor-pointer">
              <span class="font-semibold">I have read and understand this section.</span>
              <span class="text-gray-600 text-sm block">By checking this box, I acknowledge that I have read, understand, and agree to the terms above.</span>
            </label>
          </div>

          <div class="initials-container">
            <label class="block text-sm font-semibold mb-2 text-center">Initial Below to Acknowledge:</label>
            <canvas id="initials_${sectionId}" width="200" height="70"
                    class="initials-pad ${sectionData.initialed ? 'signed' : ''}"></canvas>
            <button onclick="clearInitials('${sectionId}')"
                    class="mt-3 px-4 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md hover:bg-gray-50">
              Clear Initials
            </button>
            ${isComplete ? '<div class="mt-3 text-green-600 font-semibold text-center">✓ Section Complete</div>' : ''}
          </div>
        </div>
      `;
    }

    // ==================== EVENT HANDLERS ====================

    function selectBuildingType(type) {
      state.buildingType = type;
      render();
    }

    function selectSize(sizeId) {
      state.buildingSize = sizeId;
      render();
    }

    function selectEave(eaveId) {
      state.eaveHeight = eaveId;
      render();
    }

    function adjustDoor(doorType, delta) {
      const current = state.doors[doorType].qty;
      state.doors[doorType].qty = Math.max(0, Math.min(4, current + delta));
      render();
    }

    function updateDoorPlacement(doorType, placement) {
      state.doors[doorType].placement = placement;
    }

    function toggleAddon(id) {
      // Toggle between 0 and 1 for non-qty items
      state.addons[id] = state.addons[id] ? 0 : 1;
      render();
    }

    function adjustAddon(id, delta, maxQty) {
      const current = state.addons[id] || 0;
      state.addons[id] = Math.max(0, Math.min(maxQty, current + delta));
      render();
    }

    function nextStep() {
      if (state.buildingType === 'boltUp' && state.step === 0) {
        state.step = 1; // Will render bolt-up form
      } else {
        state.step++;
      }
      render();
    }

    function goBack() {
      if (state.step > 0) {
        // Going back from summary - load the last building for editing
        if (state.step === 5 && state.buildings.length > 0) {
          const lastIndex = state.buildings.length - 1;
          const building = state.buildings[lastIndex];
          state.currentBuildingIndex = lastIndex;
          state.buildingType = building.buildingType;
          state.buildingSize = building.buildingSize;
          state.eaveHeight = building.eaveHeight;
          state.doors = JSON.parse(JSON.stringify(building.doors));
          state.addons = JSON.parse(JSON.stringify(building.addons));
          // Remove from array since we're editing
          state.buildings.pop();
          state.step = 4; // Go to addons
        } else {
          state.step--;
          if (state.buildingType === 'boltUp' && state.step === 0) {
            state.buildingType = null;
          }
        }
      }
      render();
    }

    function proceedToContract() {
      state.step = 6;
      state.contractStep = 0;
      render();
    }

    function nextContractStep() {
      const section = CONTRACT_SECTIONS[state.contractStep];

      // Validate current section if it requires acknowledgment
      if (section.requiresAck) {
        const sectionData = state.sections[section.id];
        if (!sectionData.checked || !sectionData.initialed) {
          document.getElementById('sectionWarning').textContent = 'Please check the box and add your initials to continue.';
          return;
        }
      }

      // Validate customer info
      if (section.id === 'info') {
        // Check basic info
        if (!state.customer.name || !state.customer.phone || !state.customer.email) {
          document.getElementById('sectionWarning').textContent = 'Please fill in name, phone, and email.';
          return;
        }
        // Check mailing address
        if (!state.customer.address1 || !state.customer.city || !state.customer.state || !state.customer.zip) {
          document.getElementById('sectionWarning').textContent = 'Please fill in complete mailing address.';
          return;
        }
        // Check property address (if not same as mailing)
        if (!state.customer.propertySameAsMailing) {
          if (!state.customer.propertyAddress1 || !state.customer.propertyCity || !state.customer.propertyState || !state.customer.propertyZip) {
            document.getElementById('sectionWarning').textContent = 'Please fill in complete property address or check "same as mailing".';
            return;
          }
        }
      }

      state.contractStep++;
      render();

      // Initialize signature pads if on signatures section
      if (CONTRACT_SECTIONS[state.contractStep].id === 'signatures') {
        setTimeout(initSignaturePads, 100);
      }
    }

    function prevContractStep() {
      if (state.contractStep > 0) {
        state.contractStep--;
        render();
      }
    }

    // Navigate directly to a specific contract step (only if already visited)
    function goToContractStep(stepIndex) {
      if (stepIndex >= 0 && stepIndex <= state.contractStep) {
        state.contractStep = stepIndex;
        render();
        // Re-initialize signature pads if going to signatures section
        if (CONTRACT_SECTIONS[stepIndex].id === 'signatures') {
          setTimeout(initSignaturePads, 100);
        }
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function toggleSectionCheck(sectionId) {
      state.sections[sectionId].checked = !state.sections[sectionId].checked;
      updateNavigationState();
    }

    function updateNavigationState() {
      const section = CONTRACT_SECTIONS[state.contractStep];
      if (!section.requiresAck) return;

      const sectionData = state.sections[section.id];
      const canProceed = sectionData.checked && sectionData.initialed;

      const nextBtn = document.getElementById('nextSectionBtn');
      const warning = document.getElementById('sectionWarning');

      if (nextBtn) {
        nextBtn.disabled = !canProceed;
        nextBtn.className = `py-3 px-6 rounded-xl font-semibold ${canProceed ? 'btn-primary' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`;
      }
      if (warning) {
        warning.textContent = '';
      }
    }

    function clearInitials(sectionId) {
      if (initialsPads[sectionId]) {
        initialsPads[sectionId].clear();
        state.sections[sectionId].initialed = false;
        delete state.initialsData[sectionId];
        updateNavigationState();
      }
    }

    function updateCustomer(field, value) {
      state.customer[field] = value;
      // Update input border color
      const input = document.getElementById('customer' + field.charAt(0).toUpperCase() + field.slice(1));
      if (input) {
        input.classList.remove('border-gray-300', 'border-[#05c3de]');
        input.classList.add(value ? 'border-[#05c3de]' : 'border-gray-300');
      }
    }

    function updateBoltUpField(field, value) {
      state.customer[field] = value;
    }

    function updateBoltUpSpec(field, value) {
      state.boltUpSpecs[field] = value;
    }

    function updateOwnerName(value) {
      state.ownerTypedName = value;
      const input = document.getElementById('ownerTypedNameInput');
      if (input) {
        input.classList.remove('border-gray-300', 'border-[#05c3de]');
        input.classList.add(value ? 'border-[#05c3de]' : 'border-gray-300');
      }
    }

    function updateContractorName(value) {
      state.contractorTypedName = value;
      const input = document.getElementById('contractorTypedNameInput');
      if (input) {
        input.classList.remove('border-gray-300', 'border-[#05c3de]');
        input.classList.add(value ? 'border-[#05c3de]' : 'border-gray-300');
      }
    }

    function selectPaymentMethod(method) {
      // Save signature data before re-render
      saveSignatureData();
      state.paymentMethod = method;
      render();
      setTimeout(() => {
        initSignaturePads();
        restoreSignatureData();
      }, 100);
    }

    function saveSignatureData() {
      // Save owner signature
      const ownerCanvas = document.getElementById('ownerSigPad');
      if (ownerCanvas && window.ownerPad && !window.ownerPad.isEmpty()) {
        state.ownerSigData = ownerCanvas.toDataURL('image/png');
      }
      // Save contractor signature
      const contractorCanvas = document.getElementById('contractorSigPad');
      if (contractorCanvas && window.contractorPad && !window.contractorPad.isEmpty()) {
        state.contractorSigData = contractorCanvas.toDataURL('image/png');
      }
      // Save initials for all sections
      Object.keys(state.sections).forEach(sectionId => {
        const initialsCanvas = document.getElementById('initials_' + sectionId);
        if (initialsCanvas && initialsPads[sectionId] && !initialsPads[sectionId].isEmpty()) {
          state.initialsData[sectionId] = initialsCanvas.toDataURL('image/png');
        }
      });
    }

    function restoreSignatureData() {
      // Restore owner signature
      if (state.ownerSigData) {
        const ownerCanvas = document.getElementById('ownerSigPad');
        if (ownerCanvas) {
          const img = new Image();
          img.onload = () => {
            const ctx = ownerCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            ownerCanvas.classList.add('signed');
          };
          img.src = state.ownerSigData;
        }
      }
      // Restore contractor signature
      if (state.contractorSigData) {
        const contractorCanvas = document.getElementById('contractorSigPad');
        if (contractorCanvas) {
          const img = new Image();
          img.onload = () => {
            const ctx = contractorCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            contractorCanvas.classList.add('signed');
          };
          img.src = state.contractorSigData;
        }
      }
      // Restore initials for all sections
      Object.keys(state.initialsData).forEach(sectionId => {
        const initialsCanvas = document.getElementById('initials_' + sectionId);
        if (initialsCanvas && state.initialsData[sectionId]) {
          const img = new Image();
          img.onload = () => {
            const ctx = initialsCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            initialsCanvas.classList.add('signed');
          };
          img.src = state.initialsData[sectionId];
        }
      });
    }

    function initSignaturePads() {
      // Owner signature - always reinitialize since canvas may be recreated
      const ownerCanvas = document.getElementById('ownerSigPad');
      if (ownerCanvas) {
        // Check if this is a new canvas element (different from what ownerPad was attached to)
        if (!window.ownerPad || window.ownerPad.canvas !== ownerCanvas) {
          window.ownerPad = new SignaturePad(ownerCanvas, (signed) => {
            state.ownerSigned = signed;
            if (signed) {
              state.ownerSigData = ownerCanvas.toDataURL('image/png');
            }
            ownerCanvas.classList.toggle('signed', signed);
          });
        }
      }

      // Contractor signature - always reinitialize since canvas may be recreated
      const contractorCanvas = document.getElementById('contractorSigPad');
      if (contractorCanvas) {
        if (!window.contractorPad || window.contractorPad.canvas !== contractorCanvas) {
          window.contractorPad = new SignaturePad(contractorCanvas, (signed) => {
            state.contractorSigned = signed;
            if (signed) {
              state.contractorSigData = contractorCanvas.toDataURL('image/png');
            }
            contractorCanvas.classList.toggle('signed', signed);
          });
        }
      }

      // Initialize initials pads for current section
      const section = CONTRACT_SECTIONS[state.contractStep];
      if (section && section.requiresAck) {
        const initialsCanvas = document.getElementById('initials_' + section.id);
        if (initialsCanvas) {
          if (!initialsPads[section.id] || initialsPads[section.id].canvas !== initialsCanvas) {
            initialsPads[section.id] = new SignaturePad(initialsCanvas, (signed) => {
              state.sections[section.id].initialed = signed;
              if (signed) {
                state.initialsData[section.id] = initialsCanvas.toDataURL('image/png');
              }
              initialsCanvas.classList.toggle('signed', signed);
              updateNavigationState();
            }, true);
          }
        }
      }
    }

    function clearOwnerSignature() {
      if (window.ownerPad) {
        window.ownerPad.clear();
        state.ownerSigned = false;
        state.ownerSigData = null;
      }
    }

    function clearContractorSignature() {
      if (window.contractorPad) {
        window.contractorPad.clear();
        state.contractorSigned = false;
        state.contractorSigData = null;
      }
    }

    function submitBoltUpQuote() {
      if (!state.customer.name || !state.customer.phone || !state.customer.email) {
        alert('Please fill in your name, phone, and email.');
        return;
      }

      const subject = encodeURIComponent('Bolt-Up Building Quote Request');
      const body = encodeURIComponent(`
BOLT-UP BUILDING QUOTE REQUEST
==============================

Contact Information:
- Name: ${state.customer.name}
- Phone: ${state.customer.phone}
- Email: ${state.customer.email}

Building Specifications:
- Desired Size: ${state.boltUpSpecs.customSize || 'Not specified'}
- Desired Eave Height: ${state.boltUpSpecs.customEave || 'Not specified'}

Door Preferences:
${state.boltUpSpecs.doorPrefs || 'Not specified'}

Add-On Preferences:
${state.boltUpSpecs.addOnPrefs || 'Not specified'}

Special Requirements/Notes:
${state.boltUpSpecs.specialReqs || 'None'}

---
Submitted via Gryphon FrameWorks Estimator
      `);

      window.location.href = `mailto:contracts@gryphonframeworks.com?subject=${subject}&body=${body}`;

      alert('Your quote request is ready to send! Your email client should open with the details.');
    }

    function sendContract() {
      // Validate signatures
      if (!state.ownerTypedName || !state.ownerSigned) {
        alert('Owner must print their name and sign.');
        return;
      }
      if (!state.contractorTypedName || !state.contractorSigned) {
        alert('Contractor must print their name and sign.');
        return;
      }
      if (!state.paymentMethod) {
        alert('Please select a payment method.');
        return;
      }

      state.sending = true;
      render();
      setTimeout(initSignaturePads, 100);

      // Build contract summary for all buildings
      const total = calculateTotal();
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Build buildings summary text
      let buildingsSummary = '';
      state.buildings.forEach((building, index) => {
        const type = BUILDING_TYPES[building.buildingType];
        const size = BUILDING_SIZES.find(s => s.id === building.buildingSize);
        const eave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
        const qty = building.qty || 1;
        const unitPrice = getBuildingUnitPrice(building);
        const buildingTotal = calculateBuildingTotal(building);
        buildingsSummary += `
BUILDING CONFIG ${index + 1} (Qty: ${qty}):
- Type: ${type.name}
- Size: ${size.label}
- Eave Height: ${eave.label}
- Unit Price: ${formatCurrency(unitPrice)}
- Subtotal: ${formatCurrency(buildingTotal)}${qty > 1 ? ` (${qty} × ${formatCurrency(unitPrice)})` : ''}
`;
      });

      const firstBuilding = state.buildings[0];
      const firstType = BUILDING_TYPES[firstBuilding.buildingType];
      const firstSize = BUILDING_SIZES.find(s => s.id === firstBuilding.buildingSize);

      const subject = encodeURIComponent(`Gryphon FrameWorks Contract - ${state.customer.name} - ${totalBuildingQty} Building${totalBuildingQty !== 1 ? 's' : ''}`);
      const body = encodeURIComponent(`
BURNETT CUSTOMS - EXECUTED CONTRACT
====================================

ORDER SUMMARY:
- Total Buildings: ${totalBuildingQty} (${configCount} configuration${configCount !== 1 ? 's' : ''})
- Contract Sum: ${formatCurrency(total)}
${buildingsSummary}
OWNER INFORMATION:
- Name: ${state.customer.name}
- Phone: ${state.customer.phone}
- Email: ${state.customer.email}
- Mailing Address: ${state.customer.address1}${state.customer.address2 ? ', ' + state.customer.address2 : ''}, ${state.customer.city}, ${state.customer.state} ${state.customer.zip}
- Property Address: ${state.customer.propertySameAsMailing ? 'Same as mailing address' : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '') + ', ' + state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip}

PAYMENT:
- Method: ${state.paymentMethod}
- First Draw Due: ${formatCurrency(Math.round(total * 0.30))} (30%)

SIGNATURES:
- Owner: ${state.ownerTypedName} (Signed digitally)
- Contractor: ${state.contractorTypedName} (Signed digitally)
- Date: ${new Date().toLocaleDateString()}

All 6 contract sections were acknowledged with checkbox and initials by the Owner.

---
This contract was executed digitally via Gryphon FrameWorks Estimator.
Gryphon FrameWorks, LLC
      `);

      // Open emails
      const contractorLink = `mailto:contracts@gryphonframeworks.com?subject=${subject}&body=${body}`;
      const customerLink = `mailto:${state.customer.email}?subject=${subject}&body=${body}`;

      window.open(contractorLink, '_blank');
      setTimeout(() => {
        window.open(customerLink, '_blank');
      }, 500);

      state.sent = true;
      state.sending = false;
      render();
      setTimeout(initSignaturePads, 100);

      alert('Your email client should open with the contract details. Please send both emails to complete the process.\n\nEmails to:\n• ' + state.customer.email + '\n• contracts@gryphonframeworks.com');
    }

    // Print full contract
    function printContract() {
      const total = calculateTotal();
      const today = new Date().toLocaleDateString();
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Get initials data URLs
      const initialsData = {};
      ['projectOverview', 'paymentTerms', 'timeline', 'responsibilities', 'warranties', 'legalProvisions'].forEach(sectionId => {
        const canvas = document.getElementById('initials_' + sectionId);
        if (canvas) {
          initialsData[sectionId] = canvas.toDataURL('image/png');
        }
      });

      // Get signature data URLs
      const ownerSigCanvas = document.getElementById('ownerSigPad');
      const contractorSigCanvas = document.getElementById('contractorSigPad');
      const ownerSigData = ownerSigCanvas ? ownerSigCanvas.toDataURL('image/png') : '';
      const contractorSigData = contractorSigCanvas ? contractorSigCanvas.toDataURL('image/png') : '';

      // Build print HTML
      const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Gryphon FrameWorks Contract - ${state.customer.name}</title>
          <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1f2937; line-height: 1.5; }
            .container { max-width: 800px; margin: 0 auto; padding: 30px; }
            .header { text-align: center; border-bottom: 3px solid #003057; padding-bottom: 20px; margin-bottom: 25px; }
            .header h1 { font-size: 28px; color: #003057; margin-bottom: 5px; }
            .header p { font-size: 12px; color: #6b7280; }
            .summary-box { background: #f9fafb; border: 2px solid #003057; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
            .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .summary-item { font-size: 12px; }
            .summary-item strong { display: block; color: #003057; margin-bottom: 2px; }
            .section { page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; }
            .section h3 { font-size: 14px; color: #003057; border-bottom: 2px solid #05c3de; padding-bottom: 6px; margin-bottom: 12px; }
            .section p, .section li { font-size: 10px; line-height: 1.6; margin-bottom: 6px; color: #374151; }
            .section ul { margin-left: 20px; }
            .ack-line { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 10px; border-top: 1px dashed #9ca3af; font-size: 10px; }
            .initials-img { height: 35px; border: 1px solid #000; background: #fff; }
            .signature-page { page-break-before: always; margin-top: 30px; }
            .sig-section { margin-bottom: 30px; }
            .sig-section h4 { font-size: 14px; color: #003057; margin-bottom: 10px; }
            .sig-box { border: 1px solid #000; padding: 10px; margin-bottom: 5px; min-height: 70px; display: flex; align-items: center; justify-content: center; }
            .sig-img { max-height: 60px; max-width: 100%; }
            .sig-details { font-size: 10px; color: #6b7280; }
            .final-section { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; text-align: center; margin-top: 30px; }
            @media print {
              .section { page-break-inside: avoid; }
              .signature-page { page-break-before: always; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <svg viewBox="0 0 100 100" style="width: 60px; height: 60px; margin: 0 auto 10px;">
                <polygon points="50,2 93,27 93,73 50,98 7,73 7,27" fill="#003057" stroke="#003057" stroke-width="2"/>
                <polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#05c3de"/>
                <text x="30" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">B</text>
                <text x="52" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">C</text>
              </svg>
              <h1>BURNETT CUSTOMS</h1>
              <p>Metal Building Construction Agreement</p>
              <p>Contract Date: ${today}</p>
            </div>

            <div class="summary-box">
              <div class="summary-grid">
                <div class="summary-item">
                  <strong>Total Buildings</strong>
                  ${totalBuildingQty} (${configCount} config${configCount !== 1 ? 's' : ''})
                </div>
                <div class="summary-item">
                  <strong>Contract Sum</strong>
                  ${formatCurrency(total)}
                </div>
                <div class="summary-item">
                  <strong>Owner</strong>
                  ${state.customer.name}<br>
                  ${state.customer.phone} | ${state.customer.email}
                </div>
                <div class="summary-item">
                  <strong>Property Address</strong>
                  ${state.customer.propertySameAsMailing
                    ? state.customer.address1 + (state.customer.address2 ? ', ' + state.customer.address2 : '') + '<br>' + state.customer.city + ', ' + state.customer.state + ' ' + state.customer.zip
                    : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '') + '<br>' + state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip
                  }
                </div>
              </div>
              <!-- Buildings List -->
              ${state.buildings.map((building, index) => {
                const bType = BUILDING_TYPES[building.buildingType];
                const bSize = BUILDING_SIZES.find(s => s.id === building.buildingSize);
                const bEave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
                const bQty = building.qty || 1;
                const bUnitPrice = getBuildingUnitPrice(building);
                const bTotal = calculateBuildingTotal(building);
                return '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;"><strong style="color: #003057;">Building Config ' + (index + 1) + ' (Qty: ' + bQty + '):</strong> ' + bType.name + ' - ' + bSize.label + ' × ' + bEave.label + ' <span style="float: right;">' + formatCurrency(bTotal) + (bQty > 1 ? ' (' + bQty + ' × ' + formatCurrency(bUnitPrice) + ')' : '') + '</span></div>';
              }).join('')}
            </div>

            <!-- Section 1: Project Overview -->
            <div class="section">
              <h3>1. Project Overview</h3>
              <p><strong>Scope of Work:</strong> Contractor shall furnish all labor, materials, equipment, and services necessary to construct ${totalBuildingQty} metal building${totalBuildingQty !== 1 ? 's' : ''} at the property address specified above, in accordance with the specifications selected by Owner in this Contract.</p>
              <p><strong>Building Specifications:</strong> See building list above. Final specifications subject to engineering approval.</p>
              <p><strong>Contract Sum:</strong> ${formatCurrency(total)} - This is the total amount payable by Owner to Contractor for the complete and satisfactory performance of the Work described herein.</p>
              <div class="ack-line">
                <span>✓ Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.projectOverview || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 2: Payment Terms -->
            <div class="section">
              <h3>2. Payment Terms</h3>
              <p><strong>Payment Schedule:</strong></p>
              <ul>
                <li><strong>First Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon contract signing</li>
                <li><strong>Second Draw (40%):</strong> ${formatCurrency(Math.round(total * 0.40))} - Due when materials arrive on site</li>
                <li><strong>Final Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon substantial completion</li>
              </ul>
              <p><strong>Late Payment:</strong> Payments not received within 10 days of due date shall accrue interest at 1.5% per month.</p>
              <p><strong>Selected Payment Method:</strong> ${state.paymentMethod ? state.paymentMethod.charAt(0).toUpperCase() + state.paymentMethod.slice(1) : 'Not selected'}</p>
              <div class="ack-line">
                <span>✓ Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.paymentTerms || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 3: Timeline & Changes -->
            <div class="section">
              <h3>3. Timeline & Changes</h3>
              <p><strong>Project Timeline:</strong> Work shall commence within 30 days of receiving first payment and building permits. Estimated completion is 4-8 weeks from commencement, weather permitting.</p>
              <p><strong>Change Orders:</strong> Any modifications to the scope of work must be documented in writing and signed by both parties. Change orders may affect the Contract Sum and timeline.</p>
              <p><strong>Weather Delays:</strong> Contractor shall not be liable for delays caused by weather conditions, material shortages, or other circumstances beyond reasonable control.</p>
              <div class="ack-line">
                <span>✓ Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.timeline || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 4: Responsibilities -->
            <div class="section">
              <h3>4. Responsibilities</h3>
              <p><strong>Contractor Responsibilities:</strong></p>
              <ul>
                <li>Provide all labor, materials, and equipment for metal building construction</li>
                <li>Obtain necessary building permits</li>
                <li>Maintain adequate insurance coverage</li>
                <li>Complete work in a professional, workmanlike manner</li>
              </ul>
              <p><strong>Owner Responsibilities:</strong></p>
              <ul>
                <li>Provide clear access to the construction site</li>
                <li>Ensure site is level and properly graded (unless concrete work is included)</li>
                <li>Make timely payments per the payment schedule</li>
                <li>Obtain any required easements or property approvals</li>
              </ul>
              <div class="ack-line">
                <span>✓ Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.responsibilities || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 5: Warranties & Insurance -->
            <div class="section">
              <h3>5. Warranties & Insurance</h3>
              <p><strong>Workmanship Warranty:</strong> Contractor warrants all workmanship for a period of one (1) year from substantial completion.</p>
              <p><strong>Manufacturer Warranties:</strong> All manufacturer warranties on materials and components shall transfer to Owner.</p>
              <p><strong>Insurance:</strong> Contractor maintains general liability insurance and workers' compensation coverage. Owner is responsible for property insurance on the structure once construction begins.</p>
              <p><strong>Limitation:</strong> Warranties do not cover damage from acts of nature, misuse, or failure to maintain the structure properly.</p>
              <div class="ack-line">
                <span>✓ Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.warranties || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Section 6: Legal Provisions -->
            <div class="section">
              <h3>6. Legal Provisions</h3>
              <p><strong>Governing Law:</strong> This Contract shall be governed by the laws of the State of Texas.</p>
              <p><strong>Dispute Resolution:</strong> Any disputes shall first be addressed through good-faith negotiation. If unresolved, disputes shall be settled through binding arbitration in the county where the project is located.</p>
              <p><strong>Entire Agreement:</strong> This Contract constitutes the entire agreement between parties and supersedes all prior negotiations and agreements.</p>
              <p><strong>Severability:</strong> If any provision is found invalid, the remaining provisions shall continue in full force.</p>
              <div class="ack-line">
                <span>✓ Owner acknowledges reading and understanding this section</span>
                <span>Initials: <img src="${initialsData.legalProvisions || ''}" class="initials-img" alt="Initials"></span>
              </div>
            </div>

            <!-- Signature Page -->
            <div class="signature-page">
              <h3 style="text-align: center; font-size: 18px; color: #003057; margin-bottom: 20px;">7. Final Acknowledgment & Signatures</h3>

              <p style="text-align: center; font-size: 11px; margin-bottom: 20px; color: #374151;">
                By signing below, both parties acknowledge that they have read and understand ALL sections of this Contract,
                have had the opportunity to consult with an attorney, agree to be bound by the terms and conditions herein,
                and that the Contractor has personally walked the Owner through every section.
              </p>

              <div class="sig-section">
                <h4>Owner Signature</h4>
                <div class="sig-box">
                  ${ownerSigData ? `<img src="${ownerSigData}" class="sig-img" alt="Owner Signature">` : '<span style="color: #9ca3af;">Signature</span>'}
                </div>
                <div class="sig-details">
                  <p><strong>Printed Name:</strong> ${state.ownerTypedName || '_______________________'}</p>
                  <p><strong>Date:</strong> ${today}</p>
                </div>
              </div>

              <div class="sig-section">
                <h4>Contractor Signature</h4>
                <div class="sig-box">
                  ${contractorSigData ? `<img src="${contractorSigData}" class="sig-img" alt="Contractor Signature">` : '<span style="color: #9ca3af;">Signature</span>'}
                </div>
                <div class="sig-details">
                  <p><strong>Printed Name:</strong> ${state.contractorTypedName || '_______________________'}</p>
                  <p><strong>Company:</strong> Gryphon FrameWorks, LLC</p>
                  <p><strong>Date:</strong> ${today}</p>
                </div>
              </div>

              <div class="final-section">
                <p style="font-size: 14px; font-weight: bold; color: #166534;">${ICON_CHECK_CIRCLE} Contract Executed</p>
                <p style="font-size: 11px; color: #166534;">This contract was signed digitally via Gryphon FrameWorks Estimator on ${today}.</p>
              </div>
            </div>
          </div>
        </body>
        </html>
      `;

      // Open print window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printHTML);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }

    // Download full contract as HTML file
    function downloadContract() {
      const total = calculateTotal();
      const today = new Date().toLocaleDateString();
      const totalBuildingQty = state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0);
      const configCount = state.buildings.length;

      // Get initials data URLs
      const initialsData = {};
      ['projectOverview', 'paymentTerms', 'timeline', 'responsibilities', 'warranties', 'legalProvisions'].forEach(sectionId => {
        if (state.initialsData[sectionId]) {
          initialsData[sectionId] = state.initialsData[sectionId];
        } else {
          const canvas = document.getElementById('initials_' + sectionId);
          if (canvas) {
            initialsData[sectionId] = canvas.toDataURL('image/png');
          }
        }
      });

      // Get signature data
      const ownerSigData = state.ownerSigData || '';
      const contractorSigData = state.contractorSigData || '';

      // Build buildings list HTML
      const buildingsListHTML = state.buildings.map((building, index) => {
        const bType = BUILDING_TYPES[building.buildingType];
        const bSize = BUILDING_SIZES.find(s => s.id === building.buildingSize);
        const bEave = EAVE_HEIGHTS.find(e => e.id === building.eaveHeight);
        const bQty = building.qty || 1;
        const bUnitPrice = getBuildingUnitPrice(building);
        const bTotal = calculateBuildingTotal(building);
        return '<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e5e7eb;font-size:11px;"><strong style="color:#003057;">Building Config ' + (index + 1) + ' (Qty: ' + bQty + '):</strong> ' + bType.name + ' - ' + bSize.label + ' × ' + bEave.label + ' <span style="float:right;">' + formatCurrency(bTotal) + (bQty > 1 ? ' (' + bQty + ' × ' + formatCurrency(bUnitPrice) + ')' : '') + '</span></div>';
      }).join('');

      // Build contract HTML (same as print but self-contained)
      const contractHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Gryphon FrameWorks Contract - ${state.customer.name} - ${today.replace(/\\//g, '-')}</title>
          <style>
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1f2937; line-height: 1.5; }
            .container { max-width: 800px; margin: 0 auto; padding: 30px; }
            .header { text-align: center; border-bottom: 3px solid #003057; padding-bottom: 20px; margin-bottom: 25px; }
            .header h1 { font-size: 28px; color: #003057; margin-bottom: 5px; }
            .header p { font-size: 12px; color: #6b7280; }
            .summary-box { background: #f9fafb; border: 2px solid #003057; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
            .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .summary-item { font-size: 12px; }
            .summary-item strong { display: block; color: #003057; margin-bottom: 2px; }
            .section { margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; page-break-inside: avoid; }
            .section h3 { font-size: 14px; color: #003057; border-bottom: 2px solid #05c3de; padding-bottom: 6px; margin-bottom: 12px; }
            .section p, .section li { font-size: 10px; line-height: 1.6; margin-bottom: 6px; color: #374151; }
            .section ul { margin-left: 20px; }
            .ack-line { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 10px; border-top: 1px dashed #9ca3af; font-size: 10px; }
            .initials-img { height: 35px; border: 1px solid #000; background: #fff; }
            .signature-page { margin-top: 30px; page-break-before: always; }
            .sig-section { margin-bottom: 30px; }
            .sig-section h4 { font-size: 14px; color: #003057; margin-bottom: 10px; }
            .sig-box { border: 1px solid #000; padding: 10px; margin-bottom: 5px; min-height: 70px; display: flex; align-items: center; justify-content: center; }
            .sig-img { max-height: 60px; max-width: 100%; }
            .sig-details { font-size: 10px; color: #6b7280; }
            .final-section { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 8px; padding: 20px; text-align: center; margin-top: 30px; }
            @media print { .section { page-break-inside: avoid; } .signature-page { page-break-before: always; } }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <svg viewBox="0 0 100 100" style="width: 60px; height: 60px; margin: 0 auto 10px;">
                <polygon points="50,2 93,27 93,73 50,98 7,73 7,27" fill="#003057" stroke="#003057" stroke-width="2"/>
                <polygon points="50,10 85,30 85,70 50,90 15,70 15,30" fill="#05c3de"/>
                <text x="30" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">B</text>
                <text x="52" y="62" font-family="Arial Black, sans-serif" font-size="32" font-weight="900" fill="#003057">C</text>
              </svg>
              <h1>BURNETT CUSTOMS</h1>
              <p>Metal Building Construction Agreement</p>
              <p>Contract Date: ${today}</p>
            </div>

            <div class="summary-box">
              <div class="summary-grid">
                <div class="summary-item"><strong>Total Buildings</strong>${totalBuildingQty} (${configCount} config${configCount !== 1 ? 's' : ''})</div>
                <div class="summary-item"><strong>Contract Sum</strong>${formatCurrency(total)}</div>
                <div class="summary-item"><strong>Owner</strong>${state.customer.name}<br>${state.customer.phone} | ${state.customer.email}</div>
                <div class="summary-item"><strong>Property Address</strong>${state.customer.propertySameAsMailing ? state.customer.address1 + (state.customer.address2 ? ', ' + state.customer.address2 : '') + '<br>' + state.customer.city + ', ' + state.customer.state + ' ' + state.customer.zip : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '') + '<br>' + state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip}</div>
              </div>
              ${buildingsListHTML}
            </div>

            <div class="section"><h3>1. Project Overview</h3><p><strong>Scope of Work:</strong> Contractor shall furnish all labor, materials, equipment, and services necessary to construct ${totalBuildingQty} metal building${totalBuildingQty !== 1 ? 's' : ''} at the property address specified above.</p><p><strong>Building Specifications:</strong> See building list above. Final specifications subject to engineering approval.</p><p><strong>Contract Sum:</strong> ${formatCurrency(total)}</p><div class="ack-line"><span>✓ Owner acknowledges this section</span><span>Initials: <img src="${initialsData.projectOverview || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>2. Payment Terms</h3><p><strong>First Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon signing</p><p><strong>Second Draw (40%):</strong> ${formatCurrency(Math.round(total * 0.40))} - Due when materials arrive</p><p><strong>Final Draw (30%):</strong> ${formatCurrency(Math.round(total * 0.30))} - Due upon completion</p><p><strong>Payment Method:</strong> ${state.paymentMethod ? state.paymentMethod.charAt(0).toUpperCase() + state.paymentMethod.slice(1) : 'Not selected'}</p><div class="ack-line"><span>✓ Owner acknowledges this section</span><span>Initials: <img src="${initialsData.paymentTerms || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>3. Timeline & Changes</h3><p>Work shall commence within 30 days of first payment and permits. Estimated 4-8 weeks, weather permitting. Change orders must be in writing and signed by both parties.</p><div class="ack-line"><span>✓ Owner acknowledges this section</span><span>Initials: <img src="${initialsData.timeline || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>4. Responsibilities</h3><p><strong>Contractor:</strong> Provide labor, materials, permits, insurance, professional work.</p><p><strong>Owner:</strong> Provide site access, level/graded site, timely payments, easements.</p><div class="ack-line"><span>✓ Owner acknowledges this section</span><span>Initials: <img src="${initialsData.responsibilities || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>5. Warranties & Insurance</h3><p>1-year workmanship warranty. Manufacturer warranties transfer to Owner. Contractor maintains liability and workers' comp insurance.</p><div class="ack-line"><span>✓ Owner acknowledges this section</span><span>Initials: <img src="${initialsData.warranties || ''}" class="initials-img"></span></div></div>

            <div class="section"><h3>6. Legal Provisions</h3><p>Governed by Texas law. Disputes via negotiation then binding arbitration. This is the entire agreement.</p><div class="ack-line"><span>✓ Owner acknowledges this section</span><span>Initials: <img src="${initialsData.legalProvisions || ''}" class="initials-img"></span></div></div>

            <div class="signature-page">
              <h3 style="text-align:center;font-size:18px;color:#003057;margin-bottom:20px;">7. Final Acknowledgment & Signatures</h3>
              <p style="text-align:center;font-size:11px;margin-bottom:20px;">By signing below, both parties acknowledge they have read, understand, and agree to ALL terms.</p>
              <div class="sig-section"><h4>Owner Signature</h4><div class="sig-box">${ownerSigData ? '<img src="' + ownerSigData + '" class="sig-img">' : ''}</div><div class="sig-details"><p><strong>Printed Name:</strong> ${state.ownerTypedName}</p><p><strong>Date:</strong> ${today}</p></div></div>
              <div class="sig-section"><h4>Contractor Signature</h4><div class="sig-box">${contractorSigData ? '<img src="' + contractorSigData + '" class="sig-img">' : ''}</div><div class="sig-details"><p><strong>Printed Name:</strong> ${state.contractorTypedName}</p><p><strong>Company:</strong> Gryphon FrameWorks, LLC</p><p><strong>Date:</strong> ${today}</p></div></div>
              <div class="final-section"><p style="font-size:14px;font-weight:bold;color:#166534;">${ICON_CHECK_CIRCLE} Contract Executed</p><p style="font-size:11px;color:#166534;">Signed digitally on ${today}</p></div>
            </div>
          </div>
        </body>
        </html>
      `;

      // Create download link
      const blob = new Blob([contractHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Gryphon_Contract_' + state.customer.name.replace(/\\s+/g, '_') + '_' + today.replace(/\\//g, '-') + '.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Download Bill of Materials / Purchase Order as XLSX
    function downloadBOM() {
      const today = new Date().toLocaleDateString();
      const poNumber = 'PO-' + Date.now().toString().slice(-8);

      // Generate BOM for all buildings
      const allBOMs = state.buildings.map((building, index) => generateBOM(building, index));

      // Create workbook
      const wb = XLSX.utils.book_new();

      // ===== SUMMARY SHEET =====
      const summaryData = [
        ['BURNETT CUSTOMS - BILL OF MATERIALS'],
        ['Metal Building Construction'],
        [''],
        ['PO Number:', poNumber],
        ['Date:', today],
        [''],
        ['CUSTOMER INFORMATION'],
        ['Customer Name:', state.customer.name],
        ['Phone:', state.customer.phone],
        ['Email:', state.customer.email],
        ['Job Site Address:', state.customer.propertySameAsMailing
          ? state.customer.address1 + (state.customer.address2 ? ', ' + state.customer.address2 : '')
          : state.customer.propertyAddress1 + (state.customer.propertyAddress2 ? ', ' + state.customer.propertyAddress2 : '')],
        ['City/State/Zip:', state.customer.propertySameAsMailing
          ? state.customer.city + ', ' + state.customer.state + ' ' + state.customer.zip
          : state.customer.propertyCity + ', ' + state.customer.propertyState + ' ' + state.customer.propertyZip],
        [''],
        ['ORDER SUMMARY'],
        ['Total Buildings:', state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0)],
        ['Configurations:', state.buildings.length],
        ['Contract Sum:', formatCurrency(calculateTotal())],
        ['Payment Method:', state.paymentMethod ? state.paymentMethod.charAt(0).toUpperCase() + state.paymentMethod.slice(1) : 'TBD'],
        [''],
        ['BUILDING CONFIGURATIONS']
      ];

      // Add building summaries
      allBOMs.forEach((bom, idx) => {
        summaryData.push([`Building ${idx + 1}:`, `${bom.type.name} - ${bom.size.label} × ${bom.eave.label}`, `Qty: ${bom.qty}`]);
      });

      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
      summarySheet['!cols'] = [{ wch: 20 }, { wch: 50 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

      // ===== MATERIALS SHEET (Consolidated BOM for Distributors) =====
      const materialsData = [
        ['BILL OF MATERIALS - DISTRIBUTOR ORDER FORM'],
        ['PO#: ' + poNumber, 'Customer: ' + state.customer.name, 'Date: ' + today],
        [''],
        ['Line', 'Section', 'Item Description', 'Qty Per Unit', 'Building Qty', 'Total Qty', 'Unit', 'Notes', 'Building']
      ];

      let lineNum = 1;
      allBOMs.forEach((bom, bIndex) => {
        bom.materials.forEach(section => {
          section.items.forEach(item => {
            materialsData.push([
              lineNum++,
              section.section,
              item.item,
              item.qty,
              bom.qty,
              item.qty * bom.qty,
              item.unit,
              item.notes,
              `Bldg ${bIndex + 1}: ${bom.type.name}`
            ]);
          });
        });
      });

      // Add totals row
      materialsData.push(['']);
      materialsData.push(['', '', 'TOTAL LINE ITEMS:', lineNum - 1, '', '', '', '', '']);

      const materialsSheet = XLSX.utils.aoa_to_sheet(materialsData);
      materialsSheet['!cols'] = [
        { wch: 6 },   // Line
        { wch: 22 },  // Section
        { wch: 40 },  // Item Description
        { wch: 12 },  // Qty Per Unit
        { wch: 12 },  // Building Qty
        { wch: 12 },  // Total Qty
        { wch: 8 },   // Unit
        { wch: 25 },  // Notes
        { wch: 25 }   // Building
      ];
      XLSX.utils.book_append_sheet(wb, materialsSheet, 'Materials');

      // ===== INDIVIDUAL BUILDING SHEETS =====
      allBOMs.forEach((bom, bIndex) => {
        const buildingData = [
          [`BUILDING ${bIndex + 1}: ${bom.type.name}`],
          [`Size: ${bom.size.label}`, `Eave Height: ${bom.eave.label}`, `Quantity: ${bom.qty}`],
          [''],
          ['Line', 'Section', 'Item Description', 'Qty (per bldg)', 'Total Qty', 'Unit', 'Notes']
        ];

        bom.materials.forEach(section => {
          section.items.forEach(item => {
            buildingData.push([
              item.line,
              section.section,
              item.item,
              item.qty,
              item.qty * bom.qty,
              item.unit,
              item.notes
            ]);
          });
        });

        const buildingSheet = XLSX.utils.aoa_to_sheet(buildingData);
        buildingSheet['!cols'] = [
          { wch: 6 },   // Line
          { wch: 22 },  // Section
          { wch: 40 },  // Item Description
          { wch: 14 },  // Qty (per bldg)
          { wch: 12 },  // Total Qty
          { wch: 8 },   // Unit
          { wch: 30 }   // Notes
        ];
        const sheetName = `Bldg ${bIndex + 1} - ${bom.type.name.substring(0, 15)}`;
        XLSX.utils.book_append_sheet(wb, buildingSheet, sheetName);
      });

      // ===== CATEGORY TOTALS SHEET (Aggregated by material type) =====
      const categoryMap = {};
      allBOMs.forEach(bom => {
        bom.materials.forEach(section => {
          section.items.forEach(item => {
            const key = `${section.section}|${item.item}|${item.unit}`;
            if (!categoryMap[key]) {
              categoryMap[key] = { section: section.section, item: item.item, unit: item.unit, qty: 0 };
            }
            categoryMap[key].qty += item.qty * bom.qty;
          });
        });
      });

      const categoryData = [
        ['AGGREGATED MATERIALS - ALL BUILDINGS'],
        ['PO#: ' + poNumber, 'Total Buildings: ' + state.buildings.reduce((sum, b) => sum + (b.qty || 1), 0)],
        [''],
        ['Section', 'Item Description', 'Total Qty', 'Unit']
      ];

      let currentSection = '';
      Object.values(categoryMap).sort((a, b) => a.section.localeCompare(b.section)).forEach(item => {
        if (item.section !== currentSection) {
          currentSection = item.section;
        }
        categoryData.push([item.section, item.item, item.qty, item.unit]);
      });

      const categorySheet = XLSX.utils.aoa_to_sheet(categoryData);
      categorySheet['!cols'] = [{ wch: 25 }, { wch: 45 }, { wch: 12 }, { wch: 8 }];
      XLSX.utils.book_append_sheet(wb, categorySheet, 'Aggregated Totals');

      // Generate and download file
      const fileName = `Gryphon_BOM_${state.customer.name.replace(/\s+/g, '_')}_${poNumber}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    // Initialize initials pads when contract sections load
    function initCurrentSectionPads() {
      const section = CONTRACT_SECTIONS[state.contractStep];
      if (section && section.requiresAck) {
        setTimeout(() => {
          const initialsCanvas = document.getElementById('initials_' + section.id);
          if (initialsCanvas && !initialsPads[section.id]) {
            initialsPads[section.id] = new SignaturePad(initialsCanvas, (signed) => {
              state.sections[section.id].initialed = signed;
              initialsCanvas.classList.toggle('signed', signed);
              updateNavigationState();
            }, true);
          }
        }, 100);
      }
    }

    // Override render to initialize pads
    const originalRender = render;
    render = function() {
      originalRender();
      if (state.step >= 6) {
        initCurrentSectionPads();
        if (CONTRACT_SECTIONS[state.contractStep].id === 'signatures') {
          setTimeout(initSignaturePads, 100);
        }
      }
    };

    // Initial render
    render();
  </script>
</body>
</html>
